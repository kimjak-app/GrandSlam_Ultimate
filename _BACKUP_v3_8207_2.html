<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GrandSlam Ultimate v3.8207_2</title>
  <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icon.png">
  <link rel="shortcut icon" href="icon.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <style>
    
    :root { --bg-gray: #F2F2F7; --text-dark: #1C1C1E; --text-gray: #8E8E93; --wimbledon-sage: #5D9C76; --aussie-blue: #669DB3; --roland-clay: #D98C73; --up-red: #FF3B30; --down-blue: #007AFF; }

    body {
      font-family: 'Apple SD Gothic Neo', sans-serif;
      background: var(--bg-gray);
      margin: 0;
      padding: 0;
      padding-bottom: 120px; 
      font-weight: 400;
      -webkit-tap-highlight-color: transparent;
    }

    #splash { position: fixed; inset: 0; background: var(--wimbledon-sage); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 30000; gap: 20px; }
    #splash img { width: 140px; height: 140px; border-radius: 24px; transition: transform 0.7s ease, opacity 0.6s ease; }
    #splash.hide img { transform: scale(5); opacity: 0; }
    #splash .loading-text { color: white; font-size: 16px; font-weight: 400; opacity: 0.9; }


    
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: rgba(255,255,255,0.98); border-top: 1px solid #d1d1d6; display: flex !important; justify-content: space-around; align-items: center; z-index: 21000 !important; }
    .app-screen { padding-bottom: 100px; } /* Ensure content doesn't hide behind nav */

    .nav-item { flex: 1; text-align: center; color: #C7C7CC; font-size: 10px; font-weight: 400; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; transition: color 0.2s; }
    .nav-item.active { color: var(--wimbledon-sage); }
    .material-symbols-outlined { font-size: 28px; font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
    .btn-ico { font-size: 18px; vertical-align: middle; margin-right: 6px; }
    .title-ico { font-size: 18px; vertical-align: middle; margin-right: 6px; }

    .nav-item.active .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 300; }

    .app-screen { display: none; padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 120px;  }
    .app-screen.active { display: block; }

    .header-banner { background: var(--wimbledon-sage); color: white; margin: 0 0 20px 0; padding: 20px; text-align: center; border-radius: 16px; box-shadow: 0 4px 15px rgba(93, 156, 118, 0.3); display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 20px; font-weight: 400; letter-spacing: -0.5px; }
    .weather-card { border-radius: 24px; padding: 20px; background: #fff; box-shadow: 0 8px 30px rgba(0,0,0,0.08); margin-bottom: 20px; }

    .search-row { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; justify-content: space-between; width: 100%; }
    .w-input { width: 70%; padding: 14px; border: 1px solid #eee; border-radius: 12px; font-size: 16px; box-sizing: border-box; font-weight: 400; }
    .w-btn { flex: 1; padding: 15px 0; border: none; border-radius: 12px; color: #fff; font-weight: 400; cursor: pointer; font-size: 15px; transition: opacity 0.2s; white-space: nowrap; text-align: center; }
    #btnSearch { background: var(--wimbledon-sage); }

    .btn-row { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
    #btnRefresh, #btnNext { flex: 1; background: var(--roland-clay); color: white; opacity: 0.8; border: none; border-radius: 12px; font-weight: 400; cursor: pointer; font-size: 15px; padding: 15px 0; transition: all 0.2s; }
    #btnRefresh.active, #btnNext.active { background: var(--aussie-blue) !important; opacity: 1; box-shadow: 0 4px 10px rgba(102, 157, 179, 0.4); }

    .weather-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
    .weather-table th { color: var(--wimbledon-sage); border-bottom: 2px solid var(--wimbledon-sage); padding: 8px; text-align: center; font-weight: 400; background: rgba(93, 156, 118, 0.1); }
    .weather-table td { text-align: center; padding: 15px 2px; border-bottom: 1px solid #f0f0f0; font-weight: 400; color: var(--text-dark); }

    .tip-box { margin-top: 15px; padding: 15px; background: var(--roland-clay); color: white; font-weight: 400; border-radius: 16px; box-shadow: 0 4px 10px rgba(217, 140, 115, 0.3); }

    .tab-menu { display: flex; gap: 8px; margin-bottom: 20px; }
    .tab-btn { flex: 1; padding: 12px 0; border: none; font-size: 13px; font-weight: 400; cursor: pointer; border-radius: 12px; transition: all 0.2s; background: var(--roland-clay); color: white; opacity: 0.8; }
    .tab-btn.active { background: var(--aussie-blue) !important; color: white; opacity: 1; transform: scale(1.02); box-shadow: 0 2px 8px rgba(102, 157, 179, 0.4); }

    .section-card { background: white; padding: 20px; border-radius: 20px; min-height: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); display: none; margin-bottom: 20px; }
    .section-card.active { display: block; }

    .tennis-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; table-layout: fixed; }
    .tennis-table th { color: var(--wimbledon-sage); border-bottom: 2px solid var(--wimbledon-sage); padding: 8px; text-align: center; font-weight: 400; background: rgba(93, 156, 118, 0.1); }
    .tennis-table td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: center; font-weight: 400; color: var(--text-dark); overflow: hidden; text-overflow: ellipsis; }

    .point-text { color: var(--wimbledon-sage); font-weight: 400; font-size: 11px; }
    .sub-info { font-size: 10px; color: #8E8E93; font-weight: 400; }
    .sub-rank-title { font-size: 15px; font-weight: 400; color: var(--text-dark); margin: 30px 0 10px 0; display: flex; align-items: center; gap: 5px; }
    .sub-rank-title .material-symbols-outlined { font-size: 18px; color: var(--wimbledon-sage); }

    .type-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-weight: 400; cursor: pointer; margin-bottom: 15px; transition: all 0.2s; background: var(--roland-clay); color: white; opacity: 0.8; }
    .type-btn.selected { background: var(--aussie-blue); color: white; opacity: 1; box-shadow: 0 4px 10px rgba(102, 157, 179, 0.4); }

    .team-box { border: 2px solid #E5E5EA; border-radius: 15px; padding: 15px; text-align: center; background: white; margin-bottom: 10px; }
    #hN, #aN { color: var(--aussie-blue) !important; font-weight: 400; }

    .score-box { width: 70px; height: 55px; font-size: 26px; text-align: center; border-radius: 12px; border: 1px solid #D1D1D6; background: #F2F2F7; color: var(--text-dark); font-weight: 400; }

    .pool { display: block; padding: 15px; background: white; border: 2px solid #E5E5EA; border-radius: 15px; margin-top: 30px; }

    .btn-main {
      width: 100%;
      padding: 20px;
      background: var(--wimbledon-sage);
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 18px;
      font-weight: 400;
      margin-top: 15px;
      cursor: pointer;
      position: relative;        
      z-index: 5;                
      pointer-events: auto;      
      touch-action: manipulation;
    }
    .btn-sub { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 400; color: #fff; margin-top: 10px; font-size: 13px; cursor: pointer; }
    .btn-sub.sky { background: var(--aussie-blue); }
    .btn-sub.royal { background: var(--roland-clay); }
    .btn-sub.navy { background: #0C2340; }

    #loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); z-index:10000; justify-content:center; align-items:center; font-weight: 400; color:var(--wimbledon-sage); }

    .date-display{ display: none; width: 100%; margin: 0 0 15px 0; padding: 12px 14px; border-radius: 14px; background: #EAF4FF; border: 1px solid #D6E9FF;
      color: var(--aussie-blue); text-align: center; font-size: 16px; font-weight: 400; box-sizing: border-box; }

    .chart-btn { padding: 6px 14px; font-size: 12px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; color: #555; font-weight: 400; flex-shrink: 0; }
    .chart-btn.active { background: var(--wimbledon-sage); color: white; border-color: transparent; box-shadow: 0 2px 6px rgba(93, 156, 118, 0.3); }

    
    .tour-section-title { font-size: 16px; font-weight: 400; color: var(--text-dark) !important; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
    .tour-section-title .material-symbols-outlined { color: var(--wimbledon-sage) !important; font-size: 18px; }

    .player-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
    .p-chk { display: none; }
    .p-label { background: white; border: 2px solid #ddd; color: #888; padding: 8px 6px; border-radius: 10px; text-align: center; font-size: 13px; font-weight: 400; cursor: pointer; transition: 0.2s; }
    .guest-label { background:#f9f9f9; border-color:#ddd; color:#777; }

    .p-chk:checked + .p-label { background: var(--aussie-blue); color: white; border-color: var(--aussie-blue); box-shadow: 0 2px 6px rgba(102, 157, 179, 0.3); }
    .day-guest-label { background:#f9f9f9; border-color:#ddd; color:#777; }
    .p-chk:checked + .day-guest-label { background: var(--aussie-blue); color: white; border-color: var(--aussie-blue); box-shadow: 0 2px 6px rgba(102, 157, 179, 0.3); }
    .p-rank { font-size: 10px; opacity: 0.8; display: block; font-weight: 400; }

    .opt-row { display: flex; gap: 10px; margin-bottom: 20px; }
    .opt-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-size: 14px; font-weight: 400; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; color: white; opacity: 0.8; background: var(--roland-clay); }
    .opt-btn.active { background: var(--aussie-blue) !important; opacity: 1; box-shadow: 0 2px 8px rgba(102, 157, 179, 0.4); transform: scale(1.02); }

    #bracket-section { display: none; margin-top: 40px; border-top: 2px dashed #eee; padding-top: 40px; overflow-x: auto; }
    .bracket-title { text-align: center; font-size: 24px; font-weight: 400; color: var(--wimbledon-sage); margin-bottom: 30px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .bracket-title .material-symbols-outlined { font-size: 32px; color: var(--wimbledon-sage); font-variation-settings: 'FILL' 1; }

    .bracket-container { width: 100%; overflow-x: auto; display: flex; padding-bottom: 10px; }
    .bracket-tree { display: flex; justify-content: center; align-items: center; gap: 15px; padding: 10px; margin: 0 auto; min-width: max-content; }

    .column { display: flex; flex-direction: column; justify-content: space-around; height: 320px; width: 150px; }
    .col-center { justify-content: center; height: 320px; width: 240px; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }

    .match-box { background: white; border: 1px solid #ddd; border-radius: 12px; padding: 10px; width: 100%; box-sizing: border-box; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; z-index: 2; min-width: 140px; }
    .match-box.final-stage { min-height: 120px; border: 2px solid #eee; transform: scale(1.05); display: flex; flex-direction: column; justify-content: center; }

    .match-box::before, .match-box::after { display: none !important; }

    .champ-wrapper { text-align: center; margin-bottom: 25px; display: none; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 100%; }
    .champ-badge { background: white; border: 2px solid var(--wimbledon-sage); color: var(--wimbledon-sage); padding: 12px 15px; border-radius: 30px; font-weight: 400; font-size: 16px; box-shadow: 0 4px 15px rgba(93, 156, 118, 0.2); display: inline-flex; align-items: center; justify-content: center; gap: 8px; width: 100%; max-width: 240px; box-sizing: border-box; }

    .loser-bench { margin-top: 30px; padding: 15px; background: #fff; border-radius: 12px; border: 2px dashed #ddd; text-align: center; display: none; }
    .loser-bench h4 { margin: 0 0 10px 0; color: #666; font-size: 14px; font-weight: 400; }
    .loser-chip { display: inline-block; padding: 8px 12px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 20px; margin: 4px; font-size: 12px; font-weight: 400; color: #555; cursor: pointer; transition: 0.2s; }
    .loser-chip:hover { background: var(--aussie-blue); color: white; border-color: var(--aussie-blue); }

    .score-section { margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px; }
    .tour-score-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 15px; }
    .tour-score-table th { color: var(--wimbledon-sage); border-bottom: 2px solid var(--wimbledon-sage); padding: 8px; text-align: center; font-weight: 400; background: rgba(93, 156, 118, 0.1); }
    .tour-score-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: center; font-weight: 400; color: var(--text-dark); }

    .rank-1-icon { font-variation-settings: 'FILL' 1; color: #FFD700; font-size: 18px; }
    .team { padding: 8px; border-radius: 8px; cursor: pointer; margin: 4px 0; font-size: 12px; font-weight: 400; display: flex; justify-content: center; align-items: center; background: #f9f9f9; transition: 0.2s; text-align: center; }
    .team.winner, .match-box.final-stage .team.winner { background: var(--roland-clay) !important; color: white !important; box-shadow: 0 2px 5px rgba(217, 140, 115, 0.4); }
    .team.loser { opacity: 0.4; text-decoration: line-through; color: #999; pointer-events: none; }

    
    .form-dot { width: 14px; height: 14px; border-radius: 50%; }
    .win-dot { background: var(--wimbledon-sage); }
    .loss-dot { background: var(--up-red); }

    
    .pool-ladder { display: flex; flex-wrap: wrap; gap: 8px; padding: 15px; background: white; border: 2px solid #E5E5EA; border-radius: 15px; margin-bottom: 15px; }
    .btn-purple-main { width: 100%; padding: 20px; background: var(--wimbledon-sage); color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: 400; margin-top: 15px; cursor: pointer; }
    #ladder-canvas-wrap { background: white; border-radius: 20px; overflow: hidden; margin-top: 15px; border: 1px solid #eee; position: relative; width: 100%; }
    #ladderCanvas { width: 100%; height: auto; display: block; }
    .congrats-box { background: rgba(217, 140, 115, 0.1); padding: 15px; border-radius: 15px; margin-top: 20px; font-size: 14px; line-height: 1.8; border: 2px solid var(--roland-clay); color: #1C1C1E; display: none; text-align: center; font-weight: 400; }

    .rule-box{ margin-top: 14px; padding: 12px 12px; background: #fff; border: 1px solid #eee; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.05); font-size: 10px; line-height: 1.55; color: #666; font-weight: 400; }
    .rule-box b{ color:#1C1C1E; font-weight: 400; }
    .rule-box .r-tt{ display:flex; align-items:center; gap:6px; margin-bottom:8px; color:#1C1C1E; font-size: 12px; }
    .rule-box .r-tt .material-symbols-outlined{ font-size: 18px; color: var(--wimbledon-sage); font-variation-settings: 'FILL' 1; }
    .rule-box .r-mini{ font-size: 9px; color:#777; }
    .rule-box .r-line{ margin-top:6px; }

    
    #view-tournament .section-card { padding-bottom: 130px; }
    #view-tournament #setup-area { position: relative; z-index: 2; }

    
    .autofit-cell { white-space: nowrap; } 
    .wrap-mode {
      white-space: normal !important;
      overflow: visible !important;
      text-overflow: clip !important;
      word-break: keep-all;
      line-height: 1.2;
    }
    .wrap-mode.autofit-cell {
      font-size: clamp(9px, 2.7vw, 12px); 
    }

    
    @media (max-width: 420px){
      .tennis-table th:nth-child(1), .tennis-table td:nth-child(1){ width: 11% !important; white-space: nowrap; }
      .tennis-table th:nth-child(2), .tennis-table td:nth-child(2){ width: 34% !important; }
      .tennis-table th:nth-child(3), .tennis-table td:nth-child(3){ width: 21% !important; }  /* 24% â†’ 21% (-3%) */
      .tennis-table th:nth-child(4), .tennis-table td:nth-child(4){ width: 17% !important; white-space: nowrap; }  /* 12% â†’ 17% (+5%) */
      .tennis-table th:nth-child(5), .tennis-table td:nth-child(5){ width: 17% !important; white-space: nowrap; }  /* 19% â†’ 17% (-2%) */
      .tennis-table td{ padding: 11px 6px; }
      .tennis-table th{ padding: 8px 6px; }
    }
  
    /* v3.693: í† ë„ˆë¨¼íŠ¸ ì§€ì •ì„ íƒ(ë³µì‹) íŒ€ ë¯¸ë¦¬ë³´ê¸° */
    .manual-team-box{
      border: 2px solid #E5E5EA;
      border-radius: 15px;
      padding: 14px 14px 10px;
      background: #fff;
      margin: 12px 0 18px;
    }
    .manual-team-title{
      display:flex;
      align-items:center;
      gap:6px;
      font-size: 13px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 10px;
    }
    .manual-team-title .material-symbols-outlined{
      font-size: 18px;
      color: var(--aussie-blue);
    }
    .manual-team-list{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .team-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #E5E5EA;
      background: #F7F7FA;
      font-size: 12px;
      color: var(--text-dark);
      white-space: nowrap;
    }
    .team-chip .chip-no{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px; height:18px;
      border-radius: 50%;
      background: var(--aussie-blue);
      color:#fff;
      font-size: 11px;
      font-weight: 700;
      flex:0 0 auto;
    }
    .team-chip .bye{
      color: var(--text-gray);
      font-weight: 700;
    }

    /* âœ… ëª¨ë°”ì¼ì—ì„œ 3ê°œ ë²„íŠ¼(íšŒì›/ê²ŒìŠ¤íŠ¸/ì „ì²´ ë“±)ì´ í•œ ì¤„ì— ì•ˆì •ì ìœ¼ë¡œ ì •ë ¬ë˜ë„ë¡ ì¶•ì†Œ */
    @media (max-width: 420px){
      .opt-row{ gap:6px !important; }
      .opt-btn{ padding:10px 6px !important; font-size:12px !important; }
    }

    /* ========================================
       ëª¨ë‹¬ ìŠ¤íƒ€ì¼
       ======================================== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 25000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 25px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      font-size: 20px;
      font-weight: 400;
      color: var(--wimbledon-sage);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-participant-list {
      max-height: 300px;
      overflow-y: auto;
      border: 2px solid #E5E5EA;
      border-radius: 12px;
      padding: 15px;
      background: #f8f8f8;
    }

    .modal-participant-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-participant-item:hover {
      background: var(--aussie-blue);
      color: white;
    }

    .modal-participant-item.selected {
      background: var(--wimbledon-sage);
      color: white;
    }

    .modal-checkbox {
      margin-right: 12px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .modal-rank {
      font-weight: 700;
      margin-right: 10px;
      min-width: 50px;
      color: var(--aussie-blue);
    }

    .modal-participant-item.selected .modal-rank {
      color: white;
    }

    .modal-info {
      padding: 12px;
      background: rgba(93, 156, 118, 0.1);
      border-left: 4px solid var(--wimbledon-sage);
      border-radius: 8px;
      margin: 15px 0;
      font-size: 13px;
      color: var(--text-dark);
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-weight: 400;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.2s;
    }

    .modal-btn-primary {
      background: var(--wimbledon-sage);
      color: white;
    }

    .modal-btn-primary:hover {
      background: #4d8c66;
      box-shadow: 0 4px 12px rgba(93, 156, 118, 0.4);
    }

    .modal-btn-secondary {
      background: var(--text-gray);
      color: white;
    }

    .modal-btn-secondary:hover {
      background: #7e7e83;
    }

    /* ========================================
       ì„ ìˆ˜ ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼
       ======================================== */
    .p-label {
      min-width: 75px;
      flex: 0 0 auto;
      box-sizing: border-box;
    }

    /* ========================================
       ëª¨ë°”ì¼ ì„ ìˆ˜ ë²„íŠ¼ 3ê°œ ë°°ì¹˜ (ì™„ì „ ìˆ˜ì •)
       ======================================== */
    @media (max-width: 420px) {
      .p-label {
        /* â­ min-width ì™„ì „ ì œê±° */
        min-width: 0 !important;
        /* â­ widthì™€ max-width ë™ì¼í•˜ê²Œ ì„¤ì • */
        width: calc(33.333% - 6px) !important;
        max-width: calc(33.333% - 6px) !important;
        /* â­ flex-basisë„ ë™ì¼í•˜ê²Œ */
        flex: 0 0 calc(33.333% - 6px) !important;
        /* â­ box-sizingìœ¼ë¡œ padding í¬í•¨ ê³„ì‚° */
        box-sizing: border-box !important;
        /* â­ íŒ¨ë”©ê³¼ í°íŠ¸ ì¶•ì†Œ */
        padding: 6px 2px !important;
        font-size: 12px !important;
        /* â­ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }
      
      .p-rank {
        font-size: 9px !important;
        display: block !important;
        margin-top: 2px !important;
      }
    }

    /* ========================================
       v3.79: ë‹¤ì¤‘ í´ëŸ½ ì‹œìŠ¤í…œ ìŠ¤íƒ€ì¼
       ======================================== */
    .club-selector-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      max-width: 600px;
      margin: 0 auto;
    }
    .club-selector-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      padding: 10px 14px;
      border: 2px solid var(--wimbledon-sage);
      border-radius: 14px;
      background: white;
      font-size: 14px;
      font-weight: 400;
      color: var(--text-dark);
      cursor: pointer;
      transition: all 0.2s;
      overflow: hidden;
    }
    .club-selector-btn .club-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--wimbledon-sage);
      flex-shrink: 0;
    }
    .club-selector-btn .club-name-text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align: left;
    }
    .club-selector-btn .material-symbols-outlined {
      font-size: 18px;
      color: var(--text-gray);
      flex-shrink: 0;
    }
    .club-selector-btn:active {
      background: rgba(93, 156, 118, 0.08);
    }

    /* í´ëŸ½ ì„ íƒ ë“œë¡­ë‹¤ìš´ */
    .club-dropdown {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 26000;
      justify-content: center;
      align-items: flex-start;
      padding-top: 60px;
    }
    .club-dropdown.active { display: flex; }
    .club-dropdown-content {
      background: white;
      border-radius: 20px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      max-height: 70vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .club-dropdown-title {
      font-size: 18px;
      font-weight: 400;
      color: var(--wimbledon-sage);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .club-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 6px;
      border: 2px solid transparent;
    }
    .club-item:hover { background: #f8f8f8; }
    .club-item.active-club {
      border-color: var(--wimbledon-sage);
      background: rgba(93, 156, 118, 0.06);
    }
    .club-item .club-item-dot {
      width: 12px; height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .club-item .club-item-info { flex: 1; overflow: hidden; }
    .club-item .club-item-name {
      font-size: 15px;
      font-weight: 400;
      color: var(--text-dark);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .club-item .club-item-sub {
      font-size: 11px;
      color: var(--text-gray);
      margin-top: 2px;
    }
    .club-item .club-item-check {
      font-size: 20px;
      color: var(--wimbledon-sage);
    }
    .club-dropdown-footer {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 8px;
    }
    .club-dropdown-footer button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 400;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: 0.2s;
    }
    .club-add-btn {
      background: var(--wimbledon-sage);
      color: white;
    }
    .club-close-btn {
      background: #E5E5EA;
      color: var(--text-dark);
    }

    /* í´ëŸ½ ê´€ë¦¬ í™”ë©´ ìŠ¤íƒ€ì¼ */
    .club-form-group {
      margin-bottom: 16px;
    }
    .club-form-label {
      display: block;
      font-size: 13px;
      color: var(--text-gray);
      margin-bottom: 6px;
      font-weight: 400;
    }
    .club-form-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #E5E5EA;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 400;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }
    .club-form-input:focus {
      outline: none;
      border-color: var(--wimbledon-sage);
    }
    .club-form-hint {
      font-size: 11px;
      color: var(--text-gray);
      margin-top: 4px;
      line-height: 1.4;
    }
    .club-color-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .club-color-chip {
      width: 36px; height: 36px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }
    .club-color-chip.selected {
      border-color: var(--text-dark);
      transform: scale(1.15);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .club-card-manage {
      background: white;
      border: 2px solid #E5E5EA;
      border-radius: 16px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .club-card-manage .club-manage-dot {
      width: 14px; height: 14px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .club-card-manage .club-manage-info { flex: 1; }
    .club-card-manage .club-manage-name {
      font-size: 15px; font-weight: 400; color: var(--text-dark);
    }
    .club-card-manage .club-manage-url {
      font-size: 10px; color: var(--text-gray); margin-top: 2px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
      max-width: 200px;
    }
    .club-card-manage .club-manage-actions {
      display: flex; gap: 6px; flex-shrink: 0;
    }
    .club-manage-btn {
      padding: 8px 10px;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 400;
      cursor: pointer;
      color: white;
    }


    /* ========================================
       v3.80: í™ˆ í™”ë©´ - ì½”íŠ¸ ì •ë³´ & ê³µì§€ì‚¬í•­
       ======================================== */
    .home-section-card {
      background: white;
      border-radius: 20px;
      padding: 18px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .home-section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 400;
      color: var(--text-dark);
      margin-bottom: 14px;
    }
    .home-section-title .material-symbols-outlined {
      font-size: 20px;
      color: var(--wimbledon-sage);
    }
    .court-info-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 0;
      font-size: 14px;
      color: var(--text-dark);
      line-height: 1.5;
    }
    .court-info-row .material-symbols-outlined {
      font-size: 18px;
      color: var(--wimbledon-sage);
      flex-shrink: 0;
      margin-top: 2px;
    }
    .court-info-memo {
      margin-top: 8px;
      padding: 10px 12px;
      background: rgba(93, 156, 118, 0.08);
      border-radius: 10px;
      font-size: 13px;
      color: #555;
      line-height: 1.4;
    }
    .court-btn-row {
      display: flex;
      gap: 8px;
      margin-top: 14px;
    }
    .court-btn-row button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 400;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .btn-map {
      background: var(--wimbledon-sage);
      color: white;
    }
    .btn-share-wrap {
      position: relative;
    }
    .btn-share {
      background: var(--aussie-blue);
      color: white;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 400;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .share-dropdown {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      margin-bottom: 6px;
      overflow: hidden;
      z-index: 100;
    }
    .share-dropdown.active { display: block; }
    .share-dropdown-item {
      padding: 12px 14px;
      font-size: 13px;
      color: var(--text-dark);
      cursor: pointer;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .share-dropdown-item:hover,
    .share-dropdown-item:active {
      background: rgba(102, 157, 179, 0.1);
    }
    .share-dropdown-item .material-symbols-outlined {
      font-size: 18px;
      color: var(--aussie-blue);
    }

    /* ê³µì§€ì‚¬í•­ */
    .notice-item {
      padding: 12px 14px;
      border-radius: 12px;
      background: #f8f8f8;
      margin-bottom: 8px;
      border-left: 4px solid #ddd;
    }
    .notice-item.important {
      background: rgba(217, 140, 115, 0.08);
      border-left-color: var(--roland-clay);
    }
    .notice-title-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      font-weight: 400;
      color: var(--text-dark);
    }
    .notice-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 8px;
      border-radius: 6px;
      background: var(--roland-clay);
      color: white;
      font-size: 11px;
      font-weight: 400;
      flex-shrink: 0;
    }
    .notice-date {
      font-size: 11px;
      color: var(--text-gray);
      margin-top: 4px;
    }
    .notice-empty {
      text-align: center;
      padding: 20px;
      color: var(--text-gray);
      font-size: 13px;
    }


    /* âœ… v3.81: ì„ ìˆ˜ ê´€ë¦¬ í…Œì´ë¸” ëª¨ë°”ì¼ ìµœì í™” */
    .player-mgmt-table { table-layout: auto !important; }
    .player-mgmt-table td { overflow: visible !important; text-overflow: clip !important; }
    .player-mgmt-table td:nth-child(1) { width: auto !important; }
    .player-mgmt-table td:nth-child(2) { width: 50px !important; }
    .player-mgmt-table td:nth-child(3) { width: 140px !important; }

    /* ========================================
       v3.81: ì´ë¬´ ëª¨ë“œ ìŠ¤íƒ€ì¼
       ======================================== */
    .treasurer-pin-wrap {
      text-align: center;
      padding: 40px 20px;
    }
    .treasurer-pin-wrap input {
      width: 200px;
      padding: 14px;
      border: 2px solid #E5E5EA;
      border-radius: 12px;
      font-size: 20px;
      text-align: center;
      letter-spacing: 8px;
      font-weight: 400;
    }
    .treasurer-pin-wrap input:focus {
      outline: none;
      border-color: var(--wimbledon-sage);
    }
    .treasurer-menu {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    /* íšŒë¹„ í…Œì´ë¸” */
    .fee-table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-top: 12px;
    }
    .fee-table {
      border-collapse: collapse;
      font-size: 13px;
      min-width: 500px;
    }
    .fee-table th {
      padding: 10px 8px;
      text-align: center;
      font-weight: 400;
      background: rgba(93, 156, 118, 0.1);
      color: var(--wimbledon-sage);
      border-bottom: 2px solid var(--wimbledon-sage);
      white-space: nowrap;
      position: sticky;
      top: 0;
    }
    .fee-table th:first-child {
      position: sticky;
      left: 0;
      z-index: 2;
      background: rgba(93, 156, 118, 0.15);
    }
    .fee-table td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid #eee;
      font-weight: 400;
      white-space: nowrap;
    }
    .fee-table td:first-child {
      position: sticky;
      left: 0;
      background: white;
      z-index: 1;
      font-weight: 400;
      color: var(--text-dark);
    }
    .fee-check { cursor: pointer; font-size: 18px; }
    .fee-unpaid { color: var(--up-red); background: rgba(255,59,48,0.06); }
    .fee-current-month { background: rgba(102, 157, 179, 0.1); }
    /* ì¬ì • */
    .finance-tab-row {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
    }
    .finance-tab {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--roland-clay);
      color: white;
      opacity: 0.8;
    }
    .finance-tab.active {
      background: var(--aussie-blue) !important;
      opacity: 1;
      box-shadow: 0 2px 8px rgba(102, 157, 179, 0.4);
    }
    .finance-list {
      margin-top: 10px;
    }
    .finance-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: #f8f8f8;
      border-radius: 10px;
      margin-bottom: 6px;
      gap: 10px;
    }
    .finance-item .fi-date { font-size: 12px; color: var(--text-gray); min-width: 50px; }
    .finance-item .fi-desc { flex: 1; font-size: 14px; color: var(--text-dark); }
    .finance-item .fi-amount { font-size: 14px; font-weight: 400; min-width: 80px; text-align: right; }
    .finance-item .fi-amount.income { color: var(--wimbledon-sage); }
    .finance-item .fi-amount.expense { color: var(--up-red); }
    .finance-item .fi-del {
      font-size: 18px;
      color: var(--text-gray);
      cursor: pointer;
      flex-shrink: 0;
    }
    .finance-summary {
      margin-top: 14px;
      padding: 14px;
      border-radius: 14px;
      background: white;
      border: 2px solid var(--wimbledon-sage);
      text-align: center;
      font-size: 16px;
      color: var(--text-dark);
    }
    .finance-summary .fs-label { font-size: 12px; color: var(--text-gray); }
    .finance-summary .fs-amount { font-size: 22px; color: var(--wimbledon-sage); margin-top: 4px; }
    /* CRUD ì¹´ë“œ */
    .crud-item {
      background: white;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 8px;
    }
    .crud-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .crud-item-actions {
      display: flex;
      gap: 6px;
    }
    .crud-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 400;
      cursor: pointer;
      color: white;
    }
    .crud-btn-edit { background: var(--aussie-blue); }
    .crud-btn-del { background: var(--up-red); }

</style>
</head>

<body>
<div id="splash">
  <img src="icon.png" alt="GrandSlam Logo">
  <div class="loading-text">âŒ› ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
</div>
<div id="loading-overlay">âŒ› ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>

<!-- âœ… v3.820: ì»¤ìŠ¤í…€ Alert ëª¨ë‹¬ -->
<div id="gsAlertModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.45); z-index:25000; justify-content:center; align-items:center;">
  <div style="background:#fff; border-radius:20px; padding:28px 24px 20px; width:300px; max-width:88vw; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.18);">
    <div id="gsAlertMsg" style="font-size:14px; color:var(--text-dark); line-height:1.6; margin-bottom:20px; white-space:pre-line;"></div>
    <button onclick="gsAlertClose()" style="width:100%; padding:13px; background:var(--wimbledon-sage); color:white; border:none; border-radius:12px; font-size:15px; font-weight:400; cursor:pointer;">í™•ì¸</button>
  </div>
</div>

<!-- âœ… v3.820: ì»¤ìŠ¤í…€ Confirm ëª¨ë‹¬ -->
<div id="gsConfirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.45); z-index:25000; justify-content:center; align-items:center;">
  <div style="background:#fff; border-radius:20px; padding:28px 24px 20px; width:300px; max-width:88vw; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.18);">
    <div id="gsConfirmMsg" style="font-size:14px; color:var(--text-dark); line-height:1.6; margin-bottom:20px; white-space:pre-line;"></div>
    <div style="display:flex; gap:10px;">
      <button onclick="gsConfirmResolve(true)" style="flex:1; padding:13px; background:var(--wimbledon-sage); color:white; border:none; border-radius:12px; font-size:15px; font-weight:400; cursor:pointer;">í™•ì¸</button>
      <button onclick="gsConfirmResolve(false)" style="flex:1; padding:13px; background:#8E8E93; color:white; border:none; border-radius:12px; font-size:15px; font-weight:400; cursor:pointer;">ì·¨ì†Œ</button>
    </div>
  </div>
</div>
<!-- âœ… v3.8204: ì´ë¦„ ìˆ˜ì • ëª¨ë‹¬ (prompt ëŒ€ì²´) -->
<div id="gsEditNameModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.45); z-index:25000; justify-content:center; align-items:center;">
  <div style="background:#fff; border-radius:20px; padding:28px 24px 20px; width:300px; max-width:88vw; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.18);">
    <div style="font-size:14px; color:var(--text-dark); margin-bottom:14px; font-weight:400;">ì´ë¦„ ìˆ˜ì •</div>
    <input type="text" id="gsEditNameInput" style="width:100%; box-sizing:border-box; padding:12px 14px; border:2px solid var(--wimbledon-sage); border-radius:12px; font-size:15px; outline:none; margin-bottom:16px;"
      onkeydown="if(event.key==='Enter')gsEditNameConfirm()" />
    <div style="display:flex; gap:10px;">
      <button onclick="gsEditNameConfirm()" style="flex:1; padding:13px; background:var(--wimbledon-sage); color:white; border:none; border-radius:12px; font-size:15px; cursor:pointer;">í™•ì¸</button>
      <button onclick="gsEditNameCancel()" style="flex:1; padding:13px; background:#8E8E93; color:white; border:none; border-radius:12px; font-size:15px; cursor:pointer;">ì·¨ì†Œ</button>
    </div>
  </div>
</div>
<div id="clubPinModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.45); z-index:20000; justify-content:center; align-items:center;">
  <div style="background:#fff; border-radius:20px; padding:32px 24px; width:320px; max-width:90vw; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.18);">
    <span class="material-symbols-outlined" style="font-size:48px; color:var(--wimbledon-sage); display:block; margin-bottom:12px;">lock</span>
    <div style="font-size:15px; color:var(--text-dark); margin-bottom:20px; font-weight:400;">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
    <input type="password" id="clubPinInput" maxlength="10" placeholder="â€¢â€¢â€¢â€¢"
      style="width:100%; box-sizing:border-box; padding:14px 16px; border:2px solid var(--wimbledon-sage); border-radius:12px; font-size:16px; text-align:center; letter-spacing:4px; outline:none;"
      onkeydown="if(event.key==='Enter')confirmClubPin()" />
    <div style="margin-top:16px; display:flex; gap:10px;">
      <button onclick="confirmClubPin()" style="flex:1; padding:14px; background:var(--wimbledon-sage); color:white; border:none; border-radius:12px; font-size:15px; font-weight:400; cursor:pointer;">í™•ì¸</button>
      <button onclick="cancelClubPin()" style="flex:1; padding:14px; background:#8E8E93; color:white; border:none; border-radius:12px; font-size:15px; font-weight:400; cursor:pointer;">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- âœ… v3.79: í´ëŸ½ ì „í™˜ ì…€ë ‰í„° ë°” -->
<div class="club-selector-bar" id="clubSelectorBar">
  <button class="club-selector-btn" onclick="openClubDropdown()">
    <span class="club-dot" id="clubDot"></span>
    <span class="club-name-text" id="clubNameText">í´ëŸ½ ì„ íƒ...</span>
    <span class="material-symbols-outlined">expand_more</span>
  </button>
</div>

<!-- âœ… v3.79: í´ëŸ½ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
<div class="club-dropdown" id="clubDropdown" onclick="if(event.target===this)closeClubDropdown()">
  <div class="club-dropdown-content">
    <div class="club-dropdown-title">
      <span class="material-symbols-outlined">home_work</span>
      í´ëŸ½ ì„ íƒ
    </div>
    <div id="clubDropdownList"></div>
    <div class="club-dropdown-footer">
      <button class="club-add-btn" onclick="openClubCreate()">
        <span class="material-symbols-outlined" style="font-size:18px;">add_circle</span>ìƒˆ í´ëŸ½ ì¶”ê°€
      </button>
      <button class="club-close-btn" onclick="closeClubDropdown()">
        <span class="material-symbols-outlined" style="font-size:18px;">close</span>ë‹«ê¸°
      </button>
    </div>
  </div>
</div>

<!-- âœ… v3.79: í´ëŸ½ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
<div class="club-dropdown" id="clubFormModal" onclick="if(event.target===this)closeClubForm()">
  <div class="club-dropdown-content" style="max-height:85vh;">
    <div class="club-dropdown-title">
      <span class="material-symbols-outlined">add_business</span>
      <span id="clubFormTitle">ìƒˆ í´ëŸ½ ì¶”ê°€</span>
    </div>

    <!-- âœ… v3.79: ì‹œíŠ¸ ë³µì‚¬ ê°€ì´ë“œ (í† ê¸€) -->
    <div id="cfGuideToggle" style="margin-bottom:16px;">
      <button onclick="toggleClubGuide()" style="width:100%; padding:12px; border:2px solid var(--wimbledon-sage); border-radius:12px; background:rgba(93,156,118,0.08); color:var(--wimbledon-sage); font-size:13px; font-weight:400; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
        <span class="material-symbols-outlined" style="font-size:18px;">help</span>
        ì²˜ìŒì´ì‹ ê°€ìš”? ì‚¬ìš©ë²• ë³´ê¸°
        <span class="material-symbols-outlined" id="cfGuideArrow" style="font-size:18px; transition:transform 0.3s;">expand_more</span>
      </button>
      <div id="cfGuideBody" style="display:none; margin-top:12px; padding:16px; background:#f8fdf9; border:1px solid #e0f0e4; border-radius:14px; font-size:12px; line-height:1.7; color:#333;">
        <div style="font-size:14px; font-weight:700; color:var(--wimbledon-sage); margin-bottom:10px; display:flex; align-items:center; gap:6px;">
          <span class="material-symbols-outlined" style="font-size:20px;">menu_book</span>
          ìƒˆ í´ëŸ½ ì¶”ê°€ ì•ˆë‚´
        </div>

        <div style="background:white; border-radius:10px; padding:12px; margin-bottom:8px; border:1px solid #e8e8e8;">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <span style="background:var(--wimbledon-sage); color:white; width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; flex-shrink:0;">1</span>
            <strong>í´ëŸ½ ì´ë¦„ ì…ë ¥</strong>
          </div>
          <div style="padding-left:30px; color:#555;">
            ì•„ë˜ì— ìƒˆ í´ëŸ½ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.
          </div>
        </div>

        <div style="background:white; border-radius:10px; padding:12px; margin-bottom:8px; border:1px solid #e8e8e8;">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <span style="background:var(--wimbledon-sage); color:white; width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; flex-shrink:0;">2</span>
            <strong>ì €ì¥ ë²„íŠ¼ ëˆ„ë¥´ê¸°</strong>
          </div>
          <div style="padding-left:30px; color:#555;">
            <b>Google Sheetsê°€ ìë™ìœ¼ë¡œ ìƒì„±</b>ë©ë‹ˆë‹¤!<br>
            ë³„ë„ì˜ ì‹œíŠ¸ ë³µì‚¬ë‚˜ URL ì…ë ¥ì´ í•„ìš” ì—†ì–´ìš”.
          </div>
        </div>

        <div style="background:white; border-radius:10px; padding:12px; border:1px solid #e8e8e8;">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <span style="background:var(--wimbledon-sage); color:white; width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; flex-shrink:0;">3</span>
            <strong>ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥!</strong>
          </div>
          <div style="padding-left:30px; color:#555;">
            ìƒˆ í´ëŸ½ìœ¼ë¡œ ì „í™˜í•˜ë©´ <b>ë°”ë¡œ ì„ ìˆ˜ ë“±ë¡ ë° ê²Œì„ ì‹œì‘</b> ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>
        </div>

        <div style="margin-top:10px; padding:10px; background:rgba(102,157,179,0.1); border-radius:8px; font-size:11px; color:var(--aussie-blue);">
          ğŸ’¡ <b>ìë™ ì‹œíŠ¸ ìƒì„±:</b> í´ëŸ½ë§ˆë‹¤ ë…ë¦½ëœ Google Sheetsê°€ ë§Œë“¤ì–´ì ¸ ë°ì´í„°ê°€ ì™„ì „íˆ ë¶„ë¦¬ë©ë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <div class="club-form-group">
      <label class="club-form-label">í´ëŸ½ ì´ë¦„ *</label>
      <input type="text" class="club-form-input" id="cfName" placeholder="ì˜ˆ: ê´‘ëª… í…Œë‹ˆìŠ¤í´ëŸ½" />
    </div>

    <div class="club-form-group">
      <label class="club-form-label">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ *</label>
      <input type="password" class="club-form-input" id="cfPin" placeholder="ì˜ˆ: 1234 (4ìë¦¬ ì…ë ¥)" maxlength="20" />
      <div class="club-form-hint">ğŸ’¡ 4ìë¦¬ ìˆ«ìë¡œ ì„¤ì •í•˜ì„¸ìš” (ì˜ˆ: 1234)</div>
    </div>
    <div class="club-form-group">
      <label class="club-form-label">ë‚ ì”¨ ê²€ìƒ‰ ë„ì‹œ (í•œê¸€ ë˜ëŠ” ì˜ë¬¸)</label>
      <input type="text" class="club-form-input" id="cfCity" placeholder="ì˜ˆ: ê´‘ëª…" />
    </div>
    <div class="club-form-group">
      <label class="club-form-label">ë‚ ì”¨ ë„ì‹œëª… (í•œê¸€)</label>
      <input type="text" class="club-form-input" id="cfCityKo" placeholder="ì˜ˆ: ê´‘ëª…" />
    </div>
    <div class="club-form-group">
      <label class="club-form-label">í´ëŸ½ í…Œë§ˆ ìƒ‰ìƒ</label>
      <div class="club-color-row" id="cfColorRow"></div>
    </div>
    <input type="hidden" id="cfEditId" value="" />
    <div style="display:flex; gap:10px; margin-top:20px;">
      <button class="modal-btn modal-btn-primary" onclick="saveClubForm()" style="flex:1;">
        <span class="material-symbols-outlined btn-ico">save</span>ì €ì¥
      </button>
      <button class="modal-btn modal-btn-secondary" onclick="closeClubForm()" style="flex:1;">
        <span class="material-symbols-outlined btn-ico">close</span>ì·¨ì†Œ
      </button>
    </div>
  </div>
</div>

<div id="view-home" class="app-screen active">
  <div class="weather-card">
    <div class="header-banner"><span class="material-symbols-outlined">wb_sunny</span>ê´‘ëª… ë‚ ì”¨</div>
    <div class="search-row">
      <input id="city" class="w-input" value="ê´‘ëª…" placeholder="ì˜ˆ: ì„œìš¸, ê´‘ëª…, íŒŒì£¼" />
      <button id="btnSearch" class="w-btn" onclick="loadWeatherForNextMeeting(0)">ê²€ìƒ‰</button>
    </div>
    <div class="btn-row">
      <button id="btnRefresh" class="w-btn active" onclick="loadWeatherForNextMeeting(0)">ì´ë²ˆ ëª¨ì„ ë‚ ì”¨</button>
      <button id="btnNext" class="w-btn" onclick="loadWeatherForNextMeeting(1)">ë‹¤ìŒ ëª¨ì„ ë‚ ì”¨</button>
    </div>
    <button id="naverWeatherBtn" onclick="openNaverWeather()" class="btn-sub sky" style="width:100%; margin-bottom:15px; height:45px; font-size:14px; display:flex; align-items:center; justify-content:center; gap:8px;">
      <span class="material-symbols-outlined" style="font-size:20px;">open_in_new</span>Naver ë‚ ì”¨ í™•ì¸
    </button>
    <div id="dateDisplay" class="date-display"></div>
    <div id="status"></div>
    <table id="tbl" class="weather-table" style="display:none;">
      <thead><tr><th style="width:20%;">ì‹œê°„</th><th style="width:20%;">ë‚ ì”¨</th><th style="width:20%;">ì˜¨ë„</th><th style="width:20%;">ê°•ìˆ˜</th><th style="width:20%;">ë°”ëŒ</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
    <div id="dynamicTip" class="tip-box" style="display:none;"><div id="tipContent" class="tip-text"></div></div>
  </div>

  <!-- âœ… v3.80: ì½”íŠ¸ ì •ë³´ ì„¹ì…˜ -->
  <div class="home-section-card" id="courtInfoCard">
    <div class="home-section-title">
      <span class="material-symbols-outlined">sports_tennis</span>
      ì˜¤ëŠ˜ì˜ ì½”íŠ¸ ì •ë³´
    </div>
    <div id="courtInfoContent" style="display:none;">
      <div class="court-info-row">
        <span class="material-symbols-outlined">location_on</span>
        <span id="courtName"></span>
      </div>
      <div class="court-info-row">
        <span class="material-symbols-outlined">schedule</span>
        <span id="courtTime"></span>
        <span id="courtNumber" style="display:none; margin-left:8px; font-size:13px; color:var(--wimbledon-sage); font-weight:400; background:rgba(93,156,118,0.1); padding:2px 8px; border-radius:8px;"></span>
      </div>
      <div class="court-info-row">
        <span class="material-symbols-outlined">map</span>
        <span id="courtAddress"></span>
      </div>
      <div id="courtMemo" class="court-info-memo" style="display:none;"></div>
    </div>
    <!-- âœ… v3.817: ê³µì§€ ì—†ì„ ë•Œ ì•ˆë‚´ ë©”ì‹œì§€ -->
    <div id="courtNoNotice" style="display:block; padding:16px 0; text-align:center; color:var(--text-gray); font-size:13px;">
      <span class="material-symbols-outlined" style="font-size:32px; display:block; margin-bottom:6px; opacity:0.4;">event_busy</span>
      ë“±ë¡ëœ ì½”íŠ¸ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤
    </div>
    <div class="court-btn-row">
      <button class="btn-map" onclick="openCourtMap()">
        <span class="material-symbols-outlined" style="font-size:18px;">map</span>ì§€ë„ë³´ê¸°
      </button>
      <div class="btn-share-wrap" style="flex:1;">
        <div class="share-dropdown" id="shareDropdown">
          <div class="share-dropdown-item" onclick="shareContent('weather')">
            <span class="material-symbols-outlined">cloud</span>ë‚ ì”¨ë§Œ
          </div>
          <div class="share-dropdown-item" onclick="shareContent('weather+court')">
            <span class="material-symbols-outlined">add_location</span>ë‚ ì”¨ + ì½”íŠ¸
          </div>
          <div class="share-dropdown-item" onclick="shareContent('all')">
            <span class="material-symbols-outlined">select_all</span>ì „ì²´ (ë‚ ì”¨+ì½”íŠ¸+ê³µì§€)
          </div>
          <div class="share-dropdown-item" onclick="shareContent('text')">
            <span class="material-symbols-outlined">content_copy</span>í…ìŠ¤íŠ¸ ë³µì‚¬
          </div>
        </div>
        <button class="btn-share" onclick="toggleShareDropdown()">
          <span class="material-symbols-outlined" style="font-size:18px;">share</span>ì¹´í†¡ê³µìœ 
        </button>
      </div>
    </div>
  </div>

  <!-- âœ… v3.80: ê³µì§€ì‚¬í•­ ì„¹ì…˜ -->
  <div class="home-section-card" id="noticeCard">
    <div class="home-section-title">
      <span class="material-symbols-outlined">campaign</span>
      ê³µì§€ì‚¬í•­
    </div>
    <div id="noticeList">
      <div class="notice-empty">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <div style="text-align:right; font-size:11px; color:#ccc; margin-top:10px; font-weight:400; padding-right:5px;">v3.8207_2</div>
</div>

<div id="view-tennis" class="app-screen">
  <div class="header-banner" onclick="location.reload()"><span class="material-symbols-outlined">emoji_events</span>GrandSlam Ranking</div>
    <div class="tab-menu">
    <button id="t1" class="tab-btn active" onclick="tab(1)" style="display:flex; align-items:center; justify-content:center; gap:4px;">
      <span class="material-symbols-outlined" style="font-size:18px;">leaderboard</span>ì‹œì¦Œë­í‚¹
    </button>
    <button id="t2" class="tab-btn" onclick="tab(2)" style="display:flex; align-items:center; justify-content:center; gap:4px;">
      <span class="material-symbols-outlined" style="font-size:18px;">calendar_month</span>ì£¼ê°„ë­í‚¹
    </button>
  </div>

  <div id="s1" class="section-card active">
    <div class="sub-rank-title"><span class="material-symbols-outlined">bar_chart</span>ìˆœìœ„ ë³€ë™ ì¶”ì´</div>
    <div class="chart-nav">
      <button class="chart-btn active" onclick="updateChartRange(0)">2-3ì›”</button>
      <button class="chart-btn" onclick="updateChartRange(1)">4-5ì›”</button>
      <button class="chart-btn" onclick="updateChartRange(2)">6-7ì›”</button>
      <button class="chart-btn" onclick="updateChartRange(3)">8-9ì›”</button>
      <button class="chart-btn" onclick="updateChartRange(4)">10-11ì›”</button>
      <button class="chart-btn" onclick="updateChartRange(5)">12-1ì›”</button>
    </div>
    <div style="height:320px; position:relative;"><canvas id="seasonChart"></canvas></div>
    <div class="sub-rank-title"><span class="material-symbols-outlined">format_list_numbered</span>ì¢…í•© ìˆœìœ„í‘œ</div>
    <table id="seasonTable" class="tennis-table"></table>
    <div class="sub-rank-title"><span class="material-symbols-outlined">groups</span>ë³µì‹ ë­í‚¹</div>
    <table id="seasonDoubleTable" class="tennis-table"></table>
    <div class="sub-rank-title"><span class="material-symbols-outlined">person</span>ë‹¨ì‹ ë­í‚¹</div>
    <table id="seasonSingleTable" class="tennis-table"></table>

    <div class="sub-rank-title"><span class="material-symbols-outlined">group_add</span>ê²ŒìŠ¤íŠ¸ ì‹œì¦Œ ì¢…í•©</div>
    <table id="guestSeasonTotalTable" class="tennis-table"></table>
    <div class="sub-rank-title"><span class="material-symbols-outlined">groups</span>ê²ŒìŠ¤íŠ¸ ì‹œì¦Œ ë³µì‹</div>
    <table id="guestSeasonDoubleTable" class="tennis-table"></table>
    <div class="sub-rank-title"><span class="material-symbols-outlined">person</span>ê²ŒìŠ¤íŠ¸ ì‹œì¦Œ ë‹¨ì‹</div>
    <table id="guestSeasonSingleTable" class="tennis-table"></table>
  </div>

  <div id="s2" class="section-card">
    <div class="sub-rank-title">ğŸ“… ì£¼ê°„ ì¢…í•© ìˆœìœ„</div>
    <table id="weeklyTotalTable" class="tennis-table"></table>
    <div class="sub-rank-title">ğŸ‘¥ ì£¼ê°„ ë³µì‹ ìˆœìœ„</div>
    <table id="weeklyDoubleTable" class="tennis-table"></table>
    <div class="sub-rank-title">ğŸ‘¤ ì£¼ê°„ ë‹¨ì‹ ìˆœìœ„</div>
    <table id="weeklySingleTable" class="tennis-table"></table>
  </div>
  <div style="padding: 0 15px;">
    <button class="btn-main" onclick="showView('weather')" style="background:var(--text-gray); margin-top:20px;"><span class="material-symbols-outlined" style="font-size:18px; vertical-align:middle; margin-right:5px;">arrow_back</span>ë’¤ë¡œê°€ê¸°</button>
  </div>
</div>


<!-- ê²½ê¸°ê¸°ë¡ View -->
<div id="view-record" class="app-screen" style="display:none;">
  <div class="header-banner"><span class="material-symbols-outlined">sports_tennis</span>ë‹¨ì¼ê²Œì„</div>
  <div class="section-card active" style="display:block;">
    
    <!-- â­ ì¶”ê°€: ì°¸ê°€ ì„ ìˆ˜ ì„ íƒ íƒ€ì´í‹€ -->
    <div class="tour-section-title" style="display:flex; justify-content:space-between; align-items:center;"><span style="display:flex;align-items:center;gap:4px;"><span class="material-symbols-outlined">group_add</span>ì°¸ê°€ ì„ ìˆ˜ ì„ íƒ (<span id="record-cnt">0</span>ëª…)</span><button onclick="addOneTimePlayer()" style="font-size:11px; padding:4px 10px; border-radius:20px; border:1px solid var(--aussie-blue); background:var(--aussie-blue); color:white; cursor:pointer; font-weight:600;">+ ë‹¹ì¼ ê²ŒìŠ¤íŠ¸</button></div>
    <!-- âœ… v3.8202: 1vs2ìš© ì„¤ëª… ë¬¸êµ¬ (ë³µì‹ ëª¨ë“œ + í™œì„±í™” í´ëŸ½ë§Œ í‘œì‹œ) -->
    <!-- âœ… v3.8206: hint-1v2 ì œê±°ë¨ -->
    <div class="pool differ" id="pP"></div>

    <div style="display:flex; gap:8px; margin-top:20px;">
      <button id="m_db" class="type-btn selected" onclick="setM('double')"><span class="material-symbols-outlined btn-ico">groups</span>ë³µì‹</button>
      <button id="m_sg" class="type-btn" onclick="setM('single')"><span class="material-symbols-outlined btn-ico">person</span>ë‹¨ì‹</button>
    </div>

    <div class="team-box">
      <div id="hN" style="font-weight:400;"></div>
      <input type="number" id="hS" class="score-box" placeholder="0">
    </div>
    <div class="team-box">
      <div id="aN" style="font-weight:400;"></div>
      <input type="number" id="aS" class="score-box" placeholder="0">
    </div>

    <button class="btn-main" onclick="save()"><span class="material-symbols-outlined title-ico">save</span>ê²°ê³¼ ì €ì¥</button>

    <div class="rule-box">
      <div class="r-tt"><span class="material-symbols-outlined">info</span>ì ìˆ˜ íšë“ ê¸°ì¤€</div>
      <div class="r-mini">ğŸ¾ <b>ì°¸ì—¬</b>: +1</div>
      <div class="r-line r-mini">ğŸ‘¥ <b>ë³µì‹</b></div>
      <div class="r-mini">- ìŠ¹ë¦¬: <b>+2</b> (ì´ì  3ì ) / W+1</div>
      <div class="r-mini">- íŒ¨ë°°: <b>-0.7</b> (ì´ì  0.3ì ) / L+1</div>
      <div class="r-line r-mini">ğŸ‘¤ <b>ë‹¨ì‹</b></div>
      <div class="r-mini">- ìŠ¹ë¦¬: <b>+3</b> (ì´ì  4ì ) / W+1</div>
      <div class="r-mini">- íŒ¨ë°°: <b>-0.5</b> (ì´ì  0.5ì ) / L+1</div>
      <div class="r-line r-mini">ğŸ† <b>ìˆœìœ„</b>: ì ìˆ˜ &gt; ìŠ¹ë¥  &gt; ìŠ¹ìˆ˜ &gt; ê²½ê¸°ì°¸ì—¬ìˆ˜</div>
    </div>
  
  </div>
  <div style="padding: 0 15px;">
    <button class="btn-main" onclick="showView('game')" style="background:var(--text-gray); margin-top:20px;"><span class="material-symbols-outlined" style="font-size:18px; vertical-align:middle; margin-right:5px;">arrow_back</span>ë’¤ë¡œê°€ê¸°</button>
  </div>
</div>

<!-- ì„ ìˆ˜ê´€ë¦¬ View -->
<div id="view-player-mgmt" class="app-screen" style="display:none;">
  <div class="header-banner"><span class="material-symbols-outlined">person_search</span>ì„ ìˆ˜ ê´€ë¦¬</div>
  <div class="section-card active" style="display:block;">
    
    <h3>ğŸ‘¥ ì„ ìˆ˜ ë“±ë¡</h3>
    <div class="search-row" style="margin-bottom:20px;">
      <input type="text" id="pI" class="w-input" style="width:75%;" placeholder="ì„±í•¨">
      <button onclick="addP()" class="w-btn" style="background:var(--wimbledon-sage); margin-left:8px;">ë“±ë¡</button>
    </div>
    <div style="display:flex; align-items:center; gap:6px; margin:-10px 0 14px 0; font-size:11px; color:#666;">
      <input type="checkbox" id="pIsGuest" style="margin:0;">
      <label for="pIsGuest">ì¤€íšŒì›ì— ì¤€í•˜ëŠ” ê²ŒìŠ¤íŠ¸ë¡œ ë“±ë¡ (ì²´í¬ ì‹œ ë­í‚¹ì—ì„œ ê²ŒìŠ¤íŠ¸ë¡œ ë¶„ë¦¬)</label>
    </div>
    <table id="pL" class="tennis-table player-mgmt-table"><tbody></tbody></table>

    
    
    
    
    

    

    

    <div class="rule-box" style="margin-top:16px;">
      <div class="r-tt"><span class="material-symbols-outlined">database</span>ì£¼ìš” ì—…ë°ì´íŠ¸ ë¸Œë¦¬í•‘</div>
      <div class="r-mini">- <b>Data</b>: ì „ì²´ ë®ì–´ì“°ê¸°</div>
      <div class="r-mini">- <b>MatchLog</b>: appendRowë¡œ ëˆ„ì </div>
      <div class="r-line r-mini">- ê°œì¸í†µê³„(íŒŒíŠ¸ë„ˆ/ì²œì /ìµœê·¼í¼)ëŠ” <b>MatchLog ê¸°ë°˜</b>ìœ¼ë¡œ ê³„ì‚°</div>
      <div class="r-line r-mini">- í† ë„ˆë¨¼íŠ¸ <b>ì‹¤ì „ ëª¨ë“œ</b>: ì§„í–‰ ì¤‘ ë²„í¼ â†’ ìš°ìŠ¹ í™•ì • ìˆœê°„ì—ë§Œ ì»¤ë°‹</div>
      <div class="r-line r-mini">- âœ… v3.4: í† ë„ˆë¨¼íŠ¸ ë²„íŠ¼ í´ë¦­ ë²„ê·¸(í•˜ë‹¨ ë„¤ë¹„ ê²¹ì¹¨) í”½ìŠ¤</div>
      <div class="r-line r-mini">- âœ… v3.41: ë‹¨ì‹ 9ëª… ì¶œì „ ì‹œ ìµœí•˜ìœ„ ì¦ë°œ ë²„ê·¸ í”½ìŠ¤(ì˜ˆì„ /ëŒ€ê¸°ì„ ë°©ì‹)</div>
      <div class="r-line r-mini">- âœ… v3.42: ì‹œì¦Œ/ì£¼ê°„ + ì¢…ëª©ë³„ í…Œì´ë¸” ì „ë¶€ â–²â–¼ ë³€ë™ í‘œì‹œ + (-ìœ„) ë²„ê·¸ í”½ìŠ¤</div>
      <div class="r-line r-mini">- âœ… v3.43: ê°œì¸í†µê³„ ì„ íƒ ë²„íŠ¼ í™œì„±í™” + ìµœê·¼í¼/ë©˜íŠ¸ ë¶ˆì¼ì¹˜ í”½ìŠ¤</div>
      <div class="r-line r-mini">- âœ… v3.44: ë­í‚¹ ìŠ¹ë¥  ì¹¸ í™•ëŒ€ + ê°œì¸í†µê³„(ë‹¨/ë³µ ë¶„ë¦¬) ê°œì„ </div>
      <div class="r-line r-mini">- âœ… v3.52 Stable: í‘œì—ì„œ ë§ì¤„ì„(...) ë°œìƒ ì‹œ ìë™ 2ì¤„ í‘œì‹œ(autofit)</div>
      <div class="r-line r-mini">- âœ… v3.54: ê²ŒìŠ¤íŠ¸ ë¶„ë¦¬ ë­í‚¹(ì‹œì¦Œ ì¢…í•©/ë³µì‹/ë‹¨ì‹) + ê²½ê¸° ì…ë ¥ í’€ [G] í‘œì‹œ</div>
      <div class="r-line r-mini">- âœ… v3.58: ê²½ê¸° ì…ë ¥ ì„ ìˆ˜ í’€ â€” íšŒì›/ê²ŒìŠ¤íŠ¸ ì˜ì—­ ì‹œê° ë¶„ë¦¬ (GUEST LIST êµ¬ë¶„ì„ )</div>
      <div class="r-line r-mini">- âœ… v3.59: í† ë„ˆ/í†µê³„/ì‚¬ë‹¤ë¦¬ Flex ë ˆì´ì•„ì›ƒ í†µì¼ â€” ë‹¨ì¼ê²Œì„ ìŠ¤íƒ€ì¼ ì ìš© (ìƒí•˜ë¶„ë¦¬+í¼ì§ë²„íŠ¼)</div>
      <div class="r-line r-mini">- âœ… v3.60: CSS í´ë˜ìŠ¤ ì¶©ëŒ ì œê±° â€” ìˆœìˆ˜ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ + !importantë¡œ Grid ì¶©ëŒ ì™„ì „ í•´ê²°</div>
      <div class="r-line r-mini">- âœ… v3.61: HTML ë¶€ëª¨ ì»¨í…Œì´ë„ˆ í´ë˜ìŠ¤ ì œê±° â€” player-grid/pool-ladder í´ë˜ìŠ¤ ì‚­ì œë¡œ Grid ì™„ì „ ì°¨ë‹¨</div>
      <div class="r-line r-mini">- âœ… v3.693: UI í†µì¼ ì™„ì„± â€” â‘  ê²ŒìŠ¤íŠ¸ ë¼ë²¨ë§Œ íšŒìƒ‰ â‘¡ ì™¼ìª½ì •ë ¬ â‘¢ ì „ì²´ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ â‘£ ì°¨íŠ¸ ê²ŒìŠ¤íŠ¸ì œì™¸</div>
      <div class="r-line r-mini">- âœ… v3.71: ë¼ìš´ë“œ ëª¨ë“œ ì¶”ê°€ â€” Circle Method ì›í˜• íšŒì „ ë°©ì‹, Kimjak Algorithm ìˆœìœ„ ì‚°ì •, í† ë„ˆë¨¼íŠ¸ ì „í™˜</div>
      <div class="r-line r-mini">- âœ… v3.78428: ë¼ìš´ë“œ ëª¨ë“œ ì™„ê²°. í•¸ë“œí° í™”ë©´ ìµœì í™” </div>
      <div class="r-line r-mini">- âœ… v3.792: ë‹¤ì¤‘ í´ëŸ½ ì‹œìŠ¤í…œ â€” ìë™ ì‹œíŠ¸ ìƒì„±, ë§ˆìŠ¤í„° ë³´ì•ˆ, ì€ì€í•œ í´ëŸ½ ìƒ‰ìƒ, ë ˆì´ì•„ì›ƒ ìˆ˜ì •</div>
      <div class="r-line r-mini">- âœ… v3.8205: ë²„ê·¸ìˆ˜ì • â€” ë‹¨ì¼ê²Œì„/í† ë„ˆë¨¼íŠ¸/ì½”íŠ¸ì˜ˆì•½ ê²°ê³¼ì €ì¥ ë¶ˆê°€ ë²„ê·¸ ìˆ˜ì • (ì¤‘ê´„í˜¸ ëˆ„ë½ 5ê±´)</div>
      <div class="r-line r-mini">- âœ… v3.8205_1: ë²„ê·¸ìˆ˜ì • â€” ì „ì²´ì‚­ì œ ì‹œ GAS ì‘ë‹µìœ¼ë¡œ ì„ ìˆ˜ ë°ì´í„° ë³µì›ë˜ëŠ” ë²„ê·¸ ìˆ˜ì •</div>
      <div class="r-line r-mini">- âœ… v3.8205_2: ë²„ê·¸ìˆ˜ì • â€” ì „ì²´ì‚­ì œ í›„ reloadâ†’sync() ë ˆì´ìŠ¤ì»¨ë””ì…˜ ì œê±°, UI ì§ì ‘ ê°±ì‹ ìœ¼ë¡œ ë³€ê²½</div>
      <div class="r-line r-mini">- âœ… v3.8205_3: ë²„ê·¸ìˆ˜ì • â€” ì „ì²´ì‚­ì œ GAS adminResetAll+DELETE ì§ì ‘ í˜¸ì¶œë¡œ ì„œë²„ ë°ì´í„° ì™„ì „ ì‚­ì œ</div>
      <div class="r-line r-mini">- âœ… v3.8205_4: ë²„ê·¸ìˆ˜ì • â€” ë³µì‹ ìµœê³  íŒŒíŠ¸ë„ˆ ìŠ¹1ê°œ ì´ìƒ ì¡°ê±´ ì¶”ê°€, 0ìŠ¹ íŒŒíŠ¸ë„ˆëŠ” ë¶„ë°œ íŒŒíŠ¸ë„ˆë¡œ ì´ë™</div>
      <div class="r-line r-mini">- âœ… v3.8206: ì‹ ê¸°ëŠ¥ â€” ë‹¹ì¼ ê²ŒìŠ¤íŠ¸ ì¶”ê°€ (ìˆœìœ„/í†µê³„ ì œì™¸, matchLogë§Œ ê¸°ë¡), 1ëŒ€2ëŒ€ê²°ìš© ë²„íŠ¼ ëŒ€ì²´</div>
    </div>
  
    
    <hr>
    <button class="btn-sub sky" onclick="resetScoresKeepPlayers()">ì ìˆ˜ ì´ˆê¸°í™” (ì„ ìˆ˜ìœ ì§€)</button>
    <button class="btn-sub royal" onclick="resetWeeklyOnly()">ì£¼ê°„ ë¦¬ì…‹</button>
    <button class="btn-sub navy" onclick="adminResetAll()">ì „ì²´ ì‚­ì œ (ì´ˆê¸°í™”)</button>
    <hr>
    
    <button id="btnTourMode" class="btn-sub" style="background:#34C759;" onclick="toggleTournamentMode()">ğŸŸ© ì „ì²´ ê²Œì„ ì—°ìŠµ ëª¨ë“œ (ê¸°ë¡ë°˜ì˜ X)</button>

  </div>
  <div style="padding: 0 15px;">
    <button class="btn-main" onclick="showView('admin')" style="background:var(--text-gray); margin-top:20px;"><span class="material-symbols-outlined" style="font-size:18px; vertical-align:middle; margin-right:5px;">arrow_back</span>ë’¤ë¡œê°€ê¸°</button>
  </div>
</div>

<div id="view-stats" class="app-screen">
  <div class="section-card" style="display:block;">
    <div class="header-banner"><span class="material-symbols-outlined" style="font-size:30px;">monitoring</span>GrandSlam ê°œì¸í†µê³„</div>

    <div class="tour-section-title">
      <span class="material-symbols-outlined">group_add</span>ì°¸ê°€ ì„ ìˆ˜ ì„ íƒ
      <span style="font-size:11px; color:var(--text-gray); font-weight:normal;">(í†µê³„ ì •ë³´ë¥¼ ì›í•˜ëŠ” ì„ ìˆ˜ë¥¼ í´ë¦­!)</span>
    </div>
    <div id="stats-pList"></div>

    <div id="stats-report" style="display:none; margin-top:30px;">
      <div style="text-align:center; margin-bottom:20px; background:var(--aussie-blue); padding:15px; border-radius:16px;">
        <h2 id="target-name" style="margin:0; font-weight:400; font-size: 20px; color:white;"><span class="material-symbols-outlined title-ico">query_stats</span><span id="target-name-text">ì„ ìˆ˜ ë¦¬í¬íŠ¸</span></h2>
        <div style="width:40px; height:3px; background:var(--roland-clay); margin:8px auto;"></div>
      </div>

      <div class="tour-section-title" style="justify-content:center; margin-top:0;">
        <span class="material-symbols-outlined">reorder</span>í˜„ì¬ í¼ (ìµœê·¼ 10ê²½ê¸°)
      </div>
      <div id="form-dots" style="display:flex; gap:6px; justify-content:center; margin-bottom:20px;"></div>

      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
        <div class="team-box" style="border:1px solid var(--aussie-blue); background:rgba(102, 157, 179, 0.05);">
          <div style="font-size:11px; color:var(--aussie-blue); font-weight:bold;">ë‹¨ì‹ ìµœê³  ìŠ¹ë¥  ìƒëŒ€</div>
          <div id="res-s-best" style="font-size:16px; margin-top:5px;">-</div>
          <div id="res-s-best-sub" style="font-size:10px; color:var(--text-gray);">0ìŠ¹ 0íŒ¨</div>
        </div>
        <div class="team-box" style="border:1px solid var(--up-red); background:rgba(255, 59, 48, 0.05);">
          <div style="font-size:11px; color:var(--up-red); font-weight:bold;">ë‹¨ì‹ ë¼ì´ë²Œ(ì²œì )</div>
          <div id="res-s-worst" style="font-size:16px; margin-top:5px;">-</div>
          <div id="res-s-worst-sub" style="font-size:10px; color:var(--text-gray);">0ìŠ¹ 0íŒ¨</div>
        </div>
        <div class="team-box" style="border:1px solid var(--wimbledon-sage); background:rgba(93, 156, 118, 0.06);">
          <div style="font-size:11px; color:var(--wimbledon-sage); font-weight:bold;">ë³µì‹ ìµœê³  íŒŒíŠ¸ë„ˆ</div>
          <div id="res-d-partner" style="font-size:16px; margin-top:5px;">-</div>
          <div id="res-d-partner-sub" style="font-size:10px; color:var(--text-gray);">0ìŠ¹ 0íŒ¨</div>
        </div>
        <div class="team-box" style="border:1px solid #AF52DE; background:rgba(175, 82, 222, 0.05);">
          <div style="font-size:11px; color:#AF52DE; font-weight:bold;">ë³µì‹ ë¶„ë°œ íŒŒíŠ¸ë„ˆ</div>
          <div id="res-d-partner-worst" style="font-size:16px; margin-top:5px;">-</div>
          <div id="res-d-partner-worst-sub" style="font-size:10px; color:var(--text-gray);">0ìŠ¹ 0íŒ¨</div>
        </div>
        <div class="team-box" style="border:1px solid var(--roland-clay); background:rgba(217, 140, 115, 0.10);">
          <div style="font-size:11px; color:var(--roland-clay); font-weight:bold;">ë³µì‹ ë¼ì´ë²Œ1(ì²œì 1)</div>
          <div id="res-d-enemy1" style="font-size:16px; margin-top:5px;">-</div>
          <div id="res-d-enemy1-sub" style="font-size:10px; color:var(--text-gray);">0ìŠ¹ 0íŒ¨</div>
        </div>
        <div class="team-box" style="border:1px solid var(--roland-clay); background:rgba(217, 140, 115, 0.10);">
          <div style="font-size:11px; color:var(--roland-clay); font-weight:bold;">ë³µì‹ ë¼ì´ë²Œ2(ì²œì 2)</div>
          <div id="res-d-enemy2" style="font-size:16px; margin-top:5px;">-</div>
          <div id="res-d-enemy2-sub" style="font-size:10px; color:var(--text-gray);">0ìŠ¹ 0íŒ¨</div>
        </div>
      </div><table class="tour-score-table">
        <thead><tr><th>êµ¬ë¶„</th><th>ìŠ¹ë¥ </th><th>ìŠ¹íŒ¨</th><th>ì´ì </th></tr></thead>
        <tbody id="res-table"></tbody>
        <tfoot id="res-foot"></tfoot>
      </table>

      <div id="advice-box" class="tip-box" style="margin-top:20px; border-radius:16px; padding:15px; color:white;">
        <div id="res-advice">-</div>
      </div>

      <div class="rule-box" style="margin-top:14px;">
        <div class="r-tt"><span class="material-symbols-outlined">receipt_long</span>MatchLog ê¸°ë°˜ ê³„ì‚°</div>
        <div class="r-mini">- ìµœê·¼ í¼: í•´ë‹¹ ì„ ìˆ˜ì˜ MatchLog ìµœì‹  10ê²½ê¸°(W/L)</div>
        <div class="r-mini">- ë‹¨ì‹ ìµœê³ /ìµœì €: <b>ë‹¨ì‹ ìƒëŒ€</b> ì¤‘ ë‚´ ìŠ¹ë¥  ê¸°ì¤€</div>
        <div class="r-mini">- ë³µì‹ íŒŒíŠ¸ë„ˆ: <b>ê°™ì€ í¸</b>ìœ¼ë¡œ ë›´ ì‚¬ëŒ ì¤‘ ë‚´ ìŠ¹ë¥ /ìŠ¹ìˆ˜ ìš°ì„ </div>
        <div class="r-mini">- ë³µì‹ ì²œì : <b>ìƒëŒ€í¸</b>ìœ¼ë¡œ ë§Œë‚œ ì‚¬ëŒ ì¤‘ ë‚´ ìŠ¹ë¥  ë‚®ìŒ/í‘œë³¸ ìš°ì„ </div>
      </div>
    </div>

    <div id="welcome-msg" style="text-align:center; padding:50px 0; color:#ccc;">
      <span class="material-symbols-outlined" style="font-size:40px;">query_stats</span><br>ì„ ìˆ˜ë¥¼ í´ë¦­í•˜ë©´ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.
    </div>
  </div>
  <div style="padding: 0 15px;">
    <button class="btn-main" onclick="showView('weather')" style="background:var(--text-gray); margin-top:20px;"><span class="material-symbols-outlined" style="font-size:18px; vertical-align:middle; margin-right:5px;">arrow_back</span>ë’¤ë¡œê°€ê¸°</button>
  </div>
</div>

<div id="view-tournament" class="app-screen">
  <div class="section-card" style="display:block;">
    <div class="header-banner"><span class="material-symbols-outlined" style="font-size:32px;">leaderboard</span>GrandSlam Tournament</div>

    <div id="setup-area">
      <div class="tour-section-title" style="display:flex; justify-content:space-between; align-items:center;"><span style="display:flex;align-items:center;gap:4px;"><span class="material-symbols-outlined">group_add</span>ì°¸ê°€ ì„ ìˆ˜ ì„ íƒ (<span id="cnt">0</span>ëª…)</span><button onclick="addOneTimePlayer()" style="font-size:11px; padding:4px 10px; border-radius:20px; border:1px solid var(--aussie-blue); background:var(--aussie-blue); color:white; cursor:pointer; font-weight:600;">+ ë‹¹ì¼ ê²ŒìŠ¤íŠ¸</button></div>
      <div id="pList"></div>

      <div id="manual-team-box" class="manual-team-box" style="display:none;">
        <div class="manual-team-title"><span class="material-symbols-outlined">groups</span>ì§€ì • íŒ€ ë¯¸ë¦¬ë³´ê¸°</div>
        <div id="manual-team-list" class="manual-team-list"></div>
      </div>


      <div class="tour-section-title"><span class="material-symbols-outlined">shuffle</span>ë°°ì¹˜ ë°©ì‹</div>
      <div class="opt-row">
        <button class="opt-btn active" onclick="setOpt('mode', 'rank', this)"><span class="material-symbols-outlined">bar_chart</span>ë­í‚¹ ë°˜ì˜</button>
        <button class="opt-btn" onclick="setOpt('mode', 'random', this)"><span class="material-symbols-outlined">shuffle</span>ë¬´ì‘ìœ„</button>
              <button class="opt-btn" onclick="setOpt('mode', 'manual', this)"><span class="material-symbols-outlined">touch_app</span>ì§€ì •ì„ íƒ</button>
      </div>

      <div class="tour-section-title"><span class="material-symbols-outlined">category</span>ê²½ê¸° ì¢…ëª©</div>
      <div class="opt-row">
        <button class="opt-btn active" onclick="setOpt('type', 'single', this)"><span class="material-symbols-outlined">person</span>ë‹¨ì‹ (1vs1)</button>
        <button class="opt-btn" onclick="setOpt('type', 'double', this)"><span class="material-symbols-outlined">groups</span>ë³µì‹ (2vs2)</button>
      </div>

      <button class="btn-main" onclick="makeBracket()"><span class="material-symbols-outlined title-ico">account_tree</span>ëŒ€ì§„í‘œ ìƒì„±í•˜ê¸°</button>

      <div class="rule-box" style="margin-top:14px;">
        <div class="r-tt"><span class="material-symbols-outlined">bug_report</span>v3.4 í† ë„ˆ ë²„íŠ¼ í”½ìŠ¤</div>
        <div class="r-mini">- í•˜ë‹¨ ë„¤ë¹„ ê²¹ì¹¨/í„°ì¹˜ ì”¹í˜ ë°©ì§€: í™”ë©´ padding-bottom í™•ì¥</div>
        <div class="r-mini">- ë²„íŠ¼ í´ë¦­ ì•ˆì •: z-index / pointer-events / touch-action ë³´ê°•</div>
        <div class="r-line r-mini">âœ… v3.41: ë‹¨ì‹ 9ëª… ì´ìƒ â†’ ì˜ˆì„ (8ìœ„ vs 9ìœ„) ìŠ¹ìê°€ 8ê°• ì§„ì…</div>
        <div class="r-line r-mini">âœ… v3.42: í† ë„ˆ ì‹¤ì „ ì»¤ë°‹ ì‹œ â€œì§€ë‚œìˆœìœ„ ìŠ¤ëƒ…ìƒ·â€ ì €ì¥ â†’ ì „ í…Œì´ë¸” â–²â–¼ ì •ìƒ í‘œì‹œ</div>
      </div>
    </div>

    <div id="bracket-section">
      <div class="bracket-title"><span class="material-symbols-outlined">emoji_events</span>ëŒ€ì§„í‘œ</div>
      <div class="bracket-container"><div class="bracket-tree" id="tree-root"></div></div>

      <div id="loser-bench" class="loser-bench">
        <h4>ğŸƒ íŒ¨ì ëŒ€ê¸°ì„ (í´ë¦­í•˜ì—¬ ëŒ€ê¸°íŒ€ì— íˆ¬ì…)</h4>
        <div id="loser-list"></div>
      </div>

      <div class="score-section">
        <div class="tour-section-title">ì‹¤ì‹œê°„ ë­í‚¹</div>
        <div id="rules-display"></div>
        <table class="tour-score-table">
          <thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ìŠ¹/íŒ¨</th><th>ì´ì </th></tr></thead>
          <tbody id="score-tbody"></tbody>
        </table>
      </div>

      <button class="btn-sub sky" style="margin-top:20px;" onclick="resetPage()">ì²˜ìŒë¶€í„° ë‹¤ì‹œ</button>
    </div>
  </div>
  <div style="padding: 0 15px;">
    <button class="btn-main" onclick="showView('game')" style="background:var(--text-gray); margin-top:20px;"><span class="material-symbols-outlined" style="font-size:18px; vertical-align:middle; margin-right:5px;">arrow_back</span>ë’¤ë¡œê°€ê¸°</button>
  </div>
</div>

<div id="view-ladder" class="app-screen">
  <div class="section-card" style="display:block;">
    <div class="header-banner"><span class="material-symbols-outlined">stairs</span>GrandSlam ì‚¬ë‹¤ë¦¬ê²Œì„</div>
    <div id="ladder-setup-view">
      <div style="font-weight:400; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;"><span>1. ì°¸ì—¬ ì„ ìˆ˜ ì„ íƒ (í´ë¦­)</span><button onclick="addOneTimePlayer()" style="font-size:11px; padding:4px 10px; border-radius:20px; border:1px solid var(--aussie-blue); background:var(--aussie-blue); color:white; cursor:pointer; font-weight:600;">+ ë‹¹ì¼ ê²ŒìŠ¤íŠ¸</button></div>
      <div id="ladder-player-pool"></div>
      <div style="font-weight:400; margin-bottom:10px; margin-top:30px;">2. ë²Œì¹™ ì…ë ¥ (ë¯¸ì…ë ¥ ì‹œ 'íŒ¨ìŠ¤')</div>
      <div id="ladder-punish-list"></div>
      <button class="btn-purple-main" onclick="initLadderGame()"><span class="material-symbols-outlined title-ico">stairs</span>ì‚¬ë‹¤ë¦¬ ìƒì„±í•˜ê¸°</button>
    </div>

    <div id="ladder-game-view" style="display:none; text-align:center;">
      <p style="font-size:13px; color:var(--text-gray); margin-bottom:15px;">ì´ë¦„ì„ í´ë¦­í•˜ë©´ ë¶‰ì€ ì„ ì´ ë‚´ë ¤ê°‘ë‹ˆë‹¤!</p>
      <div id="ladder-canvas-wrap"><canvas id="ladderCanvas"></canvas></div>
      <div id="ladder-final-msg" class="congrats-box"><div id="congrats-content"></div></div>
      <button class="btn-purple-main" onclick="resetLadderGame()">ì²˜ìŒë¶€í„° ë‹¤ì‹œ</button>
    </div>
  </div>
  <div style="padding: 0 15px;">
    <button class="btn-main" onclick="showView('game')" style="background:var(--text-gray); margin-top:20px;"><span class="material-symbols-outlined" style="font-size:18px; vertical-align:middle; margin-right:5px;">arrow_back</span>ë’¤ë¡œê°€ê¸°</button>
  </div>
</div>

<!-- ë¼ìš´ë“œ ëª¨ë“œ View -->
<div id="view-round" class="app-screen" style="display:none;">
  <div class="section-card" style="display:block;">
    <div class="header-banner"><span class="material-symbols-outlined" style="font-size:32px;">cached</span>GrandSlam Round</div>

    <div id="round-setup-area">
      <div class="tour-section-title" style="display:flex; justify-content:space-between; align-items:center;"><span style="display:flex;align-items:center;gap:4px;"><span class="material-symbols-outlined">group_add</span>ì°¸ê°€ ì„ ìˆ˜ ì„ íƒ (<span id="round-cnt">0</span>ëª…)</span><button onclick="addOneTimePlayer()" style="font-size:11px; padding:4px 10px; border-radius:20px; border:1px solid var(--aussie-blue); background:var(--aussie-blue); color:white; cursor:pointer; font-weight:600;">+ ë‹¹ì¼ ê²ŒìŠ¤íŠ¸</button></div>
      <div style="border: 2px solid #E5E5EA; border-radius: 15px; padding: 14px; background: white; margin-bottom: 30px;">
        <div id="round-pList"></div>
      </div>

      <div id="round-manual-team-box" class="manual-team-box" style="display:none;">
        <div class="manual-team-title"><span class="material-symbols-outlined">groups</span>ì§€ì • íŒ€ ë¯¸ë¦¬ë³´ê¸°</div>
        <div id="round-manual-team-list" class="manual-team-list"></div>
      </div>

      <div class="tour-section-title" style="margin-top: 30px;"><span class="material-symbols-outlined">shuffle</span>ë°°ì¹˜ ë°©ì‹</div>
      <div class="opt-row">
        <button id="round-opt-rank" class="opt-btn active" onclick="setRoundOpt('rank')"><span class="material-symbols-outlined">leaderboard</span>ë­í‚¹ìˆœ</button>
        <button id="round-opt-random" class="opt-btn" onclick="setRoundOpt('random')"><span class="material-symbols-outlined">shuffle</span>ë¬´ì‘ìœ„</button>
        <button id="round-opt-manual" class="opt-btn" onclick="setRoundOpt('manual')"><span class="material-symbols-outlined">touch_app</span>ì§€ì •ì„ íƒ</button>
      </div>

      <div class="tour-section-title"><span class="material-symbols-outlined">sports_tennis</span>ê²½ê¸° ì¢…ëª©</div>
      <div class="opt-row">
        <button id="round-mode-single" class="opt-btn" onclick="setRoundMode('single')"><span class="material-symbols-outlined">person</span>ë‹¨ì‹</button>
        <button id="round-mode-double" class="opt-btn active" onclick="setRoundMode('double')"><span class="material-symbols-outlined">groups</span>ë³µì‹</button>
      </div>

      <button id="round-gen-btn" class="btn-purple-main" onclick="generateRoundSchedule()" style="opacity:0.6; background:var(--roland-clay);"><span class="material-symbols-outlined title-ico">description</span>ëŒ€ì§„í‘œ ìƒì„±í•˜ê¸°</button>
    </div>

    <div id="round-match-area" style="display:none;">
      <div class="tour-section-title"><span class="material-symbols-outlined">emoji_events</span>ì‹¤ì‹œê°„ ë­í‚¹ (Kimjak Algorithm)</div>
      
      <!-- â­ ì ìˆ˜ ê³„ì‚° ì•ˆë‚´ ì¶”ê°€ -->
      <div class="rule-box" style="margin-bottom:15px;">
        <div class="r-tt"><span class="material-symbols-outlined">calculate</span>ì ìˆ˜ ê³„ì‚° ë°©ì‹</div>
        <div class="r-mini">ğŸ“Š <b>ë¼ìš´ë“œ ë¡œë¹ˆ</b>: ìŠ¹ë¦¬ +3ì (ë‹¨ì‹)/+2ì (ë³µì‹), íŒ¨ë°° -0.5ì (ë‹¨ì‹)/-0.7ì (ë³µì‹), ì°¸ê°€ +1ì </div>
        <div class="r-mini">ğŸ† <b>ë¯¸ë‹ˆ í† ë„ˆë¨¼íŠ¸</b>: ìŠ¹ë¦¬ë‹¹ +1ì , ë¶€ì „ìŠ¹ +1ì </div>
      </div>
      
      <div id="round-rank-table"></div>

      <div class="tour-section-title" style="margin-top:30px;"><span class="material-symbols-outlined">list_alt</span>ëŒ€ì§„í‘œ (ì „ì²´ ë§¤ì¹˜)</div>
      <div id="round-match-list"></div>

      <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn-purple-main" onclick="resetRound()" style="flex:1; background:var(--text-gray);"><span class="material-symbols-outlined title-ico">restart_alt</span>ì´ˆê¸°í™”</button>
        <button id="round-save-btn" class="btn-purple-main" onclick="saveRoundResults()" style="flex:1; opacity:0.6; background:var(--roland-clay);"><span class="material-symbols-outlined title-ico">save</span>ì™„ë£Œ</button>
      </div>
      
      <button id="round-tournament-btn" class="btn-purple-main" onclick="convertRoundToTournament()" style="opacity:0.6; background:var(--roland-clay); margin-top:10px;"><span class="material-symbols-outlined title-ico">tour</span>í† ë„ˆë¨¼íŠ¸ Go</button>
    </div>
  </div>
  <div style="padding: 0 15px;">
    <button class="btn-main" onclick="showView('game')" style="background:var(--text-gray); margin-top:20px;"><span class="material-symbols-outlined" style="font-size:18px; vertical-align:middle; margin-right:5px;">arrow_back</span>ë’¤ë¡œê°€ê¸°</button>
  </div>
</div>


<div id="view-game" class="app-screen" style="display:none;">
  <div class="header-banner"><span class="material-symbols-outlined">sports_tennis</span>Game Hub</div>
  <div style="padding:14px;">
    <div class="section-card active" style="display:block;">
      <div class="sub-rank-title"><span class="material-symbols-outlined" style="vertical-align:middle; font-size:20px; margin-right:5px;">sports_tennis</span>ê²Œì„ ì„ íƒ</div>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
        <button class="btn-purple-main" onclick="showView('record')" style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <span class="material-symbols-outlined">scoreboard</span> ë‹¨ì¼ê²Œì„ (ë‹¨/ë³µ)
        </button>
        <button class="btn-purple-main" onclick="openTournament()" style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <span class="material-symbols-outlined">tour</span> í† ë„ˆë¨¼íŠ¸
        </button>
        <button class="btn-purple-main" onclick="openRound()" style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <span class="material-symbols-outlined">cached</span> ë¼ìš´ë“œ
        </button>
        <button class="btn-purple-main" onclick="openLadder()" style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <span class="material-symbols-outlined">stairs</span> ì‚¬ë‹¤ë¦¬ (ë²ˆì™¸)
        </button>
        <button class="btn-purple-main" onclick="comingSoon('êµë¥˜ì „')" style="display:flex; align-items:center; justify-content:center; gap:8px; background:var(--text-gray);">
          <span class="material-symbols-outlined">handshake</span> êµë¥˜ì „ (4.0 ì˜ˆì •)
        </button>
      </div>
      <p style="margin-top:12px; color:#8E8E93; font-size:12px; line-height:1.4;">
        â€» v3.80: í™ˆ í™”ë©´ ê°œí¸! êµë¥˜ì „ì€ v4.0ì—ì„œ ë³¸ê²© ë„ì….
      </p>
    </div>
  <div style="padding: 0 15px;">
    <button class="btn-main" onclick="showView('weather')" style="background:var(--text-gray); margin-top:20px;"><span class="material-symbols-outlined" style="font-size:18px; vertical-align:middle; margin-right:5px;">arrow_back</span>ë’¤ë¡œê°€ê¸°</button>
  </div>
  </div>
</div>

<div id="view-admin" class="app-screen" style="display:none;">
  <div class="header-banner"><span class="material-symbols-outlined">settings</span>ìš´ì˜</div>
  <div style="padding:14px;">
    <div class="section-card active" style="display:block;">
      <div class="sub-rank-title"><span class="material-symbols-outlined" style="vertical-align:middle; font-size:20px; margin-right:5px;">list_alt</span>ê´€ë¦¬ ë©”ë‰´</div>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
        <button class="btn-purple-main" onclick="checkAdminAndShow('player-mgmt')" style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <span class="material-symbols-outlined">person_search</span> ì„ ìˆ˜ ê´€ë¦¬
        </button>
        <button class="btn-purple-main" onclick="showView('club-mgmt')" style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <span class="material-symbols-outlined">home_work</span> í´ëŸ½ ê´€ë¦¬
        </button>
        <button class="btn-purple-main" onclick="enterTreasurer()" style="display:flex; align-items:center; justify-content:center; gap:8px; background:var(--roland-clay);">
          <span class="material-symbols-outlined">lock</span> ì´ë¬´ ëª¨ë“œ
        </button>
        <button class="btn-purple-main" onclick="comingSoon('ë°ì´í„° ë°±ì—…')" style="display:flex; align-items:center; justify-content:center; gap:8px; background:var(--text-gray);">
          <span class="material-symbols-outlined">cloud_sync</span> ë°ì´í„° ë°±ì—… (ì¶”ê°€ ì˜ˆì •)
        </button>
      </div>
            <p style="margin-top:12px; color:#8E8E93; font-size:12px; line-height:1.4;">
        â€» v3.81: ì´ë¬´ ëª¨ë“œ ì¶”ê°€! (íšŒë¹„Â·ì¬ì •Â·ì½”íŠ¸ê³µì§€Â·ê³µì§€ì‚¬í•­ ê´€ë¦¬)
      </p>
    </div>
  </div>
  <div style="padding: 0 15px;">
    <button class="btn-main" onclick="showView('weather')" style="background:var(--text-gray); margin-top:20px;"><span class="material-symbols-outlined" style="font-size:18px; vertical-align:middle; margin-right:5px;">arrow_back</span>ë’¤ë¡œê°€ê¸°</button>
  </div>
</div>

<!-- âœ… v3.79: í´ëŸ½ ê´€ë¦¬ View -->
<div id="view-club-mgmt" class="app-screen" style="display:none;">
  <div class="header-banner"><span class="material-symbols-outlined">home_work</span>í´ëŸ½ ê´€ë¦¬</div>
  <div style="padding:14px;">
    <div class="section-card active" style="display:block;">
      <div class="sub-rank-title"><span class="material-symbols-outlined">list_alt</span>ë“±ë¡ëœ í´ëŸ½ ëª©ë¡</div>
      <div id="clubManageList"></div>
      <button class="btn-main" onclick="openClubCreate()" style="margin-top:15px; display:flex; align-items:center; justify-content:center; gap:8px;">
        <span class="material-symbols-outlined">add_circle</span>ìƒˆ í´ëŸ½ ì¶”ê°€
      </button>

      <div class="rule-box" style="margin-top:20px;">
        <div class="r-tt"><span class="material-symbols-outlined">info</span>ë‹¤ì¤‘ í´ëŸ½ ì•ˆë‚´</div>
        <div class="r-line">â€¢ ê° í´ëŸ½ì€ <b>ë…ë¦½ëœ Google Sheets</b>ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>
        <div class="r-line">â€¢ ìƒë‹¨ í´ëŸ½ ì…€ë ‰í„°ë¡œ ì–¸ì œë“  í´ëŸ½ì„ ì „í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <div class="r-line">â€¢ í´ëŸ½ ì „í™˜ ì‹œ í•´ë‹¹ í´ëŸ½ì˜ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì§‘ë‹ˆë‹¤.</div>
        <div class="r-line">â€¢ í´ëŸ½ ì‚­ì œ ì‹œ ì•± ë‚´ ë“±ë¡ë§Œ í•´ì œë˜ë©°, <b>Google Sheets ë°ì´í„°ëŠ” ë³´ì¡´</b>ë©ë‹ˆë‹¤.</div>
        <div class="r-line">â€¢ í´ëŸ½ ìƒì„±/ìˆ˜ì •/ì‚­ì œëŠ” <b>ì´ê´„ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</b>ê°€ í•„ìš”í•©ë‹ˆë‹¤.</div>
        <div class="r-line">â€¢ ì´ê´„ ë¹„ë²ˆì€ ëª¨ë“  í´ëŸ½ì˜ ê´€ë¦¬ì ê¸°ëŠ¥ì—ë„ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        <div class="r-line r-mini">v3.80 | ë‹¤ì¤‘ í´ëŸ½ ì‹œìŠ¤í…œ + í™ˆ í™”ë©´ ê°œí¸</div>
      </div>
    </div>
  </div>
  <div style="padding: 0 15px;">
    <button class="btn-main" onclick="showView('admin')" style="background:var(--text-gray); margin-top:20px;"><span class="material-symbols-outlined" style="font-size:18px; vertical-align:middle; margin-right:5px;">arrow_back</span>ë’¤ë¡œê°€ê¸°</button>
  </div>
</div>


<!-- âœ… v3.81: ì´ë¬´ ëª¨ë“œ View -->
<div id="view-treasurer" class="app-screen" style="display:none;">
  <div class="header-banner"><span class="material-symbols-outlined">lock</span>ì´ë¬´ ëª¨ë“œ</div>
  <div style="padding:14px;">

    <!-- PIN ì§„ì… í™”ë©´ -->
    <div id="treasurer-pin-screen" class="section-card active" style="display:block;">
      <div class="treasurer-pin-wrap">
        <span class="material-symbols-outlined" style="font-size:48px; color:var(--wimbledon-sage); display:block; margin-bottom:16px;">lock</span>
        <div style="font-size:15px; color:var(--text-dark); margin-bottom:20px;">ì´ë¬´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
        <input type="password" id="treasurerPinInput" maxlength="10" placeholder="â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')verifyTreasurerPin()" />
        <div style="margin-top:16px; display:flex; gap:10px; justify-content:center;">
          <button class="modal-btn modal-btn-primary" onclick="verifyTreasurerPin()" style="width:100px;">í™•ì¸</button>
          <button class="modal-btn modal-btn-secondary" onclick="showView('admin')" style="width:100px;">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>

    <!-- ì´ë¬´ ë©”ì¸ ë©”ë‰´ -->
    <div id="treasurer-main" style="display:none;">
      <div class="section-card active" style="display:block;">
        <div class="sub-rank-title"><span class="material-symbols-outlined">list_alt</span>ì´ë¬´ ë©”ë‰´</div>
        <div class="treasurer-menu">
          <button class="btn-purple-main" onclick="showTreasurerSection('fee')" style="display:flex; align-items:center; justify-content:center; gap:8px;">
            <span class="material-symbols-outlined">checklist</span> íšŒë¹„ ë‚©ë¶€ í˜„í™©
          </button>
          <button class="btn-purple-main" onclick="showTreasurerSection('finance')" style="display:flex; align-items:center; justify-content:center; gap:8px;">
            <span class="material-symbols-outlined">account_balance</span> ì¬ì • ê´€ë¦¬
          </button>
          <button class="btn-purple-main" onclick="showTreasurerSection('court-mgmt')" style="display:flex; align-items:center; justify-content:center; gap:8px;">
            <span class="material-symbols-outlined">edit_calendar</span> ì½”íŠ¸ ê³µì§€ ê´€ë¦¬
          </button>
          <button class="btn-purple-main" onclick="showTreasurerSection('notice-mgmt')" style="display:flex; align-items:center; justify-content:center; gap:8px;">
            <span class="material-symbols-outlined">campaign</span> ê³µì§€ì‚¬í•­ ê´€ë¦¬
          </button>
        </div>
        <!-- âœ… v3.816: 1ëŒ€2ëŒ€ê²°ìš© í™œì„±í™” í† ê¸€ -->
        <div style="margin-top:20px; padding:15px; background:#f9f9f9; border-radius:14px; border:1px solid #eee;">
          <div style="font-size:13px; font-weight:700; color:var(--text-dark); margin-bottom:8px;">âš™ï¸ í´ëŸ½ ê²Œì„ ì„¤ì •</div>
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
            <div>
              <div style="font-size:13px; color:var(--text-dark); font-weight:400;">[1vs2]ìš© í™œì„±í™”</div>
              <div style="font-size:11px; color:var(--text-gray); margin-top:2px;">ê²Œì„ í’€ì— ê³ ì • ë²„íŠ¼ í‘œì‹œ (ë­í‚¹/í†µê³„ ì œì™¸)</div>
            </div>
            <label id="use1v2Toggle" onclick="toggle1v2()" style="position:relative; display:inline-block; width:48px; height:26px; cursor:pointer;">
              <span id="use1v2Track" style="position:absolute; inset:0; border-radius:13px; background:#ccc; transition:background 0.2s;"></span>
              <span id="use1v2Thumb" style="position:absolute; top:3px; left:3px; width:20px; height:20px; border-radius:50%; background:white; box-shadow:0 1px 3px rgba(0,0,0,0.3); transition:transform 0.2s;"></span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- íšŒë¹„ ë‚©ë¶€ í˜„í™© -->
    <div id="treasurer-fee" style="display:none;">
      <div class="section-card active" style="display:block;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
          <div class="sub-rank-title" style="margin:0;"><span class="material-symbols-outlined">checklist</span>íšŒë¹„ ë‚©ë¶€ í˜„í™©</div>
          <select id="feeYear" onchange="renderFeeTable()" style="padding:8px 12px; border:2px solid #E5E5EA; border-radius:10px; font-size:14px; font-weight:400;">
          </select>
        </div>
        <!-- âœ… v3.81: ì›”íšŒë¹„ ê¸ˆì•¡ + ì™„ë‚©/í•´ì œ ë²„íŠ¼ -->
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
          <span style="font-size:13px; color:var(--text-dark); white-space:nowrap;">ì›”íšŒë¹„</span>
          <input type="number" id="monthlyFeeAmount" class="w-input" placeholder="10000" style="width:100px; padding:8px; text-align:right; font-size:14px;" onchange="saveMonthlyFee()" />
          <span style="font-size:13px; color:var(--text-dark);">ì›</span>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:12px;">
          <button class="crud-btn crud-btn-edit" onclick="feeSetAll('Y','year')" style="padding:8px 10px; font-size:12px;">âœ… ì—°ì™„ë‚©</button>
          <button class="crud-btn crud-btn-edit" onclick="feeSetAll('Y','month')" style="padding:8px 10px; font-size:12px;">âœ… ì›”ì™„ë‚©</button>
          <button class="crud-btn crud-btn-del" onclick="feeSetAll('N','year')" style="padding:8px 10px; font-size:12px;">â†©ï¸ ì—°í•´ì œ</button>
          <button class="crud-btn crud-btn-del" onclick="feeSetAll('N','month')" style="padding:8px 10px; font-size:12px;">â†©ï¸ ì›”í•´ì œ</button>
        </div>
        <div class="fee-table-wrap">
          <table class="fee-table" id="feeTable">
            <thead id="feeHead"></thead>
            <tbody id="feeBody"></tbody>
          </table>
        </div>
        <div style="margin-top:12px; font-size:12px; color:var(--text-gray);">
          âœ… ë‚©ë¶€ì™„ë£Œ &nbsp; âŒ ë¯¸ë‚© &nbsp; | ì…€ í„°ì¹˜ë¡œ ë³€ê²½
        </div>
        <button class="btn-sub sky" onclick="copyFeeStatus()" style="width:100%; margin-top:12px; display:flex; align-items:center; justify-content:center; gap:6px;">
          <span class="material-symbols-outlined" style="font-size:18px;">content_copy</span>ì¹´í†¡ ë³µì‚¬
        </button>
        <button class="btn-sub royal" onclick="showTreasurerMenu()" style="width:100%; margin-top:8px;">â† ì´ë¬´ ë©”ë‰´</button>
      </div>
    </div>

    <!-- ì¬ì • ê´€ë¦¬ -->
    <div id="treasurer-finance" style="display:none;">
      <div class="section-card active" style="display:block;">
        <div class="sub-rank-title"><span class="material-symbols-outlined">account_balance</span>ì¬ì • ê´€ë¦¬</div>
        <div class="finance-tab-row">
          <button class="finance-tab active" id="finTabIncome" onclick="setFinanceTab('income')">ğŸ“¥ ìˆ˜ì…</button>
          <button class="finance-tab" id="finTabExpense" onclick="setFinanceTab('expense')">ğŸ“¤ ì§€ì¶œ</button>
        </div>

        <!-- ì…ë ¥ í¼ -->
        <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
          <input type="date" id="finDate" class="w-input" style="width:auto; flex:1; min-width:120px; padding:10px;" />
          <input type="text" id="finDesc" class="w-input" placeholder="ë‚´ìš©" style="flex:2; min-width:100px; padding:10px;" />
          <input type="number" id="finAmount" class="w-input" placeholder="ê¸ˆì•¡" style="width:100px; padding:10px;" />
          <button class="w-btn" id="btnSearch" style="background:var(--wimbledon-sage); padding:10px 14px;" onclick="addFinanceItem()">
            <span class="material-symbols-outlined" style="font-size:18px;">add</span>
          </button>
        </div>

        <div id="financeListArea"></div>

        <div class="finance-summary" id="financeSummary">
          <div style="display:flex; justify-content:space-around; margin-bottom:10px;">
            <div><div class="fs-label">ì´ ìˆ˜ì…</div><div id="fsTotalIncome" style="color:var(--wimbledon-sage); font-size:18px; margin-top:4px;">0ì›</div></div>
            <div><div class="fs-label">ì´ ì§€ì¶œ</div><div id="fsTotalExpense" style="color:var(--up-red); font-size:18px; margin-top:4px;">0ì›</div></div>
          </div>
          <div style="border-top:2px solid var(--wimbledon-sage); padding-top:10px;">
            <div class="fs-label">ì”ì•¡</div>
            <div class="fs-amount" id="fsBalance">0ì›</div>
          </div>
        </div>

        <button class="btn-sub sky" onclick="copyFinanceStatus()" style="width:100%; margin-top:12px; display:flex; align-items:center; justify-content:center; gap:6px;">
          <span class="material-symbols-outlined" style="font-size:18px;">content_copy</span>ì¹´í†¡ ë³µì‚¬
        </button>
        <button class="btn-sub royal" onclick="showTreasurerMenu()" style="width:100%; margin-top:8px;">â† ì´ë¬´ ë©”ë‰´</button>
      </div>
    </div>

    <!-- ì½”íŠ¸ ê³µì§€ ê´€ë¦¬ -->
    <div id="treasurer-court-mgmt" style="display:none;">
      <div class="section-card active" style="display:block;">
        <div class="sub-rank-title"><span class="material-symbols-outlined">edit_calendar</span>ì½”íŠ¸ ê³µì§€ ê´€ë¦¬</div>

        <!-- ì…ë ¥ í¼ -->
        <div style="background:#f8f8f8; padding:14px; border-radius:14px; margin-bottom:14px;">
          <!-- âœ… v3.81: ì½”íŠ¸ í”„ë¦¬ì…‹ ì…€ë ‰í„° -->
          <div style="margin-bottom:10px;">
            <select id="courtPresetSelect" onchange="applyCourtPreset()" class="w-input" style="width:100%; padding:10px; box-sizing:border-box;">
              <option value="">ğŸ“Œ ì €ì¥ëœ ì½”íŠ¸ ì„ íƒ (ì§ì ‘ ì…ë ¥)</option>
            </select>
          </div>
          <div style="display:flex; gap:8px; margin-bottom:8px;">
            <input type="date" id="courtNoticeDate" class="w-input" style="flex:1; padding:10px;" />
            <input type="text" id="courtNoticeName" class="w-input" placeholder="ì½”íŠ¸ëª…" style="flex:1; padding:10px;" />
          </div>
          <input type="text" id="courtNoticeAddr" class="w-input" placeholder="ì£¼ì†Œ" style="width:100%; padding:10px; margin-bottom:8px; box-sizing:border-box;" />
          <!-- âœ… v3.811: ì‹œê°„ëŒ€+ì½”íŠ¸ë²ˆí˜¸ ìµœëŒ€ 3ì¤„ -->
          <div id="courtSlotRows">
            <div class="court-slot-row" style="display:flex; gap:8px; margin-bottom:6px;">
              <input type="text" class="w-input court-slot-time" placeholder="ì‹œê°„ (ì˜ˆ: 07:00-11:00)" style="flex:1; padding:10px;" />
              <input type="text" class="w-input court-slot-court" placeholder="ì½”íŠ¸ë²ˆí˜¸ (ì˜ˆ: 11,12ë²ˆ)" style="flex:1; padding:10px;" />
            </div>
          </div>
          <button type="button" id="btnAddSlot" onclick="addCourtSlotRow()" style="border:none; background:none; color:var(--aussie-blue); font-size:13px; cursor:pointer; padding:4px 0; margin-bottom:8px;">+ ì‹œê°„ëŒ€ ì¶”ê°€ (ìµœëŒ€ 3ê°œ)</button>
          <button class="btn-main" onclick="addCourtNotice()" style="margin-top:4px; font-size:14px; padding:12px; display:flex; align-items:center; justify-content:center; gap:6px;">
            <span class="material-symbols-outlined" style="font-size:18px;">add_circle</span>ì½”íŠ¸ ê³µì§€ ì¶”ê°€
          </button>
        </div>

        <div id="courtNoticeList"></div>
        <button class="btn-sub royal" onclick="showTreasurerMenu()" style="width:100%; margin-top:12px;">â† ì´ë¬´ ë©”ë‰´</button>
      </div>
    </div>

    <!-- ê³µì§€ì‚¬í•­ ê´€ë¦¬ -->
    <div id="treasurer-notice-mgmt" style="display:none;">
      <div class="section-card active" style="display:block;">
        <div class="sub-rank-title"><span class="material-symbols-outlined">campaign</span>ê³µì§€ì‚¬í•­ ê´€ë¦¬ <span style="font-size:12px; color:var(--text-gray);">(ìµœëŒ€ 5ê°œ)</span></div>

        <!-- ì…ë ¥ í¼ -->
        <div style="background:#f8f8f8; padding:14px; border-radius:14px; margin-bottom:14px;">
          <textarea id="announcementTitle" class="w-input" rows="3" placeholder="ê³µì§€ ë‚´ìš©" style="width:100%; padding:10px; margin-bottom:8px; box-sizing:border-box; resize:vertical; font-family:inherit;"></textarea>
          <label style="display:flex; align-items:center; gap:8px; font-size:14px; color:var(--text-dark); cursor:pointer;">
            <input type="checkbox" id="announcementImportant" style="width:18px; height:18px;" />
            â­ ì¤‘ìš” ê³µì§€
          </label>
          <button class="btn-main" onclick="addAnnouncement()" style="margin-top:10px; font-size:14px; padding:12px; display:flex; align-items:center; justify-content:center; gap:6px;">
            <span class="material-symbols-outlined" style="font-size:18px;">add_circle</span>ê³µì§€ ì¶”ê°€
          </button>
        </div>

        <div id="announcementMgmtList"></div>
        <button class="btn-sub royal" onclick="showTreasurerMenu()" style="width:100%; margin-top:12px;">â† ì´ë¬´ ë©”ë‰´</button>
      </div>
    </div>

  </div>
  <div style="padding: 0 15px;">
    <button class="btn-main" onclick="showView('admin')" style="background:var(--text-gray); margin-top:20px;"><span class="material-symbols-outlined" style="font-size:18px; vertical-align:middle; margin-right:5px;">arrow_back</span>ë’¤ë¡œê°€ê¸°</button>
  </div>
</div>


<script>
  // ========================================
  // CONFIGURATION & GLOBAL VARIABLES
  // ========================================
  
  // âœ… v3.79: ë‹¤ì¤‘ í´ëŸ½ ì‹œìŠ¤í…œ (Master GAS ë°©ì‹)
  // GAS URLì€ í•˜ë‚˜! ëª¨ë“  í´ëŸ½ì´ ê°™ì€ URLë¡œ í†µì‹ , clubIdë¡œ ë¼ìš°íŒ…
  const MASTER_GAS_URL = "https://script.google.com/macros/s/AKfycbwaTBlyZRh6UbxupMkFWDvJtgtU-CeAXipk7cwKzZpyoi23Ua8x_1WkY_lyLXDN2dwytg/exec";
  const ACTIVE_CLUB_KEY = 'grandslam_active_club_v2';
  const MASTER_PIN = "0707"; // ì´ê´„ ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸ (ëª¨ë“  í´ëŸ½ ì ‘ê·¼ ê°€ëŠ¥)
  
  const CLUB_COLORS = ['#5D9C76','#669DB3','#D98C73','#4A6B8A','#C4A55A','#C27C7C','#8B7EB5','#7A9E6D','#6B7B99','#3D5A4E'];

  // í˜„ì¬ í™œì„± í´ëŸ½
  var currentClub = null;
  var clubList = [];
  var masterUnlocked = false; // ë§ˆìŠ¤í„° ì¸ì¦ ìƒíƒœ
  
  // í•˜ìœ„ í˜¸í™˜: ê¸°ì¡´ ì½”ë“œê°€ ì°¸ì¡°í•˜ëŠ” ê¸€ë¡œë²Œ ë³€ìˆ˜
  var GAS_URL = MASTER_GAS_URL;
  var ADMIN_PIN = "0707";

  // âœ… v3.8204: ë§ˆìŠ¤í„° ë¹„ë²ˆ í™•ì¸ - ì»¤ìŠ¤í…€ ëª¨ë‹¬ (prompt ëŒ€ì²´)
  var _masterPinCallback = null;

  function checkMasterPin(callback) {
    if (masterUnlocked) { if(callback) callback(true); return; }
    _masterPinCallback = callback || null;
    const modal = $('clubPinModal');
    // ëª¨ë‹¬ íƒ€ì´í‹€ í…ìŠ¤íŠ¸ ë³€ê²½
    const titleEl = modal.querySelector('div[style*="font-size:15px"]');
    if(titleEl) titleEl.textContent = 'ì´ê´„ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
    modal.dataset.mode = 'master';
    modal.style.display = 'flex';
    $('clubPinInput').value = '';
    setTimeout(() => $('clubPinInput').focus(), 100);
  }

  // âœ… v3.820: ì»¤ìŠ¤í…€ Alert (alert() ëŒ€ì²´)
  var _gsAlertCallback = null;
  function gsAlert(msg, cb) {
    $('gsAlertMsg').textContent = msg;
    $('gsAlertModal').style.display = 'flex';
    _gsAlertCallback = cb || null;
  }
  function gsAlertClose() {
    $('gsAlertModal').style.display = 'none';
    if(_gsAlertCallback) { _gsAlertCallback(); _gsAlertCallback = null; }
  }

  // âœ… v3.820: ì»¤ìŠ¤í…€ Confirm (confirm() ëŒ€ì²´) - ì½œë°± ë°©ì‹
  var _gsConfirmCallback = null;
  function gsConfirm(msg, cb) {
    $('gsConfirmMsg').textContent = msg;
    $('gsConfirmModal').style.display = 'flex';
    _gsConfirmCallback = cb || null;
  }
  function gsConfirmResolve(result) {
    $('gsConfirmModal').style.display = 'none';
    if(_gsConfirmCallback) { _gsConfirmCallback(result); _gsConfirmCallback = null; }
  }

  // âœ… v3.8191: í´ëŸ½ ê´€ë¦¬ì ë¹„ë²ˆ í™•ì¸ - ì»¤ìŠ¤í…€ ëª¨ë‹¬ (prompt ëŒ€ì²´)
  var _clubPinCallback = null;

  function checkClubPin(callback) {
    if (masterUnlocked) { callback(true); return; }
    _clubPinCallback = callback;
    const modal = $('clubPinModal');
    modal.style.display = 'flex';
    $('clubPinInput').value = '';
    setTimeout(() => $('clubPinInput').focus(), 100);
  }

  function confirmClubPin() {
    const input = $('clubPinInput').value;
    const modal = $('clubPinModal');
    const isMasterMode = modal.dataset.mode === 'master';
    modal.style.display = 'none';
    modal.dataset.mode = '';
    $('clubPinInput').value = '';

    // ëª¨ë‹¬ íƒ€ì´í‹€ ì›ë˜ëŒ€ë¡œ ë³µì›
    const titleEl = modal.querySelector('div[style*="font-size:15px"]');
    if(titleEl) titleEl.textContent = 'ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';

    if(isMasterMode) {
      // ë§ˆìŠ¤í„° PIN í™•ì¸
      if(input === MASTER_PIN) { masterUnlocked = true; if(_masterPinCallback) _masterPinCallback(true); }
      else { if(input !== '') gsAlert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!'); if(_masterPinCallback) _masterPinCallback(false); }
      _masterPinCallback = null;
    } else {
      // í´ëŸ½ ê´€ë¦¬ì PIN í™•ì¸
      if(input === MASTER_PIN) { masterUnlocked = true; if(_clubPinCallback) _clubPinCallback(true); }
      else if(input === ADMIN_PIN) { if(_clubPinCallback) _clubPinCallback(true); }
      else { if(input !== '') gsAlert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!'); if(_clubPinCallback) _clubPinCallback(false); }
      _clubPinCallback = null;
    }
  }

  function cancelClubPin() {
    const modal = $('clubPinModal');
    modal.style.display = 'none';
    modal.dataset.mode = '';
    $('clubPinInput').value = '';
    // ëª¨ë‹¬ íƒ€ì´í‹€ ì›ë˜ëŒ€ë¡œ ë³µì›
    const titleEl = modal.querySelector('div[style*="font-size:15px"]');
    if(titleEl) titleEl.textContent = 'ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
    if(_masterPinCallback) { _masterPinCallback(false); _masterPinCallback = null; }
    if(_clubPinCallback) { _clubPinCallback(false); _clubPinCallback = null; }
  }

  // ========================================
  // v3.79: MULTI-CLUB MANAGEMENT (Master GAS)
  // GAS URL í•˜ë‚˜ë¡œ í†µí•©, clubIdë¡œ ë¼ìš°íŒ…
  // ========================================

  function getActiveClubId() {
    return currentClub ? currentClub.clubId : '';
  }

  function loadActiveClubId() {
    return localStorage.getItem(ACTIVE_CLUB_KEY) || '';
  }

  function saveActiveClubId(id) {
    localStorage.setItem(ACTIVE_CLUB_KEY, id || '');
  }

  // GASì—ì„œ í´ëŸ½ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async function fetchClubList() {
    try {
      const url = MASTER_GAS_URL + '?action=listClubs';
      const r = await fetchWithTimeout(url, {}, 12000);
      if (!r.ok) throw new Error('listClubs ì‹¤íŒ¨: ' + r.status);
      const resp = await r.json();
      if (resp.ok && Array.isArray(resp.clubs)) {
        clubList = resp.clubs;
        return clubList;
      }
      throw new Error(resp.error || 'listClubs ì‘ë‹µ ì˜¤ë¥˜');
    } catch(e) {
      console.error('fetchClubList error:', e);
      clubList = [];
      return [];
    }
  }

  async function initClubSystem() {
    // 1) GASì—ì„œ í´ëŸ½ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    await fetchClubList();
    
    // 2) ì €ì¥ëœ í™œì„± í´ëŸ½ ë³µì›
    const savedId = loadActiveClubId();
    const saved = clubList.find(c => c.clubId === savedId);
    const target = saved || clubList.find(c => c.isDefault) || clubList[0];
    
    if (target) {
      activateClub(target, false); // false = syncëŠ” ë‚˜ì¤‘ì—
    }
    updateClubSelectorUI();
  }

  function activateClub(club, doSync) {
    // âœ… v3.818: currentClub ë°”ê¾¸ê¸° ì „ì— ì´ì „ í´ëŸ½ IDë¡œ ë¨¼ì € ì €ì¥ (ë²„ê·¸ ìˆ˜ì •)
    if(currentClub && currentClub.clubId) {
      localStorage.setItem('grandslam_fee_data_' + currentClub.clubId, JSON.stringify(feeData));
    }

    currentClub = club;
    // âœ… v3.8204: localStorage ì €ì¥ê°’ ìš°ì„  ì°¸ì¡° (ë¸Œë¼ìš°ì € ì¬ì‹œì‘ ì‹œì—ë„ ìµœì‹  ë¹„ë²ˆ ìœ ì§€)
    const savedPin = localStorage.getItem('grandslam_admin_pin_' + club.clubId);
    ADMIN_PIN = savedPin || club.adminPin || '0707';
    saveActiveClubId(club.clubId);
    
    updateClubSelectorUI();
    updateClubThemeColor(club.color);
    updateWeatherCityForClub(club);

    // âœ… v3.81: í´ëŸ½ ì „í™˜ ì‹œ ì´ë¬´ ëª¨ë“œ ë¦¬ì…‹
    treasurerUnlocked = false;
    financeData = [];
    feeData = {};
    monthlyFeeAmount = 0;
    // âœ… v3.8191: ìƒˆ í´ëŸ½ feeData + monthlyFeeAmount ì¦‰ì‹œ ë³µì›
    const newCid = club.clubId;
    if(newCid) {
      const savedFeeData = localStorage.getItem('grandslam_fee_data_' + newCid);
      if(savedFeeData) { try { feeData = JSON.parse(savedFeeData); } catch(e) { feeData = {}; } }
      const savedFee = localStorage.getItem('grandslam_monthly_fee_' + newCid);
      if(savedFee) { monthlyFeeAmount = parseInt(savedFee) || 0; }
    }
    // âœ… v3.811: í´ëŸ½ë³„ ì½”íŠ¸/ê³µì§€ ë°ì´í„° ë¶„ë¦¬
    courtNotices = [];
    announcements = [];
    // âœ… v3.8207_2: í´ëŸ½ ì „í™˜ ì‹œ ë‹¹ì¼ ê²ŒìŠ¤íŠ¸ ì´ˆê¸°í™” (ë‹¤ë¥¸ í´ëŸ½ì— ë…¸ì¶œë˜ëŠ” ë²„ê·¸ ìˆ˜ì •)
    oneTimePlayers = [];
    
    if (doSync !== false) {
      players = [];
      matchLog = [];
      try { sync(); } catch(e) { console.error('Club sync error:', e); }
      // âœ… v3.80: í´ëŸ½ ì „í™˜ì‹œ ì½”íŠ¸/ê³µì§€ ë¦¬ë¡œë“œ
      fetchCourtNotices().then(() => loadCourtInfo()).catch(()=>{});
      fetchAnnouncements().then(() => loadNotices()).catch(()=>{});
    }
  }

  function updateClubSelectorUI() {
    const dot = $('clubDot');
    const nameText = $('clubNameText');
    if (!currentClub) return;
    if (dot) dot.style.background = currentClub.color || '#5D9C76';
    if (nameText) nameText.textContent = currentClub.clubName || 'í´ëŸ½ ì—†ìŒ';
  }

  function updateClubThemeColor(color) {
    if (!color) return;
    document.documentElement.style.setProperty('--wimbledon-sage', color);
  }

  function updateWeatherCityForClub(club) {
    const cityInput = $('city');
    const headerBanner = document.querySelector('#view-home .header-banner');
    if (cityInput) cityInput.value = '';
    if (headerBanner && club.cityKo) {
      headerBanner.innerHTML = '<span class="material-symbols-outlined">wb_sunny</span>' + escapeHtml(club.cityKo) + ' ë‚ ì”¨';
    }
  }

  // --- í´ëŸ½ ë“œë¡­ë‹¤ìš´ ---
  function openClubDropdown() {
    renderClubDropdownList();
    $('clubDropdown').classList.add('active');
  }

  function closeClubDropdown() {
    $('clubDropdown').classList.remove('active');
  }

  function renderClubDropdownList() {
    const container = $('clubDropdownList');
    if (!container) return;
    if (clubList.length === 0) {
      container.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:13px;">ë“±ë¡ëœ í´ëŸ½ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    container.innerHTML = clubList.map(function(c) {
      const isActive = currentClub && currentClub.clubId === c.clubId;
      return '<div class="club-item ' + (isActive ? 'active-club' : '') + '" onclick="switchClub(\'' + c.clubId + '\')">' +
        '<span class="club-item-dot" style="background:' + (c.color || '#5D9C76') + '"></span>' +
        '<div class="club-item-info">' +
          '<div class="club-item-name">' + escapeHtml(c.clubName) + (c.isDefault ? ' <span style="font-size:10px;color:#999;">(ê¸°ë³¸)</span>' : '') + '</div>' +
          '<div class="club-item-sub">' + escapeHtml(c.cityKo || c.city || '') + '</div>' +
        '</div>' +
        (isActive ? '<span class="material-symbols-outlined club-item-check">check_circle</span>' : '') +
      '</div>';
    }).join('');
  }

  async function switchClub(clubId) {
    const club = clubList.find(function(c){ return c.clubId === clubId; });
    if (!club) return;
    if (currentClub && currentClub.clubId === clubId) {
      closeClubDropdown();
      return;
    }
    closeClubDropdown();
    gsConfirm('"' + club.clubName + '"(ìœ¼)ë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në°ì´í„°ê°€ ìƒˆë¡œ ë¶ˆëŸ¬ì™€ì§‘ë‹ˆë‹¤.', ok => {
      if(!ok) return;
      activateClub(club, true);
      showView('weather');
    });
  }

  // --- í´ëŸ½ ìƒì„±/ìˆ˜ì • ---
  function openClubCreate() {
    checkMasterPin(ok => {
      if(!ok) return;
      closeClubDropdown();
      $('clubFormTitle').textContent = 'ìƒˆ í´ëŸ½ ì¶”ê°€';
      $('cfName').value = '';
      $('cfPin').value = '';
      $('cfCity').value = '';
      $('cfCityKo').value = '';
      $('cfEditId').value = '';
      renderColorChips('');
      if ($('cfGuideToggle')) $('cfGuideToggle').style.display = 'block';
      if ($('cfGuideBody')) $('cfGuideBody').style.display = 'none';
      if ($('cfGuideArrow')) $('cfGuideArrow').style.transform = '';
      $('clubFormModal').classList.add('active');
    });
  }

  function openClubEdit(clubId) {
    checkMasterPin(ok => {
      if(!ok) return;
      const club = clubList.find(function(c){ return c.clubId === clubId; });
      if (!club) return;
      closeClubDropdown();
      $('clubFormTitle').textContent = 'í´ëŸ½ ìˆ˜ì •';
      $('cfName').value = club.clubName || '';
      $('cfPin').value = club.adminPin || '';
      $('cfCity').value = club.city || '';
      $('cfCityKo').value = club.cityKo || '';
      $('cfEditId').value = club.clubId;
      renderColorChips(club.color || '');
      if ($('cfGuideToggle')) $('cfGuideToggle').style.display = 'none';
      $('clubFormModal').classList.add('active');
    });
  }

  function closeClubForm() {
    $('clubFormModal').classList.remove('active');
  }

  function toggleClubGuide() {
    const body = $('cfGuideBody');
    const arrow = $('cfGuideArrow');
    if (!body) return;
    const isOpen = body.style.display !== 'none';
    body.style.display = isOpen ? 'none' : 'block';
    if (arrow) arrow.style.transform = isOpen ? '' : 'rotate(180deg)';
  }

  function renderColorChips(selectedColor) {
    const row = $('cfColorRow');
    if (!row) return;
    row.innerHTML = CLUB_COLORS.map(function(c) {
      return '<div class="club-color-chip ' + (c === selectedColor ? 'selected' : '') + '" ' +
        'style="background:' + c + '" data-color="' + c + '" ' +
        'onclick="selectClubColor(this)"></div>';
    }).join('');
  }

  function selectClubColor(el) {
    document.querySelectorAll('.club-color-chip').forEach(function(c){ c.classList.remove('selected'); });
    el.classList.add('selected');
  }

  function getSelectedColor() {
    const sel = document.querySelector('.club-color-chip.selected');
    return sel ? (sel.getAttribute('data-color') || CLUB_COLORS[0]) : CLUB_COLORS[0];
  }

  var _clubFormSaving = false; // âœ… ì¤‘ë³µ ì €ì¥ ë°©ì§€
  async function saveClubForm() {
    if (_clubFormSaving) return; // ì´ë¯¸ ì €ì¥ ì¤‘ì´ë©´ ë¬´ì‹œ
    const name = $('cfName').value.trim();
    const pin = String($('cfPin').value.trim());
    const city = $('cfCity').value.trim();
    const cityKo = $('cfCityKo').value.trim();
    const color = getSelectedColor();
    const editId = $('cfEditId').value;

    if (!name) { gsAlert('í´ëŸ½ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    if (!pin) { gsAlert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

    _clubFormSaving = true; // ì ê¸ˆ
    $('loading-overlay').style.display = 'flex';

    try {
      if (editId) {
        // ìˆ˜ì •
        const payload = {
          action: 'updateClub', clubId: editId,
          clubName: name, adminPin: pin,
          city: city || 'Gwangmyeong', cityKo: cityKo || city || 'ë„ì‹œ', color: color
        };
        const r = await fetchWithTimeout(MASTER_GAS_URL, {
          method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        }, 15000);
        const resp = await r.json();
        if (!resp.ok) throw new Error(resp.error || 'ìˆ˜ì • ì‹¤íŒ¨');
        
        // âœ… v3.8204: ë¹„ë²ˆ ë³€ê²½ ì„±ê³µ ì‹œ localStorageì— ì¦‰ì‹œ ì €ì¥ (ë¸Œë¼ìš°ì € ì¬ì‹œì‘ ëŒ€ë¹„)
        localStorage.setItem('grandslam_admin_pin_' + editId, pin);
        await fetchClubList();
        if (currentClub && currentClub.clubId === editId) {
          const updated = clubList.find(function(c){ return c.clubId === editId; });
          if (updated) {
            activateClub(updated, true);
            // activateClub ì´í›„ì— ë®ì–´ì¨ì•¼ ìµœì¢… ë°˜ì˜ë¨
            ADMIN_PIN = pin;
          }
        }
        gsAlert('í´ëŸ½ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');

      } else {
        // ìƒˆ í´ëŸ½ ìƒì„± (ìë™ ì‹œíŠ¸ ìƒì„±!)
        const payload = {
          action: 'createClub', clubName: name, adminPin: pin,
          city: city || 'Gwangmyeong', cityKo: cityKo || city || 'ë„ì‹œ', color: color
        };
        const r = await fetchWithTimeout(MASTER_GAS_URL, {
          method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        }, 20000);
        const resp = await r.json();
        if (!resp.ok) throw new Error(resp.error || 'ìƒì„± ì‹¤íŒ¨');
        
        await fetchClubList();
        gsAlert('"' + name + '" í´ëŸ½ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n(Google Sheetsê°€ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤)', () => {
          if (resp.club) {
            gsConfirm('"' + name + '" í´ëŸ½ìœ¼ë¡œ ë°”ë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', ok => {
              if(!ok) return;
              const newClub = clubList.find(function(c){ return c.clubId === resp.club.clubId; });
              if (newClub) { activateClub(newClub, true); showView('weather'); }
            });
          }
        });
      }
    } catch(e) {
      gsAlert('ì˜¤ë¥˜: ' + e.message);
    } finally {
      $('loading-overlay').style.display = 'none';
      _clubFormSaving = false; // âœ… ì ê¸ˆ í•´ì œ
    }

    closeClubForm();
    renderClubManageList();
  }

  async function deleteClub(clubId) {
    checkMasterPin(async ok => {
      if(!ok) return;
      const club = clubList.find(function(c){ return c.clubId === clubId; });
      if (!club) return;
      if (club.isDefault) { gsAlert('ê¸°ë³¸ í´ëŸ½ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      if (currentClub && currentClub.clubId === clubId) {
        gsAlert('í˜„ì¬ í™œì„±í™”ëœ í´ëŸ½ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në‹¤ë¥¸ í´ëŸ½ìœ¼ë¡œ ì „í™˜ í›„ ì‚­ì œí•´ì£¼ì„¸ìš”.');
        return;
      }
      gsConfirm('"' + club.clubName + '" í´ëŸ½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» ì•± ë‚´ ë“±ë¡ë§Œ í•´ì œë©ë‹ˆë‹¤.\nâ€» Google Sheets ë°ì´í„°ëŠ” ë³´ì¡´ë©ë‹ˆë‹¤.', async ok2 => {
        if(!ok2) return;
        $('loading-overlay').style.display = 'flex';
        try {
          const r = await fetchWithTimeout(MASTER_GAS_URL, {
            method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action: 'deleteClub', clubId: clubId })
          }, 12000);
          const resp = await r.json();
          if (!resp.ok) throw new Error(resp.error || 'ì‚­ì œ ì‹¤íŒ¨');
          await fetchClubList();
          renderClubManageList();
          gsAlert('í´ëŸ½ ë“±ë¡ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch(e) {
          gsAlert('ì˜¤ë¥˜: ' + e.message);
        } finally {
          $('loading-overlay').style.display = 'none';
        }
      });
    });
  }

  // --- í´ëŸ½ ê´€ë¦¬ í™”ë©´ ---
  function renderClubManageList() {
    const container = $('clubManageList');
    if (!container) return;
    if (clubList.length === 0) {
      container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">í´ëŸ½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      return;
    }
    container.innerHTML = clubList.map(function(c) {
      const isActive = currentClub && currentClub.clubId === c.clubId;
      return '<div class="club-card-manage" style="' + (isActive ? 'border-color:' + (c.color || '#5D9C76') + ';' : '') + '">' +
        '<span class="club-manage-dot" style="background:' + (c.color || '#5D9C76') + '"></span>' +
        '<div class="club-manage-info">' +
          '<div class="club-manage-name">' + escapeHtml(c.clubName) +
            (isActive ? ' <span style="font-size:11px;color:var(--wimbledon-sage);">(í™œì„±)</span>' : '') +
            (c.isDefault ? ' <span style="font-size:10px;color:#999;">(ê¸°ë³¸)</span>' : '') + 
          '</div>' +
          '<div class="club-manage-url">' + escapeHtml(c.cityKo || c.city || '') + '</div>' +
        '</div>' +
        '<div class="club-manage-actions">' +
          '<button class="club-manage-btn" style="background:var(--aussie-blue);" onclick="openClubEdit(\'' + c.clubId + '\')">ìˆ˜ì •</button>' +
          (!c.isDefault ? '<button class="club-manage-btn" style="background:var(--roland-clay);" onclick="deleteClub(\'' + c.clubId + '\')">ì‚­ì œ</button>' : '') +
        '</div>' +
      '</div>';
    }).join('');
  }


  // Player & Match Data
  var players = [];      // ì„ ìˆ˜ ëª©ë¡
  var matchLog = [];     // ê²½ê¸° ê¸°ë¡ (MatchLog ëˆ„ì  ê¸°ë°˜ í†µê³„)
  
  // Single Game State
  var mType = 'double';  // ê²½ê¸° íƒ€ì…: 'single' or 'double'
  var hT = [];           // Home Team (ë‹¨ì¼ê²Œì„ìš©)
  var aT = [];           // Away Team (ë‹¨ì¼ê²Œì„ìš©)
  
  // Chart & UI State
  var chart = null;      // Chart.js ì¸ìŠ¤í„´ìŠ¤
  var tabNow = 1;        // í˜„ì¬ íƒ­ ë²ˆí˜¸

  // Practice Mode
  var isPracticeMode = localStorage.getItem('grandslam_practice_mode') || 'real';  // âœ… ê¸°ë³¸ê°’ 'real', localStorage ì—°ë™

  // Admin
  let adminUnlocked = false;
  
  // Round Mode State
  var roundOpt = 'rank';         // ë°°ì¹˜ ë°©ì‹: 'rank', 'random', 'manual'
  var roundMode = 'double';      // ê²½ê¸° ì¢…ëª©: 'single', 'double'
  var roundParticipants = [];    // ì°¸ê°€ì ëª©ë¡ (ë‹¨ì‹: ì„ ìˆ˜ëª…, ë³µì‹: íŒ€ ë°°ì—´)
  var roundMatches = [];         // ì „ì²´ ë§¤ì¹˜ ëª©ë¡
  var roundResults = [];         // ê²½ê¸° ê²°ê³¼ (winnerId, loserId ì €ì¥)
  
  // ========================================
  // HELPER FUNCTIONS
  // ========================================

  const $ = (id) => document.getElementById(id);

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
  }

  // âœ… v3.692: ê³µí†µ ì„ ìˆ˜ ì˜µì…˜(UI) ìƒì„±ê¸° (checkbox/radio ê³µìš©)
  function createPlayerOption({ inputType, nameAttr, id, value, checked, onClick, labelText, isGuest, showRank, rankText }) {
    const safeValue = escapeHtml(value);
    const checkedAttr = checked ? "checked" : "";
    const onClickAttr = onClick ? `onclick="${onClick}"` : "";
    const guestClass = isGuest ? " guest-label" : "";
    const rankHtml = showRank ? `<span class="p-rank">${escapeHtml(rankText || "")}</span>` : "";
    return `
      <input type="${inputType}" name="${escapeHtml(nameAttr)}" id="${escapeHtml(id)}" class="p-chk" value="${safeValue}" ${checkedAttr} ${onClickAttr}>
      <label for="${escapeHtml(id)}" class="p-label${guestClass}">${labelText}${rankHtml}</label>
    `;
  }


  function displayName(name) {
    return escapeHtml(name);
  }

  function shuffleArray(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // ========================================
  // UTILITY FUNCTIONS
  // ========================================

  async function fetchWithTimeout(url, options = {}, timeoutMs = 12000) {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    try {
      const res = await fetch(url, { ...options, signal: ctrl.signal });
      return res;
    } finally {
      clearTimeout(t);
    }
  }

  function setStatus(html) {
    const el = $('status');
    if (!el) return;
    el.innerHTML = html || '';
  }

  
  function applyAutofit(scopeEl){
    const root = scopeEl || document;
    const cells = root.querySelectorAll('[data-autofit="1"]');
    cells.forEach(el=>{
      if(!el) return;

      el.classList.add('autofit-cell');
      el.classList.remove('wrap-mode');

      const over = (el.scrollWidth > el.clientWidth + 1);
      if(over){
        el.classList.add('wrap-mode'); // 2ì¤„ í—ˆìš© + ê¸€ì ì‚´ì§ ì¶•ì†Œ
      }
    });
  }

  function applyAutofitAllTables(){
    document.querySelectorAll('.tennis-table').forEach(t=>applyAutofit(t));
  }

  
  function normalizeMatchLog(arr) {
    if (!Array.isArray(arr)) return [];
    const norm = arr
      .filter(Boolean)
      .map(x => {
        const home = Array.isArray(x.home) ? x.home
          : (typeof x.home === "string" ? x.home.split(",").map(s=>s.trim()).filter(Boolean) : []);
        const away = Array.isArray(x.away) ? x.away
          : (typeof x.away === "string" ? x.away.split(",").map(s=>s.trim()).filter(Boolean) : []);
        const type = x.type || x.mType || "double";
        const hs = Number(x.hs ?? x.homeScore ?? x.hS ?? 0);
        const as = Number(x.as ?? x.awayScore ?? x.aS ?? 0);
        const winner = x.winner || "";
        const ts = Number(x.ts || x.timestamp || x.time || Date.now());

        // âœ… A unique, stable matchId prevents duplicated appends from inflating stats.
        // Prefer explicit ids if present, otherwise derive a deterministic id from content.
        let id = x.id || x._id || x.matchId || x.mid || "";
        if (!id) {
          const hKey = home.join("|");
          const aKey = away.join("|");
          id = `${ts}-${type}-${hKey}__${aKey}-${hs}-${as}-${winner}`;
        }

        return {
          id,
          ts,
          date: x.date || x.ds || "",
          type,
          home,
          away,
          hs,
          as,
          winner,
          memo: x.memo || ""
        };
      });

    // âœ… Dedupe by id (keep the most recent ts)
    const byId = new Map();
    norm.forEach(m => {
      const prev = byId.get(m.id);
      if (!prev || Number(m.ts) >= Number(prev.ts)) byId.set(m.id, m);
    });

    return Array.from(byId.values()).sort((a,b) => Number(b.ts) - Number(a.ts));
  }


  async function sync() {
    $('loading-overlay').style.display = 'flex';
    setStatus(`<div style="color:#888; font-size:12px; margin-bottom:10px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`);
    try {
      // âœ… v3.79: clubIdë¥¼ ì¿¼ë¦¬ì— í¬í•¨
      const clubParam = getActiveClubId() ? ('&clubId=' + encodeURIComponent(getActiveClubId())) : '';
      const r = await fetchWithTimeout(MASTER_GAS_URL + '?t=' + Date.now() + clubParam, {}, 15000);
      if (!r.ok) throw new Error("GAS GET ì‹¤íŒ¨: " + r.status);
      const data = await r.json();

      if (Array.isArray(data)) {
        players = (data || []).map(ensure);
        matchLog = matchLog || [];
      } else {
        players = (data?.data || data?.players || []).map(ensure);
        matchLog = normalizeMatchLog(data?.matchLog || data?.logs || []);
      }

      // âœ… v3.816: '1ëŒ€2ìš©' â†’ '1ëŒ€2ëŒ€ê²°ìš©' ì´ë¦„ ë§ˆì´ê·¸ë ˆì´ì…˜ (ì˜µì…˜B)
      migrate1v2Names();

      updateSeason();
      updateWeekly();
      if (tabNow === 1) updateChartRange(0);
      renderLadderPlayerPool();
      initTournament();
      renderStatsPlayerList();
      
      setStatus('');

      setTimeout(applyAutofitAllTables, 0);
    } catch (e) {
      setStatus(`<div style="color:#ff3b30; font-size:12px; margin-bottom:10px;">ë°ì´í„° ë™ê¸°í™” ì‹¤íŒ¨ ğŸ˜µâ€ğŸ’«</div>`);
    } finally {
      $('loading-overlay').style.display = 'none';
    }
  }

  // âœ… v3.816: '1ëŒ€2ìš©' â†’ '1ëŒ€2ëŒ€ê²°ìš©' ë§ˆì´ê·¸ë ˆì´ì…˜ í•¨ìˆ˜
  function migrate1v2Names() {
    let changed = false;
    // players ë°°ì—´ì—ì„œ ì´ë¦„ ë³€ê²½
    players.forEach(p => {
      if(p.name === '1ëŒ€2ìš©') {
        p.name = '1ëŒ€2ëŒ€ê²°ìš©';
        changed = true;
      }
    });
    // matchLogì—ì„œ ì´ë¦„ ë³€ê²½
    if(matchLog && matchLog.length > 0) {
      matchLog.forEach(log => {
        ['home','away','winner','loser'].forEach(key => {
          if(Array.isArray(log[key])) {
            log[key] = log[key].map(n => n === '1ëŒ€2ìš©' ? '1ëŒ€2ëŒ€ê²°ìš©' : n);
          } else if(log[key] === '1ëŒ€2ìš©') {
            log[key] = '1ëŒ€2ëŒ€ê²°ìš©';
            changed = true;
          }
        });
      });
    }
    // ë³€ê²½ëìœ¼ë©´ ì„œë²„ì— push (ì¡°ìš©íˆ)
    if(changed) {
      console.log('[v3.816] 1ëŒ€2ìš© â†’ 1ëŒ€2ëŒ€ê²°ìš© ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ, ì„œë²„ ì €ì¥ ì¤‘...');
      pushPayload({ action: "save", data: players, matchLogAppend: [] }).catch(e => console.warn('migrate push error:', e));
    }
  }

  async function pushPayload(payload) {
    $('loading-overlay').style.display = 'flex';
    setStatus(`<div style="color:#888; font-size:12px; margin-bottom:10px;">ì €ì¥ ì¤‘...</div>`);
    try {
      // âœ… v3.79: clubIdë¥¼ payloadì— í¬í•¨
      if (getActiveClubId()) payload.clubId = getActiveClubId();
      const r = await fetchWithTimeout(MASTER_GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      }, 15000);
      if (!r.ok) throw new Error("GAS POST ì‹¤íŒ¨: " + r.status);

      let resp = null;
      try { resp = await r.json(); } catch(_) {}
      if (resp && typeof resp === "object") {
        if (Array.isArray(resp.data)) players = resp.data.map(ensure);
        if (Array.isArray(resp.matchLog)) matchLog = normalizeMatchLog(resp.matchLog);
      }
      setStatus('');

      setTimeout(applyAutofitAllTables, 0);

      return true;
    } catch (e) {
      setStatus(`<div style="color:#ff3b30; font-size:12px; margin-bottom:10px;">ì €ì¥ ì‹¤íŒ¨ ğŸ˜µâ€ğŸ’«</div>`);
      return false;
    } finally {
      $('loading-overlay').style.display = 'none';
    }
  }

  async function pushDataOnly() {
    return await pushPayload({ action: "saveDataOnly", data: players });
  }

  async function pushWithMatchLogAppend(logEntries) {
    const arr = Array.isArray(logEntries) ? logEntries : [logEntries];
    return await pushPayload({ action: "save", data: players, matchLogAppend: arr });
  }

  function ensure(p) {
    const fs=['score','wins','losses','last','dScore','dWins','dLosses','lastD','sScore','sWins','sLosses','lastS', 'weekly','wWins','wLosses','wdScore','wsScore','wdWins','wdLosses','wsWins','wsLosses','lastW','lastWD','lastWS'];
    fs.forEach(f=>{ if(p[f]===undefined) p[f]=0; });
    if (p.isGuest === undefined) p.isGuest = false; // íšŒì›/ê²ŒìŠ¤íŠ¸ êµ¬ë¶„ ê¸°ë³¸ê°’
    if(!p.name) p.name = "NONAME";
    return p;
  }

  function tab(n) {
    tabNow = n;
    for (let i = 1; i <= 2; i++) {
      if ($('s' + i)) $('s' + i).style.display = (i == n ? 'block' : 'none');
      if ($('t' + i)) $('t' + i).className = (i == n ? 'tab-btn active' : 'tab-btn');
    }
    if (n == 1) { updateSeason(); updateChartRange(0); }
    if (n == 2) updateWeekly();
    setTimeout(applyAutofitAllTables, 0);
  }

  
  function calcRateByKeys(p, winK, lossK){
    const t = (p[winK]||0) + (p[lossK]||0);
    return t > 0 ? ((p[winK]||0) / t) : 0;
  }

  function computeRanksByScoreOnly(scoreK, winK, lossK){
    const sorted = [...players].sort((a,b) => (b[scoreK]||0) - (a[scoreK]||0) || calcRateByKeys(b,winK,lossK) - calcRateByKeys(a,winK,lossK));
    const ranks = {};
    let currentRank = 1;
    sorted.forEach((p, i) => {
      if(i > 0){
        const prev = sorted[i-1];
        if((p[scoreK]||0) !== (prev[scoreK]||0)) currentRank = i + 1;
      }
      ranks[p.name] = currentRank;
    });
    return ranks;
  }

  function snapshotLastRanks(){
    if(!Array.isArray(players) || players.length === 0) return;

    const maps = {
      last:   computeRanksByScoreOnly('score',  'wins',  'losses'),
      lastD:  computeRanksByScoreOnly('dScore', 'dWins', 'dLosses'),
      lastS:  computeRanksByScoreOnly('sScore', 'sWins', 'sLosses'),
      lastW:  computeRanksByScoreOnly('weekly', 'wWins', 'wLosses'),
      lastWD: computeRanksByScoreOnly('wdScore','wdWins','wdLosses'),
      lastWS: computeRanksByScoreOnly('wsScore','wsWins','wsLosses')
    };

    players.forEach(p=>{
      p.last   = maps.last[p.name]   || p.last   || 0;
      p.lastD  = maps.lastD[p.name]  || p.lastD  || 0;
      p.lastS  = maps.lastS[p.name]  || p.lastS  || 0;
      p.lastW  = maps.lastW[p.name]  || p.lastW  || 0;
      p.lastWD = maps.lastWD[p.name] || p.lastWD || 0;
      p.lastWS = maps.lastWS[p.name] || p.lastWS || 0;
    });
  }

  // round/tournament ë“±ì—ì„œ í˜¸ì¶œí•˜ëŠ” ê³µìš© ì¬ê³„ì‚° í›… (ì˜ˆì „ computeAll() í˜¸í™˜)
  function computeAll() {
    // ì •ì˜ëœ í•¨ìˆ˜ë§Œ ì•ˆì „í•˜ê²Œ ì‹¤í–‰ (ReferenceError/SyntaxError ë°©ì§€)
    if (typeof updateSeason === 'function') updateSeason();
    if (typeof updateWeekly === 'function') updateWeekly();
    if (typeof updateRankList === 'function') updateRankList();
    if (typeof updateChart === 'function') updateChart();
  }


  function aggregateSeasonForNamesFromLog(nameList){
    const set = new Set(nameList || []);
    const out = {};
    (nameList||[]).forEach(n=>{
      out[n]={score:0,wins:0,losses:0,dScore:0,dWins:0,dLosses:0,sScore:0,sWins:0,sLosses:0};
    });
    (matchLog||[]).forEach(m=>{
      const type = (m.type||"double");
      const winner = m.winner || "";
      const home = Array.isArray(m.home) ? m.home : [];
      const away = Array.isArray(m.away) ? m.away : [];

      const applyOne = (name, isHomeSide) => {
        if(!set.has(name)) return;
        const isWin = (winner === (isHomeSide ? "home" : "away"));
        const d = calcDeltas(type, isWin);
        const s = out[name];

        s.score += d.total;
        s.wins += isWin ? 1 : 0;
        s.losses += isWin ? 0 : 1;

        if(type === "double"){
          s.dScore += d.d;
          s.dWins += isWin ? 1 : 0;
          s.dLosses += isWin ? 0 : 1;
        } else {
          s.sScore += d.s;
          s.sWins += isWin ? 1 : 0;
          s.sLosses += isWin ? 0 : 1;
        }
      };

      home.forEach(n=>applyOne(n,true));
      away.forEach(n=>applyOne(n,false));
    });
    return out;
  }

function renderRankTable(tableId, scoreK, winK, lossK, lastK, filterMode) {
    const baseList = (() => {
      if (filterMode === 'guest') {
        // âœ… v3.816: HIDDEN_PLAYERSëŠ” ê²ŒìŠ¤íŠ¸ ë­í‚¹ì—ì„œë„ ì œì™¸
        const guests = players.filter(p => p.isGuest && !HIDDEN_PLAYERS.includes(p.name));
        const names = guests.map(p=>p.name);
        const agg = aggregateSeasonForNamesFromLog(names);
        // Merge computed season stats into the current player objects (keeps last-rank fields)
        return guests.map(p => Object.assign({}, p, agg[p.name] || {}));
      }
      if (filterMode === 'all') return [...players];
      // ê¸°ë³¸: ì •ì‹ íšŒì›(ê²ŒìŠ¤íŠ¸ê°€ ì•„ë‹Œ ì„ ìˆ˜)ë§Œ ë­í‚¹ì— í¬í•¨
      return players.filter(p => !p.isGuest);
    })();
    const calcRate = (p) => {
      const t = (p[winK]||0) + (p[lossK]||0);
      return t > 0 ? ((p[winK]||0) / t) : 0;
    };

    const wrSorted = [...baseList].sort((a,b) => calcRate(b) - calcRate(a) || (b[winK]||0) - (a[winK]||0));
    const wrRanks = {};
    let currentWrRank = 1;
    wrSorted.forEach((p, i) => {
      if (i > 0) {
        const prev = wrSorted[i-1];
        if (calcRate(p) !== calcRate(prev)) currentWrRank = i + 1;
      }
      wrRanks[p.name] = currentWrRank;
    });

    const sorted = [...baseList].sort((a,b) => (b[scoreK]||0) - (a[scoreK]||0) || calcRate(b) - calcRate(a));
    const table = $(tableId);

    table.innerHTML = `<thead><tr>
      <th style="width:11%;">ìˆœìœ„</th>
      <th style="width:34%;">ì´ë¦„</th>
      <th style="width:24%;">ìŠ¹ë¥ </th>
      <th style="width:12%;">ìŠ¹/íŒ¨</th>
      <th style="width:19%;">ì´ì </th>
    </tr></thead><tbody></tbody>`;

    let currentRank = 1;
    table.querySelector('tbody').innerHTML = sorted.map((p, i) => {
      if (i > 0) {
        const prev = sorted[i-1];
        if ((p[scoreK]||0) !== (prev[scoreK]||0)) currentRank = i + 1;
      }

      const rankIcon = (currentRank === 1) ? '<span class="material-symbols-outlined rank-1-icon">emoji_events</span>' : currentRank;
      const lastShown = (p[lastK] && Number(p[lastK]) > 0) ? Number(p[lastK]) : currentRank;

      let df =
        (p[lastK] && Number(p[lastK]) > 0 && lastShown !== currentRank)
        ? (lastShown > currentRank ? `<span style="color:var(--up-red)">â–²${lastShown - currentRank}</span>` : `<span style="color:var(--down-blue)">â–¼${currentRank - lastShown}</span>`)
        : '-';

      const shownName = displayName(p.name);
      return `<tr>
        <td>${rankIcon}</td>
        <td style="text-align:left; padding-left:10px; overflow:hidden;">
          <div data-autofit="1" class="autofit-cell" style="display:flex; align-items:center; gap:6px;">
            <span style="font-weight:400; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(shownName)}</span>
            <span data-autofit="1" class="sub-info autofit-cell" style="margin-left:0;">(${lastShown}ìœ„)${df}</span>
          </div>
        </td>
        <td data-autofit="1" class="sub-info autofit-cell">${(calcRate(p)*100).toFixed(1)}% (${wrRanks[p.name]}ìœ„)</td>
        <td style="font-size:11px; white-space:nowrap;">${(p[winK]||0)}/${(p[lossK]||0)}</td>
        <td class="point-text" style="white-space:nowrap;">${Number(p[scoreK]||0).toFixed(1)}</td>
      </tr>`;
    }).join('');

    setTimeout(()=>applyAutofit(table), 0);
  }

  // ========================================
  // RANKING SYSTEM
  // ========================================

  function updateSeason() {
    renderRankTable('seasonTable', 'score', 'wins', 'losses', 'last');
    renderRankTable('seasonDoubleTable', 'dScore', 'dWins', 'dLosses', 'lastD');
    renderRankTable('seasonSingleTable', 'sScore', 'sWins', 'sLosses', 'lastS');
    renderRankTable('guestSeasonTotalTable', 'score', 'wins', 'losses', 'last', 'guest');
    renderRankTable('guestSeasonDoubleTable', 'dScore', 'dWins', 'dLosses', 'lastD', 'guest');
    renderRankTable('guestSeasonSingleTable', 'sScore', 'sWins', 'sLosses', 'lastS', 'guest');
  }

  function updateWeekly() {
    renderRankTable('weeklyTotalTable', 'weekly', 'wWins', 'wLosses', 'lastW');
    renderRankTable('weeklyDoubleTable', 'wdScore', 'wdWins', 'wdLosses', 'lastWD');
    renderRankTable('weeklySingleTable', 'wsScore', 'wsWins', 'wsLosses', 'lastWS');
  }

  function updateChartRange(rangeIdx) {
    document.querySelectorAll('.chart-nav .chart-btn').forEach((b,i) => b.className = i===rangeIdx ? 'chart-btn active' : 'chart-btn');

    const emptyChart = () => {
      if(chart) chart.destroy();
      chart = new Chart($('seasonChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
    };

    // âœ… v3.818: ê²½ê¸° ê¸°ë¡ ì—†ìœ¼ë©´ ë¹ˆ ì°¨íŠ¸
    if (!matchLog || matchLog.length === 0) { emptyChart(); return; }

    // ìœ íš¨í•œ ë‚ ì§œ ëª¨ë‘ ìˆ˜ì§‘ (ì¤‘ë³µ ì œê±°, ì •ë ¬)
    const allDates = [...new Set(
      matchLog
        .filter(m => m.date && m.date.length >= 10)
        .map(m => m.date.slice(0,10))
    )].sort();

    if (allDates.length === 0) { emptyChart(); return; }

    // ë²”ìœ„ë³„ ì›” í•„í„°
    const monthRanges = [[2,3],[4,5],[6,7],[8,9],[10,11],[12,1]];
    const [startMonth, endMonth] = monthRanges[rangeIdx];

    const filteredDates = allDates.filter(d => {
      const m = parseInt(d.slice(5,7));
      return startMonth <= endMonth ? (m >= startMonth && m <= endMonth) : (m >= startMonth || m <= endMonth);
    });

    if (filteredDates.length === 0) { emptyChart(); return; }

    // âœ… v3.818: ë‚ ì§œë³„ ëˆ„ì  ì ìˆ˜ë¡œ ìˆœìœ„ ê³„ì‚°
    const members = players.filter(p => !p.isGuest);
    const colors = ['#FF3B30','#007AFF','#34C759','#FF9500','#AF52DE','#5856D6','#FF2D55','#5AC8FA','#FFCC00'];

    // ê° ì„ ìˆ˜ ëˆ„ì  ì ìˆ˜ ì´ˆê¸°í™”
    const cumScore = {};
    members.forEach(p => { cumScore[p.name] = 0; });

    // matchLogë¥¼ ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
    const sortedLog = [...matchLog].filter(m => m.date && m.date.length >= 10)
      .sort((a,b) => a.date.localeCompare(b.date));

    // ë‚ ì§œë³„ ìˆœìœ„ ìŠ¤ëƒ…ìƒ· { 'YYYY-MM-DD': { ì„ ìˆ˜ëª…: ìˆœìœ„ } }
    const rankSnapshots = {};
    let logIdx = 0;

    allDates.forEach(dateStr => {
      // í•´ë‹¹ ë‚ ì§œê¹Œì§€ì˜ ê²½ê¸° ë°˜ì˜
      while(logIdx < sortedLog.length && sortedLog[logIdx].date.slice(0,10) <= dateStr) {
        const log = sortedLog[logIdx];
        const homeWin = log.winner === 'home';
        const winners = homeWin ? (log.home || []) : (log.away || []);
        const losers  = homeWin ? (log.away || []) : (log.home || []);
        const isDouble = log.type === 'double';
        winners.forEach(n => { if(cumScore[n] !== undefined) cumScore[n] += isDouble ? 3.0 : 4.0; });
        losers.forEach(n  => { if(cumScore[n] !== undefined) cumScore[n] += isDouble ? 0.3 : 0.5; });
        logIdx++;
      }
      // í˜„ì¬ ëˆ„ì  ì ìˆ˜ë¡œ ìˆœìœ„ ê³„ì‚°
      const sorted = [...members].sort((a,b) => (cumScore[b.name]||0) - (cumScore[a.name]||0));
      const snap = {};
      sorted.forEach((p,i) => { snap[p.name] = i + 1; });
      rankSnapshots[dateStr] = snap;
    });

    // í‘œì‹œìš© ë¼ë²¨ (MM/DD)
    const labels = filteredDates.map(d => `${parseInt(d.slice(5,7))}/${parseInt(d.slice(8,10))}`);

    const datasets = members.map((p, i) => ({
      label: p.name,
      data: filteredDates.map(d => rankSnapshots[d] ? (rankSnapshots[d][p.name] || null) : null),
      borderColor: colors[i % colors.length],
      backgroundColor: colors[i % colors.length],
      pointRadius: 5,
      borderWidth: 2,
      spanGaps: true,
      clip: false
    }));

    if(chart) chart.destroy();
    chart = new Chart($('seasonChart').getContext('2d'), {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { top: 50, bottom: 20, left: 10, right: 10 } },
        scales: {
          y: { reverse: true, min: 1, max: Math.max(members.length + 1, 10), ticks: { stepSize: 1, autoSkip: false }, grid: { color: '#eee' } },
          x: { grid: { display: false } }
        },
        plugins: {
          legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8, font: { size: 11 } } }
        }
      }
    });
  }

  
  function nowISO() {
    const d = new Date();
    const ds = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0,10);
    return { ts: d.getTime(), ds };
  }

  function calcDeltas(type, isWin) {
    if (type === "double") return isWin ? { total: 3.0, d: 3.0, s: 0.0 } : { total: 0.3, d: 0.3, s: 0.0 };
    return isWin ? { total: 4.0, d: 0.0, s: 4.0 } : { total: 0.5, d: 0.0, s: 0.5 };
  }

  function applyMatchToPlayers(type, homeArr, awayArr, winnerSide) {
    // âœ… v3.8206: ë‹¹ì¼ ê²ŒìŠ¤íŠ¸ëŠ” players ë°°ì—´ì— ì—†ìœ¼ë¯€ë¡œ ìë™ìœ¼ë¡œ ì§‘ê³„ ì œì™¸ë¨
    const homeWin = winnerSide === "home";
    const apply = (ns, isW) => ns.forEach(n => {
      var p = players.find(x=>x.name==n);
      if(!p) return;
      const d = calcDeltas(type, isW);

      p.score += d.total;
      p.wins += isW ? 1 : 0;
      p.losses += isW ? 0 : 1;

      if (type === "double") {
        p.dScore += d.d;
        p.dWins += isW ? 1 : 0;
        p.dLosses += isW ? 0 : 1;
      } else {
        p.sScore += d.s;
        p.sWins += isW ? 1 : 0;
        p.sLosses += isW ? 0 : 1;
      }

      p.weekly += d.total;
      p.wWins += isW ? 1 : 0;
      p.wLosses += isW ? 0 : 1;

      if (type === "double") {
        p.wdScore += d.d;
        p.wdWins += isW ? 1 : 0;
        p.wdLosses += isW ? 0 : 1;
      } else {
        p.wsScore += d.s;
        p.wsWins += isW ? 1 : 0;
        p.wsLosses += isW ? 0 : 1;
      }
    });

    if(homeWin) { apply(homeArr,true); apply(awayArr,false); }
    else { apply(awayArr,true); apply(homeArr,false); }
  }

  // ========================================
  // SINGLE GAME (ë‹¨ì¼ê²Œì„)
  // ========================================

  async function save() {
    // ì—°ìŠµ ëª¨ë“œ ì²´í¬
    if (isPracticeMode === 'practice') {
      gsAlert("ì§€ê¸ˆì€ ì—°ìŠµ ëª¨ë“œì…ë‹ˆë‹¤! ê¸°ë¡ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ğŸ§ª");
      return;
    }

    var hs=$('hS').value, as=$('aS').value;
    if(!hs || !as || hs==as) { gsAlert("ì ìˆ˜ í™•ì¸!"); return; }

    const max = (mType === 'double') ? 2 : 1;
    if (hT.length !== max || aT.length !== max) { gsAlert("íŒ€ ì„ íƒ ë¨¼ì €!"); return; }

    // âœ… v3.8206: HIDDEN_PLAYERS ì‹¤ì²´í™” (ê¸°ì¡´ í˜¸í™˜ ìœ ì§€)
    [...hT, ...aT].forEach(name => {
      if(HIDDEN_PLAYERS.includes(name) && !players.find(p => p.name === name)) {
        players.push(ensure({ name, isGuest: true }));
      }
    });
    // âœ… v3.8206: ë‹¹ì¼ ê²ŒìŠ¤íŠ¸ëŠ” playersì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ â€” matchLogì—ë§Œ ê¸°ë¡

    snapshotLastRanks();

    const homeScore = parseInt(hs, 10);
    const awayScore = parseInt(as, 10);
    const homeWin = homeScore > awayScore;

    const { ts, ds } = nowISO();
    const logEntry = {
      id: `${ts}-${Math.floor(Math.random()*100000)}`,
      ts,
      date: ds,
      type: mType,
      home: [...hT],
      away: [...aT],
      hs: homeScore,
      as: awayScore,
      winner: homeWin ? "home" : "away"
    };

    applyMatchToPlayers(mType, [...hT], [...aT], logEntry.winner);

    matchLog.unshift(logEntry);
    const ok = await pushWithMatchLogAppend(logEntry);
    if(ok) gsAlert("ì €ì¥!");

    $('hS').value='';
    $('aS').value='';
    hT=[]; aT=[];
    $('hN').innerText='';
    $('aN').innerText='';
    renderPool(); // âœ… v3.811: ì„ ìˆ˜ ì„ íƒ ë²„íŠ¼ ë¦¬ì…‹
    tab(1);
    renderStatsPlayerList();

    setTimeout(applyAutofitAllTables, 0);
  }

  
  // âœ… v3.8204: ì´ë¦„ ìˆ˜ì • ëª¨ë‹¬ í•¨ìˆ˜
  var _gsEditNameCallback = null;
  function gsEditName(defaultVal, cb) {
    $('gsEditNameInput').value = defaultVal || '';
    $('gsEditNameModal').style.display = 'flex';
    _gsEditNameCallback = cb || null;
    setTimeout(() => { $('gsEditNameInput').select(); $('gsEditNameInput').focus(); }, 100);
  }
  function gsEditNameConfirm() {
    const val = $('gsEditNameInput').value;
    $('gsEditNameModal').style.display = 'none';
    if(_gsEditNameCallback) { _gsEditNameCallback(val); _gsEditNameCallback = null; }
  }
  function gsEditNameCancel() {
    $('gsEditNameModal').style.display = 'none';
    _gsEditNameCallback = null;
  }

  function editP(oldName){
    gsEditName(oldName, newName => {
      if(newName && newName.trim() && newName.trim() !== oldName){
        const p = players.find(x => x.name === oldName);
        if(p) {
          p.name = newName.trim();
          matchLog.forEach(l => {
            if(Array.isArray(l.home)) l.home = l.home.map(n => n === oldName ? p.name : n);
            if(Array.isArray(l.away)) l.away = l.away.map(n => n === oldName ? p.name : n);
          });
          pushDataOnly(); updatePlayerList(); renderStatsPlayerList(); gsAlert("ìˆ˜ì • ì™„ë£Œ!");
        }
      }
    });
  }
  function addP(){
    var n=$('pI').value.trim();
    if(n && !players.find(p=>p.name==n)){
      var isGuest = $('pIsGuest') ? $('pIsGuest').checked : false;
      players.push(ensure({name:n, isGuest:isGuest}));
      pushDataOnly();
      $('pI').value='';
      if($('pIsGuest')) $('pIsGuest').checked = false;
      updatePlayerList();
      gsAlert(n + (isGuest ? ' (ê²ŒìŠ¤íŠ¸) ë“±ë¡!' : ' ë“±ë¡!'));
      renderLadderPlayerPool();
      initTournament();
      renderStatsPlayerList();
      setTimeout(applyAutofitAllTables, 0);
    }
  }

  function delP(n){
    checkClubPin(ok => {
      if(!ok) return;
      gsConfirm(n+' ì‚­ì œ?', ok2 => {
        if(!ok2) return;
        players=players.filter(p=>p.name!=n);
        pushDataOnly();
        updatePlayerList();
        renderLadderPlayerPool();
        initTournament();
        renderStatsPlayerList();
        setTimeout(applyAutofitAllTables, 0);
      });
    });
  }

  function toggleGuest(n){
    var p = players.find(x => x.name === n);
    if(!p) return;
    p.isGuest = !p.isGuest;
    pushDataOnly();
    updatePlayerList();
    renderStatsPlayerList();
    gsAlert(p.name + 'ì€(ëŠ”) ì´ì œ ' + (p.isGuest ? 'ê²ŒìŠ¤íŠ¸' : 'íšŒì›') + 'ì…ë‹ˆë‹¤.');
  }

  function renderPool(){
    const members = players.filter(p => !p.isGuest).sort((a, b) => (b.score || 0) - (a.score || 0));
    // âœ… v3.816: HIDDEN_PLAYERS ì œì™¸ (ì¼ë°˜ ê²ŒìŠ¤íŠ¸ë§Œ), 1ëŒ€2ëŒ€ê²°ìš©ì€ ë³„ë„ ì²˜ë¦¬
    const guests = players.filter(p => p.isGuest && !HIDDEN_PLAYERS.includes(p.name));

    // âœ… v3.8206: hint-1v2 ì œê±° (ë‹¹ì¼ê²ŒìŠ¤íŠ¸ ê¸°ëŠ¥ìœ¼ë¡œ ëŒ€ì²´)
    const hint = $('hint-1v2');
    if(hint) hint.style.display = 'none';

    let html = '';

    // 1. ì •ì‹ íšŒì› ì„¹ì…˜
    html += '<div style="font-size:12px; color:#666; margin-bottom:8px; font-weight:bold; text-align:left; padding-left:5px;">ì •ì‹ íšŒì›</div>';
    html += '<div style="display:flex !important; flex-wrap:wrap !important; justify-content:flex-start !important; gap:8px; margin-bottom:20px;">';
    
    members.forEach((p, index) => {
      const isSelected = (window.hT && window.hT.includes(p.name)) || (window.aT && window.aT.includes(p.name));
      const chkId = `pool_p_${index}`;
      html += `<input type="checkbox" id="${chkId}" class="p-chk" value="${escapeHtml(p.name)}" ${isSelected ? 'checked' : ''} onclick="pick('${escapeHtml(p.name).replace(/\'/g,"&#39;")}')">`;
      html += `<label for="${chkId}" class="p-label">${escapeHtml(p.name)}<span class="p-rank">${index+1}ìœ„</span></label>`;
    });
    html += '</div>';

    // 2. ê²ŒìŠ¤íŠ¸ ì„¹ì…˜ (ê²ŒìŠ¤íŠ¸ê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ)
    if (guests.length > 0) {
      html += '<div style="width:100%; margin:10px 0 15px; border-top:1px dashed #ddd; position:relative;">';
      html += '<span style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:#fff; padding:0 10px; font-size:11px; color:#999; font-weight:bold;">GUEST LIST</span>';
      html += '</div>';
      html += '<div style="display:flex !important; flex-wrap:wrap !important; justify-content:flex-start !important; gap:8px;">';
      guests.forEach((p, index) => {
        const isSelected = (window.hT && window.hT.includes(p.name)) || (window.aT && window.aT.includes(p.name));
        const chkId = `pool_g_${index}`;
        html += `<input type="checkbox" id="${chkId}" class="p-chk" value="${escapeHtml(p.name)}" ${isSelected ? 'checked' : ''} onclick="pick('${escapeHtml(p.name).replace(/\'/g,"&#39;")}')">`;
        html += `<label for="${chkId}" class="p-label guest-label">[G] ${escapeHtml(p.name)}</label>`;
      });
      html += '</div>';
    }
    // âœ… v3.8207_1: ë‹¹ì¼ ê²ŒìŠ¤íŠ¸ ì„¹ì…˜ (ê¸°ë³¸ íšŒìƒ‰, ì„ íƒ ì‹œ í˜¸ì£¼ìƒ‰)
    if (oneTimePlayers.length > 0) {
      html += '<div style="width:100%; margin:10px 0 8px; border-top:1px dashed #ddd; position:relative;">';
      html += '<span style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:white; padding:0 10px; font-size:11px; color:var(--aussie-blue); font-weight:bold;">ë‹¹ì¼ ê²ŒìŠ¤íŠ¸</span>';
      html += '</div>';
      html += '<div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:4px;">';
      oneTimePlayers.forEach((name, i) => {
        const isSelected = hT.includes(name) || aT.includes(name);
        const chkId = `pool_ot_${i}`;
        html += `<input type="checkbox" id="${chkId}" class="p-chk" value="${escapeHtml(name)}" ${isSelected ? 'checked' : ''} onclick="pick('${escapeHtml(name).replace(/'/g,"&#39;")}')">`;
        html += `<label for="${chkId}" class="p-label day-guest-label" style="position:relative; padding-right:22px;">[ë‹¹ì¼] ${escapeHtml(name)}<span onclick="event.preventDefault();event.stopPropagation();removeOneTimePlayer('${escapeHtml(name).replace(/'/g,"&#39;")}')" style="position:absolute;right:4px;top:50%;transform:translateY(-50%);font-size:13px;color:#999;cursor:pointer;line-height:1;">âœ•</span></label>`;
      });
      html += '</div>';
    }

    const poolContainer = $('pP');
    if (poolContainer) {
      poolContainer.innerHTML = html;
    }
  }

  function pick(n){
    var max = mType=='double'?2:1;

    // âœ… í† ê¸€: ì´ë¯¸ ì„ íƒëœ ì„ ìˆ˜ë©´ ë‹¤ì‹œ ëˆŒë €ì„ ë•Œ í•´ì œ
    if(hT.includes(n)){
      hT = hT.filter(x => x !== n);
    } else if(aT.includes(n)){
      aT = aT.filter(x => x !== n);
    } else {
      // âœ… ë¹ˆìë¦¬ì—ë§Œ ì¶”ê°€
      if(hT.length < max) hT.push(n);
      else if(aT.length < max) aT.push(n);
      else return;
    }

    $('hN').innerText = hT.map(displayName).join(',');
    $('aN').innerText = aT.map(displayName).join(',');

    // â­ ì„ íƒ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    updateRecordCount();

    // ì„ íƒ UI ë°˜ì˜
    renderPool();
  }

  // â­ ë‹¨ì¼ê²Œì„ ì„ íƒ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateRecordCount() {
    const cnt = $('record-cnt');
    if(cnt) {
      const total = hT.length + aT.length;
      cnt.textContent = total;
    }
  }


  function setM(t){
    mType=t;
    $('m_db').className = t=='double'?'type-btn selected':'type-btn';
    $('m_sg').className = t=='single'?'type-btn selected':'type-btn';
    hT=[]; aT=[];
    $('hN').innerText='';
    $('aN').innerText='';
    
    // â­ ì¹´ìš´íŠ¸ ë¦¬ì…‹
    updateRecordCount();
    // âœ… v3.8201: ë‹¨ì‹/ë³µì‹ ì „í™˜ ì‹œ 1vs2ìš© ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 
    renderPool();
  }

  function updatePlayerList(){
    const members = players.filter(p => !p.isGuest).sort((a,b)=>a.name.localeCompare(b.name));
    const guests = players.filter(p => p.isGuest).sort((a,b)=>a.name.localeCompare(b.name));
    const all = [...members, ...guests];

    let rows = all.map(p => {
      const safeName = escapeHtml(p.name).replace(/'/g,"&#39;");
      const typeLabel = p.isGuest ? '<span style="color:var(--text-gray);">ê²ŒìŠ¤íŠ¸</span>' : 'íšŒì›';
      return `<tr>
        <td style="text-align:left; padding-left:10px; font-weight:400; max-width:none; white-space:nowrap; overflow:visible; text-overflow:clip;">${escapeHtml(displayName(p.name))}</td>
        <td style="text-align:center; font-size:12px; width:50px;">${typeLabel}</td>
        <td style="text-align:right; padding-right:5px; width:140px; white-space:nowrap;">
          <button onclick="editP('${safeName}')" style="background:var(--aussie-blue); color:white; border:none; padding:6px 8px; border-radius:8px; font-size:11px; font-weight:400;">ìˆ˜ì •</button>
          <button onclick="toggleGuest('${safeName}')" style="background:#8E8E93; color:white; border:none; padding:6px 8px; border-radius:8px; font-size:11px; font-weight:400;">êµ¬ë¶„</button>
          <button onclick="delP('${safeName}')" style="background:var(--roland-clay); color:white; border:none; padding:6px 8px; border-radius:8px; font-size:11px; font-weight:400;">ì‚­ì œ</button>
        </td>
      </tr>`;
    }).join('');

    document.querySelector('#pL tbody').innerHTML = rows;
  }

  async function resetScoresKeepPlayers(){
    checkClubPin(async ok => {
      if(!ok) return;
      players.forEach(p=>{
        Object.keys(p).forEach(k=>{
          if(k!=='name' && k!=='isGuest') p[k]=0;
        });
      });
      matchLog = [];
      await pushPayload({ action: "save", data: players, matchLogAppend: [], matchLogReset: true });
      tab(1);
      renderStatsPlayerList();
      setTimeout(applyAutofitAllTables, 0);
    });
  }

  function resetWeeklyOnly(){
    checkClubPin(ok => {
      if(!ok) return;
      players.forEach(p=>{
        ['weekly','wdScore','wsScore','wWins','wLosses','wdWins','wdLosses','wsWins','wsLosses','lastW','lastWD','lastWS'].forEach(f=>p[f]=0);
      });
      pushDataOnly();
      tab(2);
      setTimeout(applyAutofitAllTables, 0);
    });
  }

  async function adminResetAll(){
    checkClubPin(async ok => {
      if(!ok) return;
      gsConfirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°(ì„ ìˆ˜ í¬í•¨)ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async ok2 => {
        if(!ok2) return;
        players=[];
        matchLog=[];
        // âœ… v3.8205_3: GAS adminResetAll + adminPin + confirmText:DELETE ì „ì†¡
        // â€” guardNonEmptyData_ ì•ˆì „ì¥ì¹˜ ìš°íšŒ, wipeAll_() ì§ì ‘ ì‹¤í–‰
        const ok = await pushPayload({
          action: "adminResetAll",
          adminPin: ADMIN_PIN,
          confirmText: "DELETE"
        });
        if(ok) {
          updatePlayerList();
          renderStatsPlayerList();
          renderPool();
          hT=[]; aT=[];
          $('hN').innerText=''; $('aN').innerText='';
          $('hS').value=''; $('aS').value='';
          gsAlert("ì „ì²´ ì‚­ì œ ì™„ë£Œ! âœ…");
        } else {
          gsAlert("ì„œë²„ ì‚­ì œ ì‹¤íŒ¨ ğŸ˜µ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
        }
      });
    });
  }

  function switchView(v, b) {
    document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
    if(b) b.classList.add('active');
    showView(v);
  }

  // ===== v3.5 êµ¬ì¡° ì •ë¦¬: Game/ìš´ì˜ í—ˆë¸Œ =====
  
function checkAdminAndShow(viewName) {
    if (viewName === 'player-mgmt' && !adminUnlocked) {
      checkClubPin(ok => {
        if(!ok) return;
        adminUnlocked = true;
        showView(viewName);
      });
      return;
    }
    showView(viewName);
}
function showView(v){
    // âœ… v3.80: 'weather' í˜¸ì¶œ í•˜ìœ„í˜¸í™˜ â†’ 'home'ìœ¼ë¡œ ì „í™˜
    if(v === 'weather') v = 'home';
    document.querySelectorAll('.app-screen').forEach(el=>el.style.display='none');
    const el = document.getElementById(`view-${v}`);
    if(el) el.style.display='block';
    // subviewsì—ì„œë„ í‘œëŠ” ìë™ ë³´ì •
    setTimeout(applyAutofitAllTables, 0);

    // ê¸°ì¡´ í›… ìœ ì§€
    if(v==='tennis') sync();
    if(v==='player-mgmt') { updatePlayerList();  }
    if(v==='record') renderPool();
    if(v==='ladder') renderLadderPlayerPool();
    if(v==='tournament') initTournament();
    if(v==='stats') renderStatsPlayerList();
  if(v==='round') initRoundPlayerPool();
  if(v==='club-mgmt') renderClubManageList();
  if(v==='home') { loadCourtInfo(); loadNotices(); }
  if(v==='treasurer') { resetTreasurerView(); }
  }

  function openSingleGame(){
    // ë­í‚¹ í™”ë©´ì˜ 'ê²½ê¸°ê¸°ë¡' íƒ­(s3)ë¡œ ë°”ë¡œ ì´ë™
    showView('tennis');
    tab(3);
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function openPlayerManager(){
    // ë­í‚¹ í™”ë©´ì˜ 'ì„ ìˆ˜ê´€ë¦¬' íƒ­(s4)ë¡œ ë°”ë¡œ ì´ë™
    showView('tennis');
    tab(4);
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function openTournament(){ showView('tournament'); window.scrollTo({top:0, behavior:'smooth'}); }
  function openLadder(){ showView('ladder'); window.scrollTo({top:0, behavior:'smooth'}); }

  function comingSoon(name){
    gsAlert(`${name}ì€(ëŠ”) ë‹¤ìŒ ë²„ì „ì—ì„œ ì˜¤í”ˆ!`);
  }

  function toggleTournamentMode() {
    const btn = $('btnTourMode');
    if(isPracticeMode === 'practice') {
      checkClubPin(ok => {
        if(!ok) return;
        isPracticeMode = 'real';
        localStorage.setItem('grandslam_practice_mode', 'real');
        btn.innerText = "ğŸŸ¥ ì‹¤ì „ ëª¨ë“œ (ëª¨ë“  ê¸°ë¡ ë°˜ì˜ O)";
        btn.style.background = "#FF3B30";
        gsAlert("ì‹¤ì „ ëª¨ë“œ ON âœ…\nëª¨ë“  ê²Œì„ ê¸°ë¡ì´ ì •ìƒ ë°˜ì˜ë©ë‹ˆë‹¤!");
      });
    } else {
      isPracticeMode = 'practice';
      localStorage.setItem('grandslam_practice_mode', 'practice');
      btn.innerText = "ğŸŸ© ì „ì²´ ê²Œì„ ì—°ìŠµ ëª¨ë“œ (ê¸°ë¡ë°˜ì˜ X)";
      btn.style.background = "#34C759";
      gsAlert("ì „ì²´ ê²Œì„ ì—°ìŠµ ëª¨ë“œ ON âœ…\në‹¨ì¼ê²Œì„/í† ë„ˆë¨¼íŠ¸ ëª¨ë‘ ê¸°ë¡ì´ ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤!");
    }
  }

  // ========================================
  // TOURNAMENT SYSTEM (í† ë„ˆë¨¼íŠ¸)
  // ========================================
  
  let selected = [];
  let manualPickOrder = [];
  let tMode = 'rank';
  let tType = 'single';
  let pointsData = {};
  let currentBracketSize = 0;

  let tourBuffer = [];
  let tourCommitted = false;

  let singlePrelim = null;
  let pendingSingles = null;

  function initTournament() {
    const members = players.filter(p => !p.isGuest).sort((a,b)=>(b.score||0)-(a.score||0));
    // âœ… v3.816: HIDDEN_PLAYERS ì œì™¸
    const guests = players.filter(p => p.isGuest && !HIDDEN_PLAYERS.includes(p.name));

    let html = '<div style="border: 2px solid #E5E5EA; border-radius: 15px; padding: 15px; background: white; margin-bottom: 30px;">';

    // 1. ì •ì‹ íšŒì› ì„¹ì…˜
    html += '<div style="font-size:12px; color:#666; margin-bottom:8px; font-weight:bold; text-align:left; padding-left:5px;">ì •ì‹ íšŒì›</div>';
    html += '<div style="display:flex !important; flex-wrap:wrap !important; justify-content:flex-start !important; gap:8px; margin-bottom:20px;">';
    members.forEach((p, i) => {
      html += `<input type="checkbox" id="tp${i}" class="p-chk" value="${escapeHtml(p.name)}" onclick="tourPick(this)">`;
      html += `<label for="tp${i}" class="p-label" style="min-width:80px; flex:0 0 auto;">${escapeHtml(p.name)}<span class="p-rank">${i+1}ìœ„</span></label>`;
    });
    html += '</div>';

    // 2. ê²ŒìŠ¤íŠ¸ ì„¹ì…˜ (ê²ŒìŠ¤íŠ¸ê°€ ìˆì„ ë•Œë§Œ ì¶œë ¥, âœ… v3.818: 1ëŒ€2ëŒ€ê²°ìš© ë²„íŠ¼ ì œì™¸)
    if (guests.length > 0) {
      html += '<div style="width:100%; margin:10px 0 15px; border-top:1px dashed #ddd; position:relative;">';
      html += '<span style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:#fff; padding:0 10px; font-size:11px; color:#999; font-weight:bold;">GUEST LIST</span>';
      html += '</div>';

      html += '<div style="display:flex !important; flex-wrap:wrap !important; justify-content:flex-start !important; gap:8px;">';
      guests.forEach((p, i) => {
        html += `<input type="checkbox" id="tgp${i}" class="p-chk" value="${escapeHtml(p.name)}" onclick="tourPick(this)">`;
        html += `<label for="tgp${i}" class="p-label guest-label" style="min-width:80px; flex:0 0 auto;">[G] ${escapeHtml(p.name)}</label>`;
      });
      html += '</div>';
    }

    // âœ… v3.8206: ë‹¹ì¼ ê²ŒìŠ¤íŠ¸ ì„¹ì…˜
    if (oneTimePlayers.length > 0) {
      html += '<div style="width:100%; margin:10px 0 15px; border-top:1px dashed #ddd; position:relative;">';
      html += '<span style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:white; padding:0 10px; font-size:11px; color:var(--aussie-blue); font-weight:bold;">ë‹¹ì¼ ê²ŒìŠ¤íŠ¸</span>';
      html += '</div>';
      html += '<div style="display:flex !important; flex-wrap:wrap !important; justify-content:flex-start !important; gap:8px;">';
      oneTimePlayers.forEach((name, i) => {
        html += `<input type="checkbox" id="tp_ot${i}" class="p-chk" value="${escapeHtml(name)}" onclick="tourPick(this)">`;
        html += `<label for="tp_ot${i}" class="p-label day-guest-label" style="min-width:80px; flex:0 0 auto;">[ë‹¹ì¼] ${escapeHtml(name)}</label>`;
      });
      html += '</div>';
    }
    html += '</div>';
    $('pList').innerHTML = html;
  }



  function tourPick(cb){
    try{
      const name = cb && cb.value;
      if(!name) { upCnt(); return; }

      // âœ… ì§€ì •ì„ íƒ(ë³µì‹)ì¼ ë•Œë§Œ í´ë¦­ ìˆœì„œë¥¼ ê¸°ë¡
      if(tMode === 'manual' && tType === 'double'){
        if(cb.checked){
          if(!manualPickOrder.includes(name)) manualPickOrder.push(name);
        } else {
          manualPickOrder = manualPickOrder.filter(n => n !== name);
        }
      } else {
        // ë‹¤ë¥¸ ëª¨ë“œì—ì„œëŠ” ì²´í¬/í•´ì œì— ë”°ë¼ë§Œ ë™ê¸°í™” (ìˆœì„œ ë°ì´í„°ëŠ” êµ³ì´ ìœ ì§€í•  í•„ìš” ì—†ìŒ)
        if(!cb.checked){
          manualPickOrder = manualPickOrder.filter(n => n !== name);
        }
      }
    } finally {
      upCnt();
      renderManualTeamsPreview();
    }
  }

  function upCnt() {
    const checkedEls = Array.from(document.querySelectorAll('.p-chk:checked'));
    const checked = checkedEls.map(el => el.value);

    if(tMode === 'manual' && tType === 'double'){
      // í´ë¦­ ìˆœì„œëŒ€ë¡œ 2ëª…ì”© íŒ€ì´ ë¬¶ì´ë„ë¡, ì²´í¬ëœ í•­ëª©ì€ manualPickOrder ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
      // (í˜¹ì‹œ ì¤‘ê°„ì— ëˆ„ë½/ì¬ì •ë ¬ì´ ìƒê¸°ë©´ checked ê¸°ë°˜ìœ¼ë¡œ ë³´ì •)
      if(!manualPickOrder.length) manualPickOrder = [...checked];
      const ordered = manualPickOrder.filter(n => checked.includes(n));
      const missing = checked.filter(n => !ordered.includes(n));
      selected = [...ordered, ...missing].map(n => ({ n }));
    } else {
      selected = checked.map(n => ({ n }));
    }

    $('cnt').innerText = selected.length;
  }

  // âœ… v3.693: ì§€ì •ì„ íƒ(ë³µì‹) íŒ€ ë¯¸ë¦¬ë³´ê¸° ë Œë”
  function renderManualTeamsPreview(){
    const box = $('manual-team-box');
    const list = $('manual-team-list');
    if(!box || !list) return;

    // ì§€ì •ì„ íƒ + ë³µì‹ì¼ ë•Œë§Œ ë…¸ì¶œ
    if(!(tMode === 'manual' && tType === 'double')){
      box.style.display = 'none';
      list.innerHTML = '';
      return;
    }

    // í˜„ì¬ ì„ íƒ ìˆœì„œ(ì„ íƒëœ ì„ ìˆ˜ë“¤) ê°€ì ¸ì˜¤ê¸°
    const names = (selected || []).map(x => x.n).filter(Boolean);
    if(!names.length){
      box.style.display = 'none';
      list.innerHTML = '';
      return;
    }

    let html = '';
    let teamNo = 1;
    for(let i=0; i<names.length; i+=2){
      const a = names[i];
      const b = names[i+1];

      const left = escapeHtml(displayName(a));
      const right = b ? escapeHtml(displayName(b)) : '<span class="bye">BYE</span>';

      html += `<div class="team-chip"><span class="chip-no">${teamNo}</span>${left}, ${right}</div>`;
      teamNo++;
    }

    list.innerHTML = html;
    box.style.display = 'block';
  }


  function setOpt(k, v, el) {
    if(k==='mode'){
      tMode = v;
      if(v === 'manual'){
        // âœ… í˜„ì¬ ì²´í¬ëœ ì„ ìˆ˜ë“¤ì„ "ì§€ì •ì„ íƒ" ê¸°ë³¸ ìˆœì„œë¡œ ì„¸íŒ…
        manualPickOrder = Array.from(document.querySelectorAll('.p-chk:checked')).map(el => el.value);
      }
    }
    if(k==='type'){
      tType = v;
      // ë‹¨ì‹ì—ì„œëŠ” ì§€ì •ì„ íƒì„ ê°•ì œí•  ì´ìœ ê°€ ì—†ìœ¼ë‹ˆ, ì„ íƒì€ ìœ ì§€í•˜ë˜ ë™ì‘ì€ ë³µì‹ì—ì„œë§Œ ì ìš©ë¨
    }
    el.parentNode.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    upCnt();
    renderManualTeamsPreview();
  }

  function initPointsAndRules() {
    pointsData = {};
    const rulesDiv = $('rules-display');
    selected.forEach(p => pointsData[p.n] = { score: 1.0, win: 0, loss: 0, finalBonus: 0 });

    if(tType === 'single')
      rulesDiv.innerHTML = `<div style="font-size: 9px; line-height: 1.5; color: #666;">ğŸ¾ <b>ë‹¨ì‹ ì ìˆ˜ (ì‹¤ì œ ê²½ê¸° ê¸°ì¤€)</b><br>- ì°¸ê°€: <b>+1.0</b> (í† ë„ˆë¨¼íŠ¸ë‹¹ 1íšŒ)<br>- ìŠ¹ë¦¬: <b>+3.0</b><br>- íŒ¨ë°°: <b>-0.5</b><br>ğŸ† <b>ì§„ì¶œ ë³´ë„ˆìŠ¤</b>: ìš°ìŠ¹(+3), ì¤€ìš°ìŠ¹(+2), 4ê°•(+1), 8ê°•(+0.5)</div>`;
    else
      rulesDiv.innerHTML = `<div style="font-size: 9px; line-height: 1.5; color: #666;">ğŸ¾ <b>ë³µì‹ ì ìˆ˜ (ì‹¤ì œ ê²½ê¸° ê¸°ì¤€)</b><br>- ì°¸ê°€: <b>+1.0</b> (í† ë„ˆë¨¼íŠ¸ë‹¹ 1íšŒ)<br>- ìŠ¹ë¦¬: <b>+2.0</b><br>- íŒ¨ë°°: <b>-0.5</b><br>ğŸ† <b>ì§„ì¶œ ë³´ë„ˆìŠ¤</b>: ìš°ìŠ¹(+3), ì¤€ìš°ìŠ¹(+2), 4ê°•(+1), 8ê°•(+0.5)</div>`;

    updateScoreBoard();
  }

  function makeBracket() {
    if(tType === 'single' && selected.length < 3) { gsAlert("ìµœì†Œ 3ëª… í•„ìš”!"); return; }
    if(tType === 'double' && selected.length < 4) { gsAlert("ìµœì†Œ 4ëª… í•„ìš”!"); return; }

    tourBuffer = [];
    tourCommitted = false;
    singlePrelim = null;
    pendingSingles = null;

    let pool = [...selected];

    if(tMode === 'rank') {
      let names = pool.map(x=>x.n);
      // âœ… v3.8207: ë‹¹ì¼ ê²ŒìŠ¤íŠ¸(ì„ì‹œì°¸ê°€ì)ëŠ” playersì— ì—†ìœ¼ë¯€ë¡œ ë³„ë„ ë³´ì¡´ í›„ ë’¤ì— ë¶™ì„
      const otNames = names.filter(n => oneTimePlayers.includes(n));
      pool = players
        .filter(p=>names.includes(p.name))
        .sort((a,b)=>(b.score||0)-(a.score||0))
        .map(p=>({n:p.name}));
      otNames.forEach(n => pool.push({n}));
    } else if(tMode === 'random') {
      pool.sort(()=>Math.random()-0.5);
    } else {
      // manual(ì§€ì •ì„ íƒ): í˜„ì¬ ì„ íƒ ìˆœì„œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    }

    let entities = [];

    if(tType === 'single') {
      if (pool.length > 8) {
        const main7 = pool.slice(0, 7);
        const playInA = pool[7];
        const playInB = pool[8];

        singlePrelim = { a: playInA.n, b: playInB.n, done: false };

        entities = [...main7, { n: "?" }];

        pendingSingles = {
          base7: main7.map(x => x.n),
          a: playInA.n,
          b: playInB.n
        };
      } else {
        entities = pool.slice(0, 8);
      }
    } else {
      // âœ… ë³µì‹ íŒ€ êµ¬ì„±
      if(tMode === 'manual'){
        // ì§€ì •ì„ íƒ: í´ë¦­(ì²´í¬)í•œ ìˆœì„œëŒ€ë¡œ 2ëª…ì”© íŒ€ êµ¬ì„±
        for(let i=0; i<pool.length; i+=2){
          const p1 = pool[i];
          const p2 = pool[i+1];
          if(!p1) continue;
          entities.push({ n: p2 ? `${p1.n},${p2.n}` : `${p1.n},BYE` });
        }
      } else {
        // ë­í‚¹ë°˜ì˜/ë¬´ì‘ìœ„: ê¸°ì¡´ ë°©ì‹(ì•/ë’¤ì—ì„œ ì§ì§€ì–´ ê· í˜•)
        let teamCount = Math.ceil(pool.length / 2);
        for(let i=0; i<teamCount; i++){
          let p1 = pool[i];
          let p2 = pool[pool.length-1-i];
          entities.push({ n: (p1===p2) ? `${p1.n},BYE` : `${p1.n},${p2.n}` });
        }
      }
      // BYEëŠ” ë’¤ë¡œ ë³´ë‚´ì„œ ë³´ê¸° ì¢‹ê²Œ ì •ë ¬
      entities.sort((a, b) => (b.n.includes('BYE') ? 1 : 0) - (a.n.includes('BYE') ? 1 : 0));
    }

    initPointsAndRules();

    currentBracketSize = entities.length <= 4 ? 4 : 8;
    let fullList = [...entities];
    while(fullList.length < currentBracketSize) fullList.push({n: 'BYE'});

    let matches =
      currentBracketSize === 4
      ? [{ p1: fullList[0], p2: fullList[3] }, { p1: fullList[1], p2: fullList[2] }]
      : [
          { p1: fullList[0], p2: fullList[7] },
          { p1: fullList[3], p2: fullList[4] },
          { p1: fullList[1], p2: fullList[6] },
          { p1: fullList[2], p2: fullList[5] }
        ];

    renderWingTree(matches);
    $('bracket-section').style.display = 'block';
    $('bracket-section').scrollIntoView({behavior:'smooth'});

    if (tType === 'single' && singlePrelim && !singlePrelim.done) {
      showSinglePrelimUI(singlePrelim.a, singlePrelim.b);
    } else if (tType === 'double') {
      $('loser-bench').style.display = 'block';
      $('loser-bench').querySelector('h4').innerText = 'ğŸƒ íŒ¨ì ëŒ€ê¸°ì„ (í´ë¦­í•˜ì—¬ ëŒ€ê¸°íŒ€ì— íˆ¬ì…)';
      $('loser-list').innerHTML = '<span style="color:#999; font-size:12px;">ê²½ê¸° ê²°ê³¼ ëŒ€ê¸°ì¤‘...</span>';
    } else {
      $('loser-bench').style.display = 'none';
    }

    setTimeout(() => autoResolveByes_FirstRoundOnly(currentBracketSize), 100);
  }

  function autoResolveByes_FirstRoundOnly(size) {
    const startR = (size === 4) ? 2 : 1;
    const matchCount = size / 2;

    for(let i=0; i<matchCount; i++) {
      const m = document.querySelector(`#r${startR}-m${i}`);
      if(!m) continue;
      if(m.classList.contains('final-stage')) continue;

      const t1 = m.querySelector('.team:first-child');
      const t2 = m.querySelector('.team:last-child');
      if(!t1 || !t2) continue;

      const a = (t1.innerText || "").trim();
      const b = (t2.innerText || "").trim();

      if(a.includes('?') || b.includes('?')) continue;

      if(b === 'BYE' && a !== 'BYE') t1.click();
      else if(a === 'BYE' && b !== 'BYE') t2.click();
    }
  }

  function renderWingTree(matches) {
    const root = $('tree-root');
    root.innerHTML = '';
    if(matches.length === 2) {
      root.innerHTML = `
        <div class="column col-left">${getMatchBoxHtml(0, matches[0], 2)}</div>
        <div class="column col-center">
          <div id="final-wrapper" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <div id="champ-display" class="champ-wrapper"><div class="champ-badge">ğŸ† <span id="champ-name"></span> ìš°ìŠ¹!</div></div>
            ${getEmptyBoxHtml(0, 3, true)}
          </div>
        </div>
        <div class="column col-right">${getMatchBoxHtml(1, matches[1], 2)}</div>
      `;
    } else {
      root.innerHTML = `
        <div class="column col-left">
          ${getMatchBoxHtml(0, matches[0], 1)}${getMatchBoxHtml(1, matches[1], 1)}
        </div>
        <div class="column col-semi-left">${getEmptyBoxHtml(0, 2)}</div>
        <div class="column col-center">
          <div id="final-wrapper" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <div id="champ-display" class="champ-wrapper"><div class="champ-badge">ğŸ† <span id="champ-name"></span> ìš°ìŠ¹!</div></div>
            ${getEmptyBoxHtml(0, 3, true)}
          </div>
        </div>
        <div class="column col-semi-right">${getEmptyBoxHtml(1, 2)}</div>
        <div class="column col-right">
          ${getMatchBoxHtml(2, matches[2], 1)}${getMatchBoxHtml(3, matches[3], 1)}
        </div>
      `;
    }
  }

  function getMatchBoxHtml(idx, m, round, isFinal = false) {
    const p1 = escapeHtml(m.p1.n), p2 = escapeHtml(m.p2.n);
    return `<div class="match-box ${isFinal?'final-stage':''}" id="r${round}-m${idx}">
      <div class="team" onclick="win(${round}, ${idx}, 1, '${p1.replace(/'/g,"&#39;")}', this)">${p1}</div>
      <div class="team" onclick="win(${round}, ${idx}, 2, '${p2.replace(/'/g,"&#39;")}', this)">${p2}</div>
    </div>`;
  }

  function getEmptyBoxHtml(idx, round, isFinal = false) {
    return `<div class="match-box ${isFinal?'final-stage':''}" id="r${round}-m${idx}">
      <div class="team no-rank" id="r${round}-m${idx}-t1" style="color:#ccc;">?</div>
      <div class="team no-rank" id="r${round}-m${idx}-t2" style="color:#ccc;">?</div>
    </div>`;
  }

  function parseTeamToPlayers(teamName) {
    const t = String(teamName||"").trim();
    if(!t || t==='BYE' || t.includes('?')) return [];
    return t.split(',').map(s=>s.trim()).filter(x => x && x !== 'BYE' && x !== '?');
  }

  function bufferTournamentMatch(type, teamA, teamB, winnerTeamName) {
    if(teamA === 'BYE' || teamB === 'BYE') return;
    if(teamA.includes('?') || teamB.includes('?')) return;

    const homeArr = parseTeamToPlayers(teamA);
    const awayArr = parseTeamToPlayers(teamB);
    if(homeArr.length === 0 || awayArr.length === 0) return;

    const { ts, ds } = nowISO();
    const winnerSide = (winnerTeamName === teamA) ? "home" : "away";

    tourBuffer.push({
      id: `${ts}-${Math.floor(Math.random()*100000)}`,
      ts,
      date: ds,
      type,
      home: homeArr,
      away: awayArr,
      hs: 0,
      as: 0,
      winner: winnerSide,
      memo: "tournament"
    });
  }

  async function commitTournamentIfNeeded() {
    if (isPracticeMode !== 'real') return;
    if (tourCommitted) return;
    if (!tourBuffer.length) return;

    snapshotLastRanks();

    tourBuffer.forEach(le => {
      applyMatchToPlayers(le.type, le.home, le.away, le.winner);
      matchLog.unshift(le);
    });

    const ok = await pushWithMatchLogAppend(tourBuffer);
    tourCommitted = ok;

    if(ok){
      gsAlert(`í† ë„ˆë¨¼íŠ¸ ê²°ê³¼ ë°˜ì˜ ì™„ë£Œ âœ…\n(ê²½ê¸° ${tourBuffer.length}ê±´ MatchLog ëˆ„ì ë¨)`);
      updateSeason(); updateWeekly();
      renderStatsPlayerList();
      setTimeout(applyAutofitAllTables, 0);
    } else {
      gsAlert("í† ë„ˆë¨¼íŠ¸ ê²°ê³¼ ë°˜ì˜ ì‹¤íŒ¨ ğŸ˜µâ€ğŸ’«\n(ë„¤íŠ¸ì›Œí¬/GAS ìƒíƒœ í™•ì¸ í•„ìš”)");
    }
  }

  function showSinglePrelimUI(a, b) {
    const bench = $('loser-bench');
    const list = $('loser-list');
    if (!bench || !list) return;

    bench.style.display = 'block';
    bench.querySelector('h4').innerText = 'ğŸ¾ ë‹¨ì‹ ì˜ˆì„  (8ìœ„ vs 9ìœ„) â€” ìŠ¹ìë¥¼ í´ë¦­í•˜ë©´ 8ê°• ì§„ì…';
    list.innerHTML = '';

    [a, b].forEach(n => {
      const chip = document.createElement('span');
      chip.className = 'loser-chip';
      chip.innerText = n;
      chip.onclick = function() { resolveSinglePrelim(n); };
      list.appendChild(chip);
    });
  }

  function resolveSinglePrelim(winnerName) {
    if (!singlePrelim || singlePrelim.done) return;
    const a = singlePrelim.a;
    const b = singlePrelim.b;
    const loserName = (winnerName === a) ? b : a;

    if (pointsData[winnerName]) { pointsData[winnerName].score += 3.0; pointsData[winnerName].win++; }
    if (pointsData[loserName])  { pointsData[loserName].score += -0.5; pointsData[loserName].loss++; }

    bufferTournamentMatch('single', a, b, winnerName);

    singlePrelim.done = true;

    if (pendingSingles) {
      const mainNames = [...pendingSingles.base7, winnerName].map(n => ({ n }));
      currentBracketSize = 8;

      let fullList = [...mainNames];
      while(fullList.length < currentBracketSize) fullList.push({ n: 'BYE' });

      const matches = [
        { p1: fullList[0], p2: fullList[7] },
        { p1: fullList[3], p2: fullList[4] },
        { p1: fullList[1], p2: fullList[6] },
        { p1: fullList[2], p2: fullList[5] }
      ];

      renderWingTree(matches);

      $('loser-bench').style.display = 'none';
      $('loser-list').innerHTML = '';
    }

    updateScoreBoard();
  }

  window.win = async function(round, matchIdx, teamIdx, name, el) {
    if(name.includes('BYE')) return;

    const p = el.parentNode;
    if(p.querySelector('.winner')) return;

    const t1El = p.querySelector('.team:first-child');
    const t2El = p.querySelector('.team:last-child');
    const teamA = (t1El?.innerText || "").trim();
    const teamB = (t2El?.innerText || "").trim();

    p.querySelectorAll('.team').forEach(t => t.classList.add('loser'));
    el.classList.remove('loser');
    el.classList.add('winner');

    let loserName = '';
    p.querySelectorAll('.team').forEach(t => { if(t !== el) loserName = (t.innerText || "").trim(); });

    if(tType==='double' && !loserName.includes('BYE') && loserName !== 'BYE') registerLosers(loserName);

    const winEarn = (tType === 'single') ? 3.0 : 2.0;
    const lossEarn = -0.5;

    name.split(',').forEach(pn => {
      if(pointsData[pn]) { pointsData[pn].score += winEarn; pointsData[pn].win++; }
    });

    if(!loserName.includes('BYE') && loserName !== 'BYE') loserName.split(',').forEach(pn => {
      if(pointsData[pn]) { pointsData[pn].score += lossEarn; pointsData[pn].loss++; }
    });

    if(currentBracketSize === 8) {
      if(round === 1) loserName.split(',').forEach(pn => { if(pointsData[pn]) pointsData[pn].finalBonus = 0.5; });
      else if(round === 2) loserName.split(',').forEach(pn => { if(pointsData[pn]) pointsData[pn].finalBonus = 1.0; });
    } else if(currentBracketSize === 4) {
      if(round === 2) loserName.split(',').forEach(pn => { if(pointsData[pn]) pointsData[pn].finalBonus = 1.0; });
    }

    bufferTournamentMatch(tType, teamA, teamB, name);

    if(p.classList.contains('final-stage') || round === 3) {
      $('champ-display').style.display = 'inline-flex';
      $('champ-name').innerText = name;
      name.split(',').forEach(pn => { if(pointsData[pn]) pointsData[pn].finalBonus = 3.0; });
      loserName.split(',').forEach(pn => { if(pointsData[pn]) pointsData[pn].finalBonus = 2.0; });
      updateScoreBoard();
      await commitTournamentIfNeeded();
      return;
    }

    let nr = round + 1, nmi, ntp;
    if(round === 1) {
      nmi = (matchIdx < 2) ? 0 : 1;
      ntp = (matchIdx % 2 === 0) ? 1 : 2;
    } else {
      nmi = 0;
      ntp = (matchIdx === 0) ? 1 : 2;
    }

    const target = $(`r${nr}-m${nmi}-t${ntp}`);
    if(target) {
      target.innerText = name;
      target.style.color = '#1C1C1E';
      target.onclick = function() { win(nr, nmi, ntp, name, this); };
    }

    updateScoreBoard();
  }

  function updateScoreBoard() {
    const sorted = Object.entries(pointsData)
      .filter(([n]) => n !== 'BYE')
      .sort((a, b) => (b[1].score + b[1].finalBonus) - (a[1].score + a[1].finalBonus));
    $('score-tbody').innerHTML = sorted.map(([n, d], i) => `
      <tr><td>${i+1}</td><td>${escapeHtml(n)}</td><td>${d.win}ìŠ¹ ${d.loss}íŒ¨</td><td>${(d.score + d.finalBonus).toFixed(1)}</td></tr>
    `).join('');
  }

  function registerLosers(teamName) {
    if(tType !== 'double') return;
    let listDiv = $('loser-list');
    if(listDiv.innerHTML.includes('ëŒ€ê¸°ì¤‘')) listDiv.innerHTML = '';
    teamName.split(',').forEach(n => {
      if(n === 'BYE') return;
      let chip = document.createElement('span');
      chip.className = 'loser-chip';
      chip.innerText = n;
      chip.onclick = function() { injectPartner(n, this); };
      listDiv.appendChild(chip);
    });
  }

  function injectPartner(name, chipElement) {
    let teams = document.querySelectorAll('.team');
    let found = false;

    for(let t of teams) {
      let txt = (t.innerText || "").trim();
      if(txt.includes(',') && (txt.includes('BYE') || txt.includes('?'))) {
        let newName = txt.replace('BYE', name).replace('?', name).trim();
        t.innerHTML = `<span>${escapeHtml(newName)}</span>`;
        let pId = t.parentNode.id;
        let rd = parseInt(pId.split('-')[0].replace('r','')), mi = parseInt(pId.split('-')[1].replace('m',''));
        let ti = (t === t.parentNode.firstElementChild) ? 1 : 2;
        t.onclick = function() { win(rd, mi, ti, newName, this); };
        chipElement.remove();
        found = true;

        setTimeout(() => autoResolveByes_FirstRoundOnly(currentBracketSize), 50);
        break;
      }
    }
    if(!found) gsAlert("íŒŒíŠ¸ë„ˆë¥¼ ê¸°ë‹¤ë¦¬ëŠ” íŒ€ì´ ì—†ìŠµë‹ˆë‹¤.");
  }

  function resetPage() {
    selected = [];
    pointsData = {};
    tourBuffer = [];
    tourCommitted = false;

    singlePrelim = null;
    pendingSingles = null;

    document.querySelectorAll('.p-chk').forEach(c => c.checked = false);
    $('cnt').innerText = "0";
    $('bracket-section').style.display = 'none';
    $('setup-area').style.display = 'block';
    $('tree-root').innerHTML = '';
    $('loser-list').innerHTML = '';
    $('loser-bench').style.display = 'none';
    $('champ-display').style.display = 'none';
    $('score-tbody').innerHTML = '';
    const v = document.getElementById('view-tournament');
    if(v) v.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  
  // ========================================
  // LADDER GAME (ì‚¬ë‹¤ë¦¬ê²Œì„)
  // ========================================
  
  var ldP = [];
  var ladderLines = [];
  var winHistory = [];
  var finalMapping = [];
  var ladderGap = 0;

  function renderLadderPlayerPool() {
    const members = players.filter(p => !p.isGuest).sort((a,b)=>(b.score||0)-(a.score||0));
    // âœ… v3.816: HIDDEN_PLAYERS ì œì™¸
    const guests = players.filter(p => p.isGuest && !HIDDEN_PLAYERS.includes(p.name));

    let html = '<div style="border: 2px solid #E5E5EA; border-radius: 15px; padding: 15px; background: white; margin-bottom: 30px;">';

    // 1. ì •ì‹ íšŒì› ì„¹ì…˜
    html += '<div style="font-size:12px; color:#666; margin-bottom:8px; font-weight:bold; text-align:left; padding-left:5px;">ì •ì‹ íšŒì›</div>';
    html += '<div style="display:flex !important; flex-wrap:wrap !important; justify-content:flex-start !important; gap:8px; margin-bottom:20px;">';
    members.forEach((p, i) => {
      const chkId = `ladder_p_${i}`;
      const isChecked = ldP.includes(p.name);
      html += `<input type="checkbox" id="${chkId}" class="p-chk" value="${escapeHtml(p.name)}" ${isChecked ? 'checked' : ''} onclick="tkL('${escapeHtml(p.name).replace(/'/g,"&#39;")}')">`;
      html += `<label for="${chkId}" class="p-label" style="min-width:80px; flex:0 0 auto;">${escapeHtml(p.name)}</label>`;
    });
    html += '</div>';

    // 2. ê²ŒìŠ¤íŠ¸ ì„¹ì…˜ (ê²ŒìŠ¤íŠ¸ê°€ ìˆì„ ë•Œë§Œ ì¶œë ¥, âœ… v3.818: 1ëŒ€2ëŒ€ê²°ìš© ë²„íŠ¼ ì œì™¸)
    if (guests.length > 0) {
      html += '<div style="width:100%; margin:10px 0 15px; border-top:1px dashed #ddd; position:relative;">';
      html += '<span style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:#fff; padding:0 10px; font-size:11px; color:#999; font-weight:bold;">GUEST LIST</span>';
      html += '</div>';

      html += '<div style="display:flex !important; flex-wrap:wrap !important; justify-content:flex-start !important; gap:8px;">';
      guests.forEach((p, i) => {
        const chkId = `ladder_g_${i}`;
        const isChecked = ldP.includes(p.name);
        html += `<input type="checkbox" id="${chkId}" class="p-chk" value="${escapeHtml(p.name)}" ${isChecked ? 'checked' : ''} onclick="tkL('${escapeHtml(p.name).replace(/'/g,"&#39;")}')">`;
        html += `<label for="${chkId}" class="p-label guest-label" style="min-width:80px; flex:0 0 auto;">[G] ${escapeHtml(p.name)}</label>`;
      });
      html += '</div>';
    }

    // âœ… v3.8206: ë‹¹ì¼ ê²ŒìŠ¤íŠ¸ ì„¹ì…˜
    if (oneTimePlayers.length > 0) {
      html += '<div style="width:100%; margin:10px 0 15px; border-top:1px dashed #ddd; position:relative;">';
      html += '<span style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:white; padding:0 10px; font-size:11px; color:var(--aussie-blue); font-weight:bold;">ë‹¹ì¼ ê²ŒìŠ¤íŠ¸</span>';
      html += '</div>';
      html += '<div style="display:flex !important; flex-wrap:wrap !important; justify-content:flex-start !important; gap:8px;">';
      oneTimePlayers.forEach((name, i) => {
        const chkId = `ladder_ot_${i}`;
        const isChecked = ldP.includes(name);
        html += `<input type="checkbox" id="${chkId}" class="p-chk" value="${escapeHtml(name)}" ${isChecked ? 'checked' : ''} onclick="tkL('${escapeHtml(name).replace(/'/g,"&#39;")}')">`;
        html += `<label for="${chkId}" class="p-label day-guest-label" style="min-width:80px; flex:0 0 auto;">[ë‹¹ì¼] ${escapeHtml(name)}</label>`;
      });
      html += '</div>';
    }
    html += '</div>';

    $('ladder-player-pool').innerHTML = html;
    $('ladder-punish-list').innerHTML = ldP.map((_, i) => `<input type="text" class="w-input l-punish" placeholder="ë²Œì¹™ ${i+1} (ë¯¸ì…ë ¥ ì‹œ íŒ¨ìŠ¤)">`).join('');
  }


  function tkL(n) {
    ldP.includes(n) ? ldP = ldP.filter(x=>x!==n) : ldP.push(n);
    renderLadderPlayerPool();
  }

  function initLadderGame() {
    if(ldP.length < 2) { gsAlert("ì„ ìˆ˜ë¥¼ ì„ íƒí•´ì¤˜!"); return; }
    finalMapping = Array.from(document.querySelectorAll('.l-punish')).map(i => i.value.trim() || "íŒ¨ìŠ¤").sort(() => Math.random() - 0.5);
    winHistory = [];
    $('ladder-final-msg').style.display = 'none';
    $('ladder-setup-view').style.display = 'none';
    $('ladder-game-view').style.display = 'block';

    const cvs = $('ladderCanvas');
    const ctx = cvs.getContext('2d');
    cvs.width = 600;
    cvs.height = 550;

    ladderGap = (cvs.width - 80) / (ldP.length - 1);
    ladderLines = [];

    for(let r=0; r<12; r++) {
      for(let i=0; i<ldP.length-1; i++) {
        if(Math.random() > 0.45) {
          ladderLines.push({ x: 40 + (i * ladderGap), y: 130 + (r * 30) + (Math.random() * 5), from: i, to: i+1 });
          i++;
        }
      }
    }

    drawLadderBase(ctx, cvs);

    cvs.onclick = (e) => {
      const rect = cvs.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (cvs.width / rect.width);
      const y = (e.clientY - rect.top) * (cvs.height / rect.height);
      if(y < 110) {
        let idx = Math.round((x - 40) / ladderGap);
        if(idx >= 0 && idx < ldP.length && !winHistory.some(w => w.name === ldP[idx])) stL(ctx, idx);
      }
    };
  }

  function drawLadderBase(ctx, cvs) {
    ctx.clearRect(0, 0, cvs.width, cvs.height);
    ctx.strokeStyle = '#ccc';
    ctx.lineWidth = 3;

    ldP.forEach((name, i) => {
      const x = 40 + (i * ladderGap);
      ctx.beginPath();
      ctx.moveTo(x, 80);
      ctx.lineTo(x, 480);
      ctx.stroke();

      ctx.fillStyle = '#1c1c1e';
      ctx.font = '400 16px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(name.substring(0,3), x, 65);

      ctx.fillStyle = finalMapping[i] === "íŒ¨ìŠ¤" ? "#8e8e93" : "#FF3B30";
      ctx.fillText(finalMapping[i], x, 510);
    });

    ctx.beginPath();
    ladderLines.forEach(l => {
      ctx.moveTo(l.x, l.y);
      ctx.lineTo(l.x + ladderGap, l.y);
    });
    ctx.stroke();
  }

  function stL(ctx, sIdx) {
    let cX = sIdx, cY = 80;
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 6;
    const sL = [...ladderLines].sort((a,b) => a.y - b.y);

    const tm = setInterval(() => {
      const absX = 40 + (cX * ladderGap);
      if(cY >= 480) {
        clearInterval(tm);
        const res = finalMapping[cX];
        winHistory.push({ name: ldP[sIdx], result: res });

        if(res !== "íŒ¨ìŠ¤") {
          $('ladder-final-msg').style.display = 'block';
          $('congrats-content').innerHTML = winHistory
            .filter(w => w.result !== "íŒ¨ìŠ¤")
            .map(w => `ğŸ‰ <b>${escapeHtml(w.name)}ë‹˜</b>, <b>${escapeHtml(w.result)}</b> ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ‰`)
            .join('<br>');
        }
        gsAlert(`${ldP[sIdx]}ë‹˜ ê²°ê³¼: ${res}`);
        return;
      }

      let nY = cY + 6, mv = false;
      for(let l of sL) {
        if(l.y > cY && l.y < nY + 2) {
          if(l.from === cX) {
            ctx.beginPath();
            ctx.moveTo(absX, cY);
            ctx.lineTo(absX, l.y);
            ctx.lineTo(absX + ladderGap, l.y);
            ctx.stroke();
            cX++; cY = l.y + 1; mv = true; break;
          } else if(l.to === cX) {
            ctx.beginPath();
            ctx.moveTo(absX, cY);
            ctx.lineTo(absX, l.y);
            ctx.lineTo(absX - ladderGap, l.y);
            ctx.stroke();
            cX--; cY = l.y + 1; mv = true; break;
          }
        }
      }
      if(!mv) {
        ctx.beginPath();
        ctx.moveTo(absX, cY);
        ctx.lineTo(absX, nY);
        ctx.stroke();
        cY = nY;
      }
    }, 15);
  }

  function resetLadderGame() {
    ldP = [];
    winHistory = [];
    $('ladder-setup-view').style.display='block';
    $('ladder-game-view').style.display='none';
    renderLadderPlayerPool();
  }

  // ========================================
  // WEATHER SYSTEM (ë‚ ì”¨) - v3.81: í•œê¸€ ê²€ìƒ‰ ì§€ì›
  // ========================================
  
  // âœ… v3.81: ì¢Œí‘œ ìºì‹œ (ë„ì‹œëª… â†’ ìœ„ë„/ê²½ë„)
  var weatherCoords = { lat: 37.48, lon: 126.86, name: 'ê´‘ëª…' };

  // âœ… v3.79: í´ëŸ½ë³„ Naver ë‚ ì”¨ ë§í¬
  function openNaverWeather() {
    const cityKo = currentClub ? (currentClub.cityKo || 'ê´‘ëª…') : 'ê´‘ëª…';
    window.open('https://search.naver.com/search.naver?query=' + encodeURIComponent(cityKo + ' ë‚ ì”¨'), '_blank');
  }

  // âœ… v3.81: Geocoding APIë¡œ ë„ì‹œëª… â†’ ì¢Œí‘œ ë³€í™˜
  async function geocodeCity(cityName) {
    try {
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=1&language=ko`;
      const r = await fetchWithTimeout(url, {}, 8000);
      if(!r.ok) return null;
      const data = await r.json();
      if(data.results && data.results.length > 0) {
        const res = data.results[0];
        return { lat: res.latitude, lon: res.longitude, name: res.name || cityName };
      }
      return null;
    } catch(e) {
      console.warn('geocodeCity error:', e);
      return null;
    }
  }

  async function loadWeather(d) {
    $('tbl').style.display = "none";
    $('dynamicTip').style.display = "none";
    $("tbody").innerHTML = "";
    setStatus(`<div style="color:#888; font-size:12px; margin-bottom:10px;">ë‚ ì”¨ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`);

    // âœ… v3.8204: ê²€ìƒ‰ì°½ ë¹„ì–´ìˆìœ¼ë©´ club.city fallback ì‚¬ìš©
    const cityInputEl = $('city');
    const cityInput = (cityInputEl && cityInputEl.value.trim()) ? cityInputEl.value.trim() : (currentClub && currentClub.city ? currentClub.city : '');
    if(cityInput && cityInput !== weatherCoords.name) {
      const geo = await geocodeCity(cityInput);
      if(geo) {
        weatherCoords = geo;
        // âœ… v3.817: í—¤ë”ëŠ” cityKo(í•œê¸€) ìš°ì„ , ì—†ìœ¼ë©´ geo.name
        const displayCityName = (currentClub && currentClub.cityKo) ? currentClub.cityKo : geo.name;
        const headerBanner = document.querySelector('#view-home .header-banner');
        if(headerBanner) headerBanner.innerHTML = '<span class="material-symbols-outlined">wb_sunny</span>' + escapeHtml(displayCityName) + ' ë‚ ì”¨';
      } else {
        setStatus(`<div style="color:#ff3b30; font-size:12px; margin-bottom:10px;">"${escapeHtml(cityInput)}" ê²€ìƒ‰ ì‹¤íŒ¨. ê¸°ì¡´ ìœ„ì¹˜ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.</div>`);
      }
    }

    const ds = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0,10);
    $('dateDisplay').innerText = `${ds} ${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()]}ìš”ì¼`;
    $('dateDisplay').style.display = "block";

    try {
      const api = `https://api.open-meteo.com/v1/forecast?latitude=${weatherCoords.lat}&longitude=${weatherCoords.lon}&hourly=temperature_2m,weather_code,precipitation,wind_speed_10m&timezone=Asia/Seoul&start_date=${ds}&end_date=${ds}`;
      const r = await fetchWithTimeout(api, {}, 12000);
      if(!r.ok) throw new Error("Weather API ì‹¤íŒ¨: " + r.status);
      const j = await r.json();
      if(!j || !j.hourly || !Array.isArray(j.hourly.time)) throw new Error("Weather ë°ì´í„° í˜•ì‹ ì´ìƒ");

      const WX = { 0: "â˜€ï¸", 1: "ğŸŒ¤ï¸", 2: "â›…", 3: "â˜ï¸", 45: "ğŸŒ«ï¸", 61: "ğŸŒ¦ï¸", 63: "ğŸŒ§ï¸", 71: "â„ï¸", 80: "ğŸš¿" };
      const wanted = [];
      for (let i=0; i<j.hourly.time.length; i++) {
        const tStr = j.hourly.time[i];
        if(!tStr || typeof tStr !== "string") continue;
        const hhmm = tStr.split("T")[1];
        if(!hhmm) continue;
        const hh = parseInt(hhmm.slice(0,2), 10);
        if(hh >= weatherTimeRange.startH && hh <= weatherTimeRange.endH) wanted.push(i);
      }
      if(wanted.length === 0) throw new Error("05~12ì‹œ ë°ì´í„° ì—†ìŒ");

      let tR = 0, mW = 0, aT = 0;

      wanted.forEach((i) => {
        const timeStr = j.hourly.time[i];
        const hh = timeStr.split("T")[1].slice(0,2);
        const t = j.hourly.temperature_2m?.[i];
        const c = j.hourly.weather_code?.[i];
        const rn = j.hourly.precipitation?.[i];
        const w = j.hourly.wind_speed_10m?.[i];
        if([t,c,rn,w].some(v => v === undefined || v === null)) return;

        tR += rn;
        mW = Math.max(mW, w);
        aT += t;

        const icon = (rn > 0) ? "ğŸŒ¦ï¸" : (WX[c] || "â˜ï¸");
        $("tbody").innerHTML += `<tr><td>${hh}ì‹œ</td><td>${icon}</td><td>${t.toFixed(1)}Â°</td><td>${rn.toFixed(1)}</td><td>${w.toFixed(1)}</td></tr>`;
      });

      const count = $("tbody").querySelectorAll("tr").length;
      if(count === 0) throw new Error("í‘œì— í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŒ");
      aT /= count;

      $("tipContent").innerText =
        (tR > 0) ? "ğŸ’¡ ë¹„ ì†Œì‹! ì‹¤ë‚´ ì½”íŠ¸ ì¶”ì²œ! â˜”"
        : (mW >= 5) ? "ğŸ’¡ ë°”ëŒì´ ì„¸ìš”! ë°”ëŒë§‰ì´ ì¤€ë¹„í•˜ì„¸ìš”!ğŸ’¨"
        : (aT <= 5) ? `ğŸ’¡ í˜„ì¬ ${aT.toFixed(1)}ë„! ì¶”ì›Œìš”. ëœ¨ëˆ ì»¤í”¼ ì±™ê¸°ì„¸ìš”â˜•`
        : "ğŸ’¡ í…Œë‹ˆìŠ¤ ì¹˜ê¸° ë”± ì¢‹ì€ ë‚ ì”¨! ğŸ¾";

      $("dynamicTip").style.display="block";
      $("tbl").style.display="table";
      setStatus('');
    } catch(e) {
      setStatus(`<div style="color:#ff3b30; font-size:12px; margin-bottom:10px;">ë‚ ì”¨ ë¡œë“œ ì‹¤íŒ¨ ğŸ˜µâ€ğŸ’«</div>`);
    }
  }

  function getWed(o) {
    const d = new Date();
    d.setDate(d.getDate() + (3 - d.getDay() + 7) % 7 + o);
    return d;
  }

  // âœ… v3.811: ì½”íŠ¸ ê³µì§€ ê¸°ë°˜ ë‹¤ìŒ ëª¨ì„ ë‚ ì§œ ì°¾ê¸°
  var weatherTimeRange = { startH: 5, endH: 12 };

  function getNextMeetingDates() {
    const today = new Date();
    const todayStr = today.toISOString().slice(0,10);
    
    // ì˜¤ëŠ˜ í¬í•¨ ë¯¸ë˜ ì½”íŠ¸ ê³µì§€ë¥¼ ë‚ ì§œìˆœ ì •ë ¬
    const futureDates = courtNotices
      .map(n => n.date)
      .filter(d => d >= todayStr)
      .sort()
      .filter((v,i,a) => a.indexOf(v) === i); // ì¤‘ë³µ ì œê±°

    return futureDates;
  }

  function loadWeatherForNextMeeting(index) {
    const dates = getNextMeetingDates();
    
    if(dates.length > index) {
      const dateStr = dates[index];
      const d = new Date(dateStr + 'T12:00:00');
      
      // âœ… í•´ë‹¹ ë‚ ì§œì˜ ì½”íŠ¸ ê³µì§€ì—ì„œ ì‹œê°„ëŒ€ íŒŒì‹±
      const dayNotices = courtNotices.filter(n => n.date === dateStr);
      let startH = 5, endH = 12; // ê¸°ë³¸ê°’
      
      if(dayNotices.length > 0) {
        const allSlots = dayNotices.flatMap(n => n.slots || [{time: n.time}]);
        let earliest = 24, latest = 0;
        allSlots.forEach(s => {
          if(!s.time) return;
          const m = s.time.match(/(\d{1,2}):?\d{0,2}\s*[-~]\s*(\d{1,2})/);
          if(m) {
            earliest = Math.min(earliest, parseInt(m[1]));
            latest = Math.max(latest, parseInt(m[2]));
          }
        });
        if(earliest < 24 && latest > 0) {
          startH = Math.max(0, earliest - 3);
          endH = Math.min(23, latest + 1);
        }
      }
      
      weatherTimeRange = { startH, endH };
      loadWeather(d);
    } else {
      // ì½”íŠ¸ ê³µì§€ ì—†ìœ¼ë©´ ê¸°ì¡´ ìˆ˜ìš”ì¼ fallback
      weatherTimeRange = { startH: 5, endH: 12 };
      loadWeather(getWed(index * 7));
    }
    
    if($('btnRefresh')) $('btnRefresh').classList.toggle('active', index === 0);
    if($('btnNext')) $('btnNext').classList.toggle('active', index === 1);
  }

  // ========================================
  // v3.80: HOME - ì½”íŠ¸ ì •ë³´ ì‹œìŠ¤í…œ
  // ========================================

  // ê¸°ë³¸ ì½”íŠ¸ ì •ë³´ (ClubSettingsì—ì„œ ë¡œë“œ ê°€ëŠ¥)
  var defaultCourt = {
    name: "ê´‘ëª…ì‹œë¯¼ì²´ìœ¡ê´€ 3ë²ˆ ì½”íŠ¸",
    address: "ê²½ê¸°ë„ ê´‘ëª…ì‹œ ì˜¤ë¦¬ë¡œ 613",
    time: "07:00 ~ 11:00",
    memo: ""
  };

  // ì½”íŠ¸ ê³µì§€ ë°ì´í„° (GASì—ì„œ ë¡œë“œ)
  var courtNotices = [];
  // ê³µì§€ì‚¬í•­ ë°ì´í„° (GASì—ì„œ ë¡œë“œ)
  var announcements = [];

  function loadCourtInfo() {
    const today = new Date();
    const todayStr = today.toISOString().slice(0,10);
    
    // âœ… v3.811: ì˜¤ëŠ˜ í¬í•¨ ê°€ì¥ ê°€ê¹Œìš´ ë¯¸ë˜ ê³µì§€ ì°¾ê¸°
    const upcoming = courtNotices
      .filter(n => n.date >= todayStr)
      .sort((a,b) => (a.date||'').localeCompare(b.date||''));
    
    const notice = upcoming.length > 0 ? upcoming[0] : null;

    if(notice) {
      $('courtName').textContent = notice.courtName || '';
      // âœ… v3.811: slots ë°°ì—´ ì§€ì›
      const slots = notice.slots || [{time: notice.time, court: notice.memo}];
      const timeText = slots.map(s => s.time || '').filter(Boolean).join(' / ');
      $('courtTime').textContent = timeText || '';
      $('courtAddress').textContent = notice.address || '';
      
      // âœ… v3.816: ì½”íŠ¸ ë²ˆí˜¸ë¥¼ ì‹œê°„ ì˜†ì— ì¸ë¼ì¸ í‘œì‹œ + courtMemoëŠ” ìˆ¨ê¹€
      const courtText = slots.map(s => s.court || '').filter(Boolean).join(', ');
      if(courtText) {
        $('courtNumber').textContent = courtText;
        $('courtNumber').style.display = 'inline-block';
        $('courtMemo').style.display = 'none';
      } else {
        $('courtNumber').style.display = 'none';
        $('courtMemo').style.display = 'none';
      }
      
      // ë‚ ì§œê°€ ì˜¤ëŠ˜ì´ ì•„ë‹ˆë©´ ë‚ ì§œ í‘œì‹œ
      if(notice.date !== todayStr) {
        const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
        const d = new Date(notice.date + 'T00:00:00');
        const dayStr = isNaN(d.getTime()) ? '' : ` (${dayNames[d.getDay()]})`;
        $('courtName').textContent = `[${notice.date.slice(5)}${dayStr}] ${notice.courtName || ''}`;
      }

      // ê³µì§€ ìˆìœ¼ë©´ ì¹´ë“œ í‘œì‹œ
      $('courtInfoCard').style.display = 'block';
      $('courtInfoContent').style.display = 'block';
      $('courtNoNotice').style.display = 'none';
    } else {
      // âœ… v3.817: ê³µì§€ ì—†ìœ¼ë©´ ë¹ˆ ì •ë³´ ëŒ€ì‹  ì•ˆë‚´ ë©”ì‹œì§€ (ëª¨ë“  í´ëŸ½ ë™ì¼)
      $('courtInfoCard').style.display = 'block';
      $('courtInfoContent').style.display = 'none';
      $('courtNoNotice').style.display = 'block';
    }
  }

  function openCourtMap() {
    const address = $('courtAddress').textContent;
    if(!address) return;
    const url = `https://map.naver.com/v5/search/${encodeURIComponent(address)}`;
    window.open(url, '_blank');
  }

  // ========================================
  // v3.80: HOME - ê³µì§€ì‚¬í•­ ì‹œìŠ¤í…œ
  // ========================================

  function loadNotices() {
    const listEl = $('noticeList');
    if(!listEl) return;

    // ì‚­ì œë˜ì§€ ì•Šì€ ê³µì§€ë§Œ í•„í„°, ìµœëŒ€ 5ê°œ
    const active = announcements
      .filter(a => !a.deleted)
      .sort((a,b) => {
        // ì¤‘ìš” ê³µì§€ ìƒë‹¨ ê³ ì •
        if(a.isImportant && !b.isImportant) return -1;
        if(!a.isImportant && b.isImportant) return 1;
        // ë“±ë¡ì¼ ìµœì‹ ìˆœ
        return (b.registeredDate || '').localeCompare(a.registeredDate || '');
      })
      .slice(0, 5);

    if(active.length === 0) {
      listEl.innerHTML = '<div class="notice-empty">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    listEl.innerHTML = active.map(a => {
      const importantClass = a.isImportant ? ' important' : '';
      const badge = a.isImportant ? '<span class="notice-badge">â­ ì¤‘ìš”</span>' : '';
      const dateStr = a.registeredDate ? a.registeredDate.replace(/-/g,'.') : '';
      const titleHtml = escapeHtml(a.title).replace(/\n/g, '<br>');
      return `
        <div class="notice-item${importantClass}">
          <div class="notice-title-row">
            ${badge}
            <span>${titleHtml}</span>
          </div>
          <div class="notice-date">${dateStr} ë“±ë¡</div>
        </div>
      `;
    }).join('');
  }

  // ========================================
  // v3.80: HOME - ì¹´í†¡ ê³µìœ  ì‹œìŠ¤í…œ
  // ========================================

  function toggleShareDropdown() {
    const dd = $('shareDropdown');
    if(!dd) return;
    dd.classList.toggle('active');
    // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    if(dd.classList.contains('active')) {
      setTimeout(() => {
        document.addEventListener('click', closeShareDropdownOnOutside, { once: true });
      }, 10);
    }
  }

  function closeShareDropdownOnOutside(e) {
    const dd = $('shareDropdown');
    const wrap = dd?.parentElement;
    if(wrap && !wrap.contains(e.target)) {
      dd.classList.remove('active');
    } else if(dd?.classList.contains('active')) {
      // ë“œë¡­ë‹¤ìš´ ì•„ì´í…œ í´ë¦­ì´ë©´ ì•Œì•„ì„œ ë‹«í˜
    }
  }

  function shareContent(mode) {
    $('shareDropdown').classList.remove('active');

    const courtName = $('courtName')?.textContent || '';
    const courtTime = $('courtTime')?.textContent || '';
    const courtNumber = $('courtNumber')?.textContent || '';
    const courtAddress = $('courtAddress')?.textContent || '';
    const dateDisp = $('dateDisplay')?.textContent || '';

    // âœ… v3.816: ì½”íŠ¸ ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ì‹œê°„ ë’¤ì— ë¶™ì—¬ì„œ í‘œì‹œ
    const courtTimeWithNum = courtNumber ? `${courtTime}  <${courtNumber}>` : courtTime;

    // ë‚ ì”¨ ìš”ì•½ ìƒì„±
    let weatherSummary = '';
    const rows = $('tbody')?.querySelectorAll('tr');
    if(rows && rows.length > 0) {
      const temps = [];
      let weatherIcon = 'â˜€ï¸';
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if(cells.length >= 3) {
          const temp = parseFloat(cells[2].textContent);
          if(!isNaN(temp)) temps.push(temp);
          if(cells[1]) weatherIcon = cells[1].textContent.trim();
        }
      });
      if(temps.length > 0) {
        const minT = Math.min(...temps).toFixed(1);
        const maxT = Math.max(...temps).toFixed(1);
        weatherSummary = `${weatherIcon} ë‚ ì”¨: ${minT}~${maxT}Â°C`;
      }
    }

    let text = '';

    if(mode === 'weather' || mode === 'weather+court' || mode === 'all') {
      text += `ğŸ¾ ${dateDisp} ì •ë³´\n`;
      if(weatherSummary) text += `${weatherSummary}\n`;
    }

    if(mode === 'weather+court' || mode === 'all' || mode === 'text') {
      text += `ğŸ“ ${courtName}\n`;
      text += `â° ${courtTimeWithNum}\n`;
      if(courtAddress) text += `ğŸ—ºï¸ ${courtAddress}\n`;
    }

    if(mode === 'all') {
      const activeNotices = announcements.filter(a => !a.deleted).slice(0, 5);
      if(activeNotices.length > 0) {
        text += `\nğŸ“¢ ê³µì§€ì‚¬í•­\n`;
        activeNotices.forEach(a => {
          const prefix = a.isImportant ? 'â­ ' : 'â€¢ ';
          text += `${prefix}${a.title}\n`;
        });
      }
    }

    if(mode === 'text') {
      text = `ğŸ¾ ${dateDisp} ì •ë³´\n`;
      text += `ğŸ“ ${courtName}\n`;
      text += `â° ${courtTimeWithNum}\n`;
      if(courtAddress) text += `ğŸ—ºï¸ ${courtAddress}\n`;
      if(weatherSummary) text += `${weatherSummary}\n`;
    }

    // í´ë¦½ë³´ë“œì— ë³µì‚¬
    if(navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text.trim()).then(() => {
        gsAlert('ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
      }).catch(() => {
        fallbackCopy(text.trim());
      });
    } else {
      fallbackCopy(text.trim());
    }
  }

  function fallbackCopy(text) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;left:-9999px;';
    document.body.appendChild(ta);
    ta.select();
    try {
      document.execCommand('copy');
      gsAlert('ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
    } catch(e) {
      gsAlert('ë³µì‚¬ ì‹¤íŒ¨. ì§ì ‘ ì„ íƒí•˜ì—¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
    }
    document.body.removeChild(ta);
  }

  // ========================================
  // v3.80: GAS ì—°ë™ - ì½”íŠ¸ê³µì§€ & ê³µì§€ì‚¬í•­ ë¡œë“œ
  // v3.811: localStorage fallback + í´ëŸ½ë³„ ë¶„ë¦¬ ì €ì¥
  // ========================================

  function getLocalCourtKey() { return 'grandslam_court_notices_' + getActiveClubId(); }
  function getLocalAnnouncementKey() { return 'grandslam_announcements_' + getActiveClubId(); }

  function persistCourtNoticesLocal() {
    try { localStorage.setItem(getLocalCourtKey(), JSON.stringify(courtNotices)); } catch(e) {}
  }
  function persistAnnouncementsLocal() {
    try { localStorage.setItem(getLocalAnnouncementKey(), JSON.stringify(announcements)); } catch(e) {}
  }

  async function fetchCourtNotices() {
    if(!currentClub) return;
    try {
      const url = MASTER_GAS_URL + '?action=getCourtNotices&clubId=' + encodeURIComponent(getActiveClubId());
      const r = await fetchWithTimeout(url, {}, 12000);
      if(!r.ok) throw new Error('not ok');
      const resp = await r.json();
      if(resp.ok && Array.isArray(resp.notices)) {
        courtNotices = resp.notices;
        persistCourtNoticesLocal();
        return;
      }
    } catch(e) {
      console.warn('fetchCourtNotices GAS error, using local:', e);
    }
    // GAS ì‹¤íŒ¨ì‹œ localStorageì—ì„œ ë³µì›
    try { courtNotices = JSON.parse(localStorage.getItem(getLocalCourtKey())) || []; } catch(e) { courtNotices = []; }
  }

  async function fetchAnnouncements() {
    if(!currentClub) return;
    try {
      const url = MASTER_GAS_URL + '?action=getAnnouncements&clubId=' + encodeURIComponent(getActiveClubId());
      const r = await fetchWithTimeout(url, {}, 12000);
      if(!r.ok) throw new Error('not ok');
      const resp = await r.json();
      if(resp.ok && Array.isArray(resp.announcements)) {
        announcements = resp.announcements;
        persistAnnouncementsLocal();
        return;
      }
    } catch(e) {
      console.warn('fetchAnnouncements GAS error, using local:', e);
    }
    // GAS ì‹¤íŒ¨ì‹œ localStorageì—ì„œ ë³µì›
    try { announcements = JSON.parse(localStorage.getItem(getLocalAnnouncementKey())) || []; } catch(e) { announcements = []; }
  }

  // ì½”íŠ¸ê³µì§€ ì €ì¥
  async function saveCourtNotice(notice) {
    persistCourtNoticesLocal(); // í•­ìƒ ë¡œì»¬ ë¨¼ì €
    if(!currentClub) return false;
    try {
      const url = MASTER_GAS_URL + '?action=saveCourtNotice&clubId=' + encodeURIComponent(getActiveClubId());
      const r = await fetchWithTimeout(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(notice)
      }, 12000);
      const resp = await r.json();
      return resp.ok || false;
    } catch(e) {
      console.warn('saveCourtNotice error:', e);
      return false;
    }
  }

  // ê³µì§€ì‚¬í•­ ì €ì¥
  async function saveAnnouncement(announcement) {
    persistAnnouncementsLocal(); // í•­ìƒ ë¡œì»¬ ë¨¼ì €
    if(!currentClub) return false;
    try {
      const url = MASTER_GAS_URL + '?action=saveAnnouncement&clubId=' + encodeURIComponent(getActiveClubId());
      const r = await fetchWithTimeout(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(announcement)
      }, 12000);
      const resp = await r.json();
      return resp.ok || false;
    } catch(e) {
      console.warn('saveAnnouncement error:', e);
      return false;
    }
  }

  // ========================================
  // v3.81: TREASURER MODE (ì´ë¬´ ëª¨ë“œ)
  // ========================================
  // âœ… v3.816: ìˆ¨ê¹€ ì²˜ë¦¬í•  ê°€ìƒ í”Œë ˆì´ì–´ ëª©ë¡ (ë­í‚¹/í†µê³„/í’€ì—ì„œ ë³´ì´ì§€ ì•ŠìŒ)
  const HIDDEN_PLAYERS = ['1ëŒ€2ìš©', '1ëŒ€2ëŒ€ê²°ìš©'];
  // âœ… v3.8207: ë‹¹ì¼ ê²ŒìŠ¤íŠ¸ ì´ë¦„ìœ¼ë¡œ ê°€ìƒ í”Œë ˆì´ì–´ ê°ì²´ ìƒì„± í—¬í¼
  function makeOneTimePlayerObj(name) {
    return { name, isGuest: true, isOneTime: true, score:0, wins:0, losses:0,
      dScore:0, dWins:0, dLosses:0, sScore:0, sWins:0, sLosses:0,
      last:0, lastD:0, lastS:0, weekly:0, wWins:0, wLosses:0,
      wdScore:0, wsScore:0, wdWins:0, wdLosses:0, wsWins:0, wsLosses:0, lastW:0, lastWD:0, lastWS:0 };
  }

  // âœ… v3.8206: ë‹¹ì¼ ê²ŒìŠ¤íŠ¸ (ì„¸ì…˜ ë‚´ì—ì„œë§Œ ì¡´ì¬, ìˆœìœ„/í†µê³„ ì œì™¸)
  var oneTimePlayers = [];
  function addOneTimePlayer() {
    gsEditName('', name => {
      name = (name || '').trim();
      if (!name) return;
      if (players.find(p => p.name === name) || oneTimePlayers.includes(name)) {
        gsAlert('ì´ë¯¸ ìˆëŠ” ì´ë¦„ì´ì—ìš”!'); return;
      }
      oneTimePlayers.push(name);
      renderPool(); initTournament(); renderLadderPlayerPool();
      try { initRoundPlayerPool(); } catch(e) {}
    });
  }
  function removeOneTimePlayer(name) {
    oneTimePlayers = oneTimePlayers.filter(n => n !== name);
    // ê° ê²Œì„ ì„ íƒ ë°°ì—´ì—ì„œë„ ì œê±°
    hT = hT.filter(n => n !== name);
    aT = aT.filter(n => n !== name);
    ldP = ldP.filter(n => n !== name);
    selected = selected.filter(n => n !== name);
    $('hN').innerText = hT.map(displayName).join(',');
    $('aN').innerText = aT.map(displayName).join(',');
    renderPool(); initTournament(); renderLadderPlayerPool();
    try { initRoundPlayerPool(); } catch(e) {}
  }

  // âœ… v3.816: í´ëŸ½ë³„ 1ëŒ€2ëŒ€ê²°ìš© í™œì„±í™” ì—¬ë¶€ (localStorage ì €ì¥)
  function getUse1v2Key() { return 'grandslam_use1v2_' + getActiveClubId(); }
  function isUse1v2() { return localStorage.getItem(getUse1v2Key()) === 'Y'; }
  function setUse1v2(val) { localStorage.setItem(getUse1v2Key(), val ? 'Y' : 'N'); }

  // âœ… v3.816: ê°€ìƒ 1ëŒ€2ëŒ€ê²°ìš© í”Œë ˆì´ì–´ ê°ì²´ (players ë°°ì—´ì— ì—†ì–´ë„ í’€ì— í‘œì‹œ)
  const VIRTUAL_1V2_PLAYER = { name: '1ëŒ€2ëŒ€ê²°ìš©', isGuest: true, isVirtual: true, score:0, wins:0, losses:0, dScore:0, dWins:0, dLosses:0, sScore:0, sWins:0, sLosses:0, last:0, lastD:0, lastS:0 };
  // ========================================

  var treasurerUnlocked = false;
  var currentFinTab = 'income';
  var financeData = []; // { id, type:'income'|'expense', date, desc, amount, auto:bool }
  var feeData = {};     // { 'íšŒì›ëª…': { '2026-01':'Y', ... } }
  var monthlyFeeAmount = 0; // ì›”íšŒë¹„ ê¸ˆì•¡
  var courtPresets = []; // ì½”íŠ¸ í”„ë¦¬ì…‹ [{name,address,time,memo}]

  function enterTreasurer() {
    showView('treasurer');
  }

  function resetTreasurerView() {
    if(treasurerUnlocked) {
      showTreasurerMenu();
    } else {
      $('treasurer-pin-screen').style.display = 'block';
      $('treasurer-main').style.display = 'none';
      hideTreasurerSections();
      $('treasurerPinInput').value = '';
      setTimeout(() => $('treasurerPinInput').focus(), 100);
    }
  }

  function verifyTreasurerPin() {
    const pin = $('treasurerPinInput').value;
    if(pin === MASTER_PIN || pin === ADMIN_PIN) {
      treasurerUnlocked = true;
      showTreasurerMenu();
    } else {
      gsAlert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
      $('treasurerPinInput').value = '';
      $('treasurerPinInput').focus();
    }
  }

  function showTreasurerMenu() {
    $('treasurer-pin-screen').style.display = 'none';
    $('treasurer-main').style.display = 'block';
    hideTreasurerSections();
    // âœ… v3.816: 1ëŒ€2ëŒ€ê²°ìš© í† ê¸€ ìƒíƒœ ë Œë”ë§
    render1v2Toggle();
  }

  // âœ… v3.816: 1ëŒ€2ëŒ€ê²°ìš© í† ê¸€ ìƒíƒœ ì—…ë°ì´íŠ¸
  function render1v2Toggle() {
    const track = $('use1v2Track');
    const thumb = $('use1v2Thumb');
    if(!track || !thumb) return;
    const active = isUse1v2();
    track.style.background = active ? 'var(--wimbledon-sage)' : '#ccc';
    thumb.style.transform = active ? 'translateX(22px)' : 'translateX(0)';
  }

  // âœ… v3.816: 1ëŒ€2ëŒ€ê²°ìš© í† ê¸€ í´ë¦­
  function toggle1v2() {
    setUse1v2(!isUse1v2());
    render1v2Toggle();
    // ê²Œì„ í’€ ì¦‰ì‹œ ê°±ì‹ 
    renderPool();
    renderLadderPlayerPool();
    initTournament();
    try { initRoundPlayerPool(); } catch(e) {}
    gsAlert(isUse1v2() ? 'âœ… [1vs2]ìš©ì´ ê²Œì„ í’€ì— í‘œì‹œë©ë‹ˆë‹¤.' : 'âŒ [1vs2]ìš©ì´ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤.');
  }

  function hideTreasurerSections() {
    ['treasurer-fee','treasurer-finance','treasurer-court-mgmt','treasurer-notice-mgmt'].forEach(id => {
      const el = $(id);
      if(el) el.style.display = 'none';
    });
  }

  function showTreasurerSection(section) {
    $('treasurer-main').style.display = 'none';
    hideTreasurerSections();
    const el = $('treasurer-' + section);
    if(el) el.style.display = 'block';

    if(section === 'fee') { initFeeTable(); }
    if(section === 'finance') { initFinance(); }
    if(section === 'court-mgmt') { loadCourtPresets(); renderCourtNoticeList(); }
    if(section === 'notice-mgmt') { renderAnnouncementMgmtList(); }
  }

  // ========================================
  // íšŒë¹„ ë‚©ë¶€ í˜„í™©
  // ========================================

  function initFeeTable() {
    const sel = $('feeYear');
    const curYear = new Date().getFullYear();
    sel.innerHTML = '';
    for(let y = curYear; y >= curYear - 2; y--) {
      sel.innerHTML += `<option value="${y}" ${y===curYear?'selected':''}>${y}ë…„</option>`;
    }
    // ì›”íšŒë¹„ ë³µì›
    const savedFee = localStorage.getItem('grandslam_monthly_fee_' + getActiveClubId());
    if(savedFee) { monthlyFeeAmount = parseInt(savedFee) || 0; }
    $('monthlyFeeAmount').value = monthlyFeeAmount || '';
    // âœ… v3.816: íšŒë¹„ ë‚©ë¶€ í˜„í™© localStorage ë³µì› (clubId ìˆì„ ë•Œë§Œ)
    const cid = getActiveClubId();
    if(cid) {
      const savedFeeData = localStorage.getItem('grandslam_fee_data_' + cid);
      if(savedFeeData) {
        try { feeData = JSON.parse(savedFeeData); } catch(e) { feeData = {}; }
      }
    }
    syncFeeToFinance(); // âœ… v3.8191: ë³µì› í›„ ì¬ì • ì—°ë™ ì¦‰ì‹œ ê°±ì‹ 
    renderFeeTable();
  }

  function saveMonthlyFee() {
    monthlyFeeAmount = parseInt($('monthlyFeeAmount').value) || 0;
    localStorage.setItem('grandslam_monthly_fee_' + getActiveClubId(), monthlyFeeAmount);
    syncFeeToFinance(); // ì¬ì • ì—°ë™ ì¬ê³„ì‚°
  }

  function renderFeeTable() {
    const year = $('feeYear').value;
    const curMonth = new Date().getMonth() + 1;
    const curYear = new Date().getFullYear();
    const members = players.filter(p => !p.isGuest).sort((a,b) => a.name.localeCompare(b.name));

    let headHtml = '<tr><th>íšŒì›</th>';
    for(let m = 1; m <= 12; m++) {
      const isCur = (parseInt(year) === curYear && m === curMonth);
      headHtml += `<th class="${isCur ? 'fee-current-month' : ''}">${m}ì›”</th>`;
    }
    headHtml += '</tr>';
    $('feeHead').innerHTML = headHtml;

    let bodyHtml = '';
    members.forEach(p => {
      const pFee = feeData[p.name] || {};
      bodyHtml += `<tr><td>${escapeHtml(displayName(p.name))}</td>`;
      for(let m = 1; m <= 12; m++) {
        const key = `${year}-${String(m).padStart(2,'0')}`;
        const paid = pFee[key] === 'Y';
        const isCur = (parseInt(year) === curYear && m === curMonth);
        const cellClass = (!paid ? ' fee-unpaid' : '') + (isCur ? ' fee-current-month' : '');
        bodyHtml += `<td class="fee-check${cellClass}" onclick="toggleFee('${escapeHtml(p.name)}','${key}')">${paid ? 'âœ…' : 'âŒ'}</td>`;
      }
      bodyHtml += '</tr>';
    });
    $('feeBody').innerHTML = bodyHtml;
  }

  function toggleFee(name, key) {
    if(!feeData[name]) feeData[name] = {};
    feeData[name][key] = (feeData[name][key] === 'Y') ? 'N' : 'Y';
    // âœ… v3.816: ë³€ê²½ ì¦‰ì‹œ localStorageì— ì €ì¥ (clubId ìˆì„ ë•Œë§Œ)
    const cid = getActiveClubId();
    if(cid) localStorage.setItem('grandslam_fee_data_' + cid, JSON.stringify(feeData));
    renderFeeTable();
    syncFeeToFinance();
  }

  // âœ… ì™„ë‚©/í•´ì œ ë²„íŠ¼ (ì—°/ì›”)
  function feeSetAll(value, scope) {
    const year = $('feeYear').value;
    const curMonth = new Date().getMonth() + 1;
    const members = players.filter(p => !p.isGuest);

    if(scope === 'year') {
      // 1~12ì›” ì „ì²´
      members.forEach(p => {
        if(!feeData[p.name]) feeData[p.name] = {};
        for(let m = 1; m <= 12; m++) {
          const key = `${year}-${String(m).padStart(2,'0')}`;
          feeData[p.name][key] = value;
        }
      });
    } else {
      // í˜„ì¬ ì›”ë§Œ
      const key = `${year}-${String(curMonth).padStart(2,'0')}`;
      members.forEach(p => {
        if(!feeData[p.name]) feeData[p.name] = {};
        feeData[p.name][key] = value;
      });
    }
    renderFeeTable();
    syncFeeToFinance();
    // âœ… v3.816: ì™„ë‚©/í•´ì œ í›„ localStorage ì €ì¥ (clubId ìˆì„ ë•Œë§Œ)
    const cid = getActiveClubId();
    if(cid) localStorage.setItem('grandslam_fee_data_' + cid, JSON.stringify(feeData));
  }

  // âœ… íšŒë¹„ â†’ ì¬ì • ìˆ˜ì… ìë™ ì—°ë™
  function syncFeeToFinance() {
    // ê¸°ì¡´ ìë™ í•­ëª© ì œê±°
    financeData = financeData.filter(f => !f.auto);

    if(!monthlyFeeAmount) return;

    // âœ… v3.819: feeYearê°€ ìˆ¨ê²¨ì§„ í™”ë©´(ì¬ì •ê´€ë¦¬)ì—ì„œë„ ì˜¬ë°”ë¥¸ ì—°ë„ ì‚¬ìš©
    const feeYearEl = $('feeYear');
    const year = (feeYearEl && feeYearEl.value) ? feeYearEl.value : String(new Date().getFullYear());

    for(let m = 1; m <= 12; m++) {
      const key = `${year}-${String(m).padStart(2,'0')}`;
      let paidCount = 0;
      Object.values(feeData).forEach(pf => { if(pf[key] === 'Y') paidCount++; });
      if(paidCount > 0) {
        financeData.push({
          id: `auto-fee-${key}`,
          type: 'income',
          date: `${key}-01`,
          desc: `${m}ì›” íšŒë¹„ (${paidCount}ëª…)`,
          amount: paidCount * monthlyFeeAmount,
          auto: true
        });
      }
    }
  }

  function copyFeeStatus() {
    const year = $('feeYear').value;
    const curMonth = new Date().getMonth() + 1;
    const key = `${year}-${String(curMonth).padStart(2,'0')}`;
    const members = players.filter(p => !p.isGuest).sort((a,b) => a.name.localeCompare(b.name));

    const paid = [];
    const unpaid = [];
    members.forEach(p => {
      const pFee = feeData[p.name] || {};
      if(pFee[key] === 'Y') paid.push(displayName(p.name));
      else unpaid.push(displayName(p.name));
    });

    let text = `ğŸ“‹ ${year}ë…„ ${curMonth}ì›” íšŒë¹„ ë‚©ë¶€ í˜„í™©\n`;
    text += `â”â”â”â”â”â”â”â”â”â”\n`;
    text += `âœ… ë‚©ë¶€ (${paid.length}ëª…): ${paid.join(', ') || 'ì—†ìŒ'}\n`;
    text += `âŒ ë¯¸ë‚© (${unpaid.length}ëª…): ${unpaid.join(', ') || 'ì—†ìŒ'}\n`;
    if(monthlyFeeAmount) {
      text += `â”â”â”â”â”â”â”â”â”â”\n`;
      text += `ğŸ’° ì›”íšŒë¹„: ${monthlyFeeAmount.toLocaleString()}ì›\n`;
      text += `ğŸ“¥ ë‚©ë¶€ì•¡: ${(paid.length * monthlyFeeAmount).toLocaleString()}ì›`;
    }

    if(navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => gsAlert('ğŸ“‹ ë³µì‚¬ ì™„ë£Œ! ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.'));
    } else { fallbackCopy(text); }
  }

  // ========================================
  // ì¬ì • ê´€ë¦¬
  // ========================================

  function initFinance() {
    const today = new Date().toISOString().slice(0,10);
    $('finDate').value = today;
    $('finDesc').value = '';
    $('finAmount').value = '';
    // âœ… v3.8191: feeData + monthlyFeeAmount ë³µì› í™•ì‹¤íˆ ë³´ì¥ (ëª¨ë“  í´ëŸ½ ê³µí†µ)
    const cid = getActiveClubId();
    if(cid) {
      const savedFeeData = localStorage.getItem('grandslam_fee_data_' + cid);
      if(savedFeeData) { try { feeData = JSON.parse(savedFeeData); } catch(e) { feeData = {}; } }
      const savedFee = localStorage.getItem('grandslam_monthly_fee_' + cid);
      if(savedFee) { monthlyFeeAmount = parseInt(savedFee) || 0; }
    }
    syncFeeToFinance();
    setFinanceTab('income');
    renderFinanceList();
  }

  function setFinanceTab(tab) {
    currentFinTab = tab;
    $('finTabIncome').classList.toggle('active', tab === 'income');
    $('finTabExpense').classList.toggle('active', tab === 'expense');
    renderFinanceList();
  }

  function addFinanceItem() {
    const date = $('finDate').value;
    const desc = $('finDesc').value.trim();
    const amount = parseInt($('finAmount').value);

    if(!desc) { gsAlert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    if(!amount || amount <= 0) { gsAlert('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

    financeData.push({
      id: Date.now().toString(),
      type: currentFinTab,
      date: date,
      desc: desc,
      amount: amount,
      auto: false
    });

    $('finDesc').value = '';
    $('finAmount').value = '';
    renderFinanceList();
  }

  function deleteFinanceItem(id) {
    gsConfirm('ì‚­ì œí• ê¹Œìš”?', ok => {
      if(!ok) return;
      financeData = financeData.filter(f => f.id !== id);
      renderFinanceList();
    });
  }

  function renderFinanceList() {
    const filtered = financeData.filter(f => f.type === currentFinTab)
      .sort((a,b) => {
        // ìë™ í•­ëª© ìœ„ë¡œ
        if(a.auto && !b.auto) return -1;
        if(!a.auto && b.auto) return 1;
        return (b.date || '').localeCompare(a.date || '');
      });

    const area = $('financeListArea');
    if(filtered.length === 0) {
      area.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-gray); font-size:13px;">${currentFinTab === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ'} ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    } else {
      area.innerHTML = filtered.map(f => {
        const dateShort = (f.date || '').slice(5).replace('-','/');
        const amtClass = f.type === 'income' ? 'income' : 'expense';
        const prefix = f.type === 'income' ? '+' : '-';
        const autoStyle = f.auto ? 'opacity:0.7; background:rgba(93,156,118,0.06);' : '';
        const autoTag = f.auto ? '<span style="font-size:10px; color:var(--wimbledon-sage); margin-left:4px;">[ìë™]</span>' : '';
        const delBtn = f.auto ? '' : `<span class="material-symbols-outlined fi-del" onclick="deleteFinanceItem('${f.id}')">close</span>`;
        return `
          <div class="finance-item" style="${autoStyle}">
            <span class="fi-date">${dateShort}</span>
            <span class="fi-desc">${escapeHtml(f.desc)}${autoTag}</span>
            <span class="fi-amount ${amtClass}">${prefix}${f.amount.toLocaleString()}ì›</span>
            ${delBtn}
          </div>
        `;
      }).join('');
    }

    // í•©ê³„ ê³„ì‚°
    const totalIncome = financeData.filter(f => f.type === 'income').reduce((s,f) => s + f.amount, 0);
    const totalExpense = financeData.filter(f => f.type === 'expense').reduce((s,f) => s + f.amount, 0);
    const balance = totalIncome - totalExpense;

    $('fsTotalIncome').textContent = totalIncome.toLocaleString() + 'ì›';
    $('fsTotalExpense').textContent = totalExpense.toLocaleString() + 'ì›';
    $('fsBalance').textContent = balance.toLocaleString() + 'ì›';
    $('fsBalance').style.color = balance >= 0 ? 'var(--wimbledon-sage)' : 'var(--up-red)';
  }

  function copyFinanceStatus() {
    const incomes = financeData.filter(f => f.type === 'income').sort((a,b) => (a.date||'').localeCompare(b.date||''));
    const expenses = financeData.filter(f => f.type === 'expense').sort((a,b) => (a.date||'').localeCompare(b.date||''));
    const totalIncome = incomes.reduce((s,f) => s + f.amount, 0);
    const totalExpense = expenses.reduce((s,f) => s + f.amount, 0);
    const balance = totalIncome - totalExpense;

    let text = `ğŸ’° ì¬ì • í˜„í™©\nâ”â”â”â”â”â”â”â”â”â”\n`;

    if(incomes.length > 0) {
      text += `ğŸ“¥ ìˆ˜ì…\n`;
      incomes.forEach(f => {
        const dateShort = (f.date || '').slice(5).replace('-','/');
        const tag = f.auto ? ' [ìë™]' : '';
        text += `â€¢ ${dateShort} ${f.desc}${tag} ${f.amount.toLocaleString()}ì›\n`;
      });
      text += `ì†Œê³„: ${totalIncome.toLocaleString()}ì›\n\n`;
    }

    if(expenses.length > 0) {
      text += `ğŸ“¤ ì§€ì¶œ\n`;
      expenses.forEach(f => {
        const dateShort = (f.date || '').slice(5).replace('-','/');
        text += `â€¢ ${dateShort} ${f.desc} ${f.amount.toLocaleString()}ì›\n`;
      });
      text += `ì†Œê³„: ${totalExpense.toLocaleString()}ì›\n\n`;
    }

    text += `â”â”â”â”â”â”â”â”â”â”\n`;
    text += `ğŸ’µ ì”ì•¡: ${balance.toLocaleString()}ì›`;

    if(navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => gsAlert('ğŸ“‹ ë³µì‚¬ ì™„ë£Œ! ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.'));
    } else { fallbackCopy(text); }
  }

  // ========================================
  // ì½”íŠ¸ ê³µì§€ ê´€ë¦¬ CRUD + í”„ë¦¬ì…‹ + ìŠ¬ë¡¯ (v3.811)
  // ========================================

  function getCourtPresetKey() {
    return 'grandslam_court_presets_' + getActiveClubId();
  }

  function loadCourtPresets() {
    try {
      courtPresets = JSON.parse(localStorage.getItem(getCourtPresetKey())) || [];
    } catch(e) { courtPresets = []; }
    renderCourtPresetSelect();
  }

  function saveCourtPresetToStorage(preset) {
    const exists = courtPresets.find(p => p.name === preset.name);
    if(!exists) {
      courtPresets.push(preset);
      localStorage.setItem(getCourtPresetKey(), JSON.stringify(courtPresets));
    }
    renderCourtPresetSelect();
  }

  function renderCourtPresetSelect() {
    const sel = $('courtPresetSelect');
    if(!sel) return;
    sel.innerHTML = '<option value="">ğŸ“Œ ì €ì¥ëœ ì½”íŠ¸ ì„ íƒ (ì§ì ‘ ì…ë ¥)</option>';
    courtPresets.forEach((p, i) => {
      const slotsStr = (p.slots||[]).map(s=>s.time).filter(Boolean).join(', ');
      sel.innerHTML += `<option value="${i}">${escapeHtml(p.name)} ${slotsStr ? '(' + escapeHtml(slotsStr) + ')' : ''}</option>`;
    });
  }

  function applyCourtPreset() {
    const sel = $('courtPresetSelect');
    const idx = parseInt(sel.value);
    if(isNaN(idx) || !courtPresets[idx]) return;
    const p = courtPresets[idx];
    $('courtNoticeName').value = p.name || '';
    $('courtNoticeAddr').value = p.address || '';
    
    // ìŠ¬ë¡¯ ë³µì›
    const container = $('courtSlotRows');
    container.innerHTML = '';
    const slots = p.slots || [{time:'', court:''}];
    slots.forEach(s => {
      const row = document.createElement('div');
      row.className = 'court-slot-row';
      row.style.cssText = 'display:flex; gap:8px; margin-bottom:6px;';
      row.innerHTML = '<input type="text" class="w-input court-slot-time" placeholder="ì‹œê°„ (ì˜ˆ: 07:00-11:00)" value="' + escapeHtml(s.time||'') + '" style="flex:1; padding:10px;" /><input type="text" class="w-input court-slot-court" placeholder="ì½”íŠ¸ë²ˆí˜¸ (ì˜ˆ: 11,12ë²ˆ)" value="' + escapeHtml(s.court||'') + '" style="flex:1; padding:10px;" />';
      container.appendChild(row);
    });
    updateAddSlotBtn();
  }

  function addCourtSlotRow() {
    const container = $('courtSlotRows');
    const rows = container.querySelectorAll('.court-slot-row');
    if(rows.length >= 3) return;
    const row = document.createElement('div');
    row.className = 'court-slot-row';
    row.style.cssText = 'display:flex; gap:8px; margin-bottom:6px;';
    row.innerHTML = '<input type="text" class="w-input court-slot-time" placeholder="ì‹œê°„ (ì˜ˆ: 07:00-11:00)" style="flex:1; padding:10px;" /><input type="text" class="w-input court-slot-court" placeholder="ì½”íŠ¸ë²ˆí˜¸ (ì˜ˆ: 11,12ë²ˆ)" style="flex:1; padding:10px;" />';
    container.appendChild(row);
    updateAddSlotBtn();
  }

  function updateAddSlotBtn() {
    const rows = $('courtSlotRows').querySelectorAll('.court-slot-row');
    const btn = $('btnAddSlot');
    if(btn) btn.style.display = rows.length >= 3 ? 'none' : 'block';
  }

  function getSlotValues() {
    const rows = $('courtSlotRows').querySelectorAll('.court-slot-row');
    const slots = [];
    rows.forEach(row => {
      const time = row.querySelector('.court-slot-time').value.trim();
      const court = row.querySelector('.court-slot-court').value.trim();
      if(time || court) slots.push({ time, court });
    });
    return slots;
  }

  function addCourtNotice() {
    const date = $('courtNoticeDate').value;
    const name = $('courtNoticeName').value.trim();
    const addr = $('courtNoticeAddr').value.trim();
    const slots = getSlotValues();

    if(!date || !name) { gsAlert("ë‚ ì§œì™€ ì½”íŠ¸ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

    const notice = {
      id: Date.now().toString(),
      date: date,
      courtName: name,
      address: addr,
      slots: slots.length > 0 ? slots : [{time:'', court:''}],
      time: slots.map(s=>s.time).filter(Boolean).join(' / '),
      memo: slots.map(s=>s.court).filter(Boolean).join(', ')
    };

    courtNotices.push(notice);
    saveCourtPresetToStorage({ name, address: addr, slots: notice.slots });
    $('courtNoticeDate').value = '';
    renderCourtNoticeList();
    loadCourtInfo();
    saveCourtNotice(notice);
  }

  function deleteCourtNotice(id) {
    gsConfirm('ì‚­ì œí• ê¹Œìš”?', ok => {
      if(!ok) return;
      courtNotices = courtNotices.filter(n => n.id !== id);
      persistCourtNoticesLocal();
      renderCourtNoticeList();
      loadCourtInfo();
    });
  }

  function renderCourtNoticeList() {
    const list = $('courtNoticeList');
    const sorted = [...courtNotices].sort((a,b) => (a.date||'').localeCompare(b.date||''));

    if(sorted.length === 0) {
      list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-gray); font-size:13px;">ë“±ë¡ëœ ì½”íŠ¸ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    list.innerHTML = sorted.map(n => {
      const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      const d = new Date(n.date + 'T00:00:00');
      const dayStr = isNaN(d.getTime()) ? '' : ` (${dayNames[d.getDay()]})`;
      const slots = n.slots || [{time: n.time, court: n.memo}];
      const slotsHtml = slots.map(s => {
        const parts = [];
        if(s.time) parts.push('â° ' + escapeHtml(s.time));
        if(s.court) parts.push('ğŸ¾ ' + escapeHtml(s.court));
        return parts.length > 0 ? '<div style="font-size:12px; color:var(--text-gray); margin-top:2px;">' + parts.join(' &nbsp; ') + '</div>' : '';
      }).join('');
      
      return '<div class="crud-item"><div class="crud-item-header"><div>' +
        '<div style="font-size:14px; color:var(--text-dark);">' + escapeHtml(n.date) + dayStr + '</div>' +
        '<div style="font-size:15px; margin-top:4px;">' + escapeHtml(n.courtName) + '</div>' +
        slotsHtml +
        (n.address ? '<div style="font-size:12px; color:var(--text-gray);">ğŸ“ ' + escapeHtml(n.address) + '</div>' : '') +
        '</div><div class="crud-item-actions">' +
        '<button class="crud-btn crud-btn-del" onclick="deleteCourtNotice(\'' + n.id + '\')">ì‚­ì œ</button>' +
        '</div></div></div>';
    }).join('');
  }

  // ========================================
  // ê³µì§€ì‚¬í•­ ê´€ë¦¬ CRUD (ìµœëŒ€ 5ê°œ)
  // ========================================

  function addAnnouncement() {
    const active = announcements.filter(a => !a.deleted);
    if(active.length >= 5) { gsAlert('ê³µì§€ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }

    const title = $('announcementTitle').value.trim();
    const isImportant = $('announcementImportant').checked;

    if(!title) { gsAlert('ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

    const today = new Date().toISOString().slice(0,10);
    announcements.push({
      id: Date.now().toString(),
      title: title,
      isImportant: isImportant,
      registeredDate: today,
      deleted: false
    });

    $('announcementTitle').value = '';
    $('announcementImportant').checked = false;

    renderAnnouncementMgmtList();
    loadNotices();
    saveAnnouncement(announcements[announcements.length - 1]);
  }

  function deleteAnnouncement(id) {
    gsConfirm('ì‚­ì œí• ê¹Œìš”?', ok => {
      if(!ok) return;
      const ann = announcements.find(a => a.id === id);
      if(ann) ann.deleted = true;
      persistAnnouncementsLocal();
      renderAnnouncementMgmtList();
      loadNotices();
    });
  }

  function renderAnnouncementMgmtList() {
    const list = $('announcementMgmtList');
    const active = announcements.filter(a => !a.deleted);

    if(active.length === 0) {
      list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-gray); font-size:13px;">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    list.innerHTML = active.map(a => {
      const titleHtml = escapeHtml(a.title).replace(/\n/g, '<br>');
      return `
        <div class="crud-item">
          <div class="crud-item-header">
            <div>
              <div style="display:flex; align-items:center; gap:6px;">
                ${a.isImportant ? '<span class="notice-badge">â­ ì¤‘ìš”</span>' : ''}
                <span style="font-size:15px;">${titleHtml}</span>
              </div>
              <div style="font-size:11px; color:var(--text-gray); margin-top:4px;">${(a.registeredDate||'').replace(/-/g,'.')} ë“±ë¡</div>
            </div>
            <div class="crud-item-actions">
              <button class="crud-btn crud-btn-del" onclick="deleteAnnouncement('${a.id}')">ì‚­ì œ</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // ========================================
  // STATISTICS (í†µê³„)
  // ========================================
  
  function renderStatsPlayerList() {
    const members = players.filter(p => !p.isGuest).sort((a,b)=>(b.score||0)-(a.score||0));
    // âœ… v3.816: HIDDEN_PLAYERS ì œì™¸
    const guests = players.filter(p => p.isGuest && !HIDDEN_PLAYERS.includes(p.name));

    let html = '<div style="border: 2px solid #E5E5EA; border-radius: 15px; padding: 15px; background: white; margin-bottom: 30px;">';

    // 1. ì •ì‹ íšŒì› ì„¹ì…˜
    html += '<div style="font-size:12px; color:#666; margin-bottom:8px; font-weight:bold; text-align:left; padding-left:5px;">ì •ì‹ íšŒì›</div>';
    html += '<div style="display:flex !important; flex-wrap:wrap !important; justify-content:flex-start !important; gap:8px; margin-bottom:20px;">';
    members.forEach((p, i) => {
      html += createPlayerOption({ inputType:"radio", nameAttr:"statsPick", id:`stat_p_${i}`, value:p.name, checked:false, onClick:`viewStats('${escapeHtml(p.name).replace(/'/g,"&#39;")}')`, labelText:`${escapeHtml(displayName(p.name))}`, isGuest:false, showRank:true, rankText:`${i+1}ìœ„` });
    });
    html += '</div>';

    // 2. ê²ŒìŠ¤íŠ¸ ì„¹ì…˜ (ê²ŒìŠ¤íŠ¸ê°€ ìˆì„ ë•Œë§Œ ì¶œë ¥)
    if (guests.length > 0) {
      html += '<div style="width:100%; margin:10px 0 15px; border-top:1px dashed #ddd; position:relative;">';
      html += '<span style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:#fff; padding:0 10px; font-size:11px; color:#999; font-weight:bold;">GUEST LIST</span>';
      html += '</div>';

      html += '<div style="display:flex !important; flex-wrap:wrap !important; justify-content:flex-start !important; gap:8px;">';
      guests.forEach((p, i) => {
        html += createPlayerOption({ inputType:"radio", nameAttr:"statsPick", id:`stat_g_${i}`, value:p.name, checked:false, onClick:`viewStats('${escapeHtml(p.name).replace(/'/g,"&#39;")}')`, labelText:`[G] ${escapeHtml(displayName(p.name))}`, isGuest:true, showRank:false });
      });
      html += '</div>';
    }

    html += '</div>';

    $('stats-pList').innerHTML = html;
  }


  function isInTeam(teamArr, name) {
    return Array.isArray(teamArr) && teamArr.includes(name);
  }

  function getOpponentNames(log, name) {
    const homeHas = isInTeam(log.home, name);
    const awayHas = isInTeam(log.away, name);
    if (!homeHas && !awayHas) return [];
    return homeHas ? (log.away || []) : (log.home || []);
  }

  function getPartnerNames(log, name) {
    if (log.type !== "double") return [];
    const homeHas = isInTeam(log.home, name);
    const awayHas = isInTeam(log.away, name);
    if (!homeHas && !awayHas) return [];
    const team = homeHas ? (log.home || []) : (log.away || []);
    return team.filter(n => n !== name);
  }

  function didPlayerWin(log, name) {
    const homeHas = isInTeam(log.home, name);
    const awayHas = isInTeam(log.away, name);
    if (!homeHas && !awayHas) return null;
    if (log.winner === "home") return homeHas;
    if (log.winner === "away") return awayHas;
    const hs = Number(log.hs ?? 0), as = Number(log.as ?? 0);
    if (hs === as) return null;
    const homeWin = hs > as;
    return homeWin ? homeHas : awayHas;
  }

  function rateText(w,l) {
    const t = (w||0)+(l||0);
    return t>0 ? (((w||0)/t)*100).toFixed(1) : "0.0";
  }

  function pickBestByRule(map, preferHigh=true) {
    const entries = Object.entries(map);
    if (entries.length === 0) return null;

    entries.sort((a,b)=>{
      const A=a[1], B=b[1];
      const Ar = (A.w+A.l)>0 ? A.w/(A.w+A.l) : 0; // ë‚´ ìŠ¹ë¥ 
      const Br = (B.w+B.l)>0 ? B.w/(B.w+B.l) : 0;

      if (preferHigh) {
        if (Br !== Ar) return Br - Ar;                 // ìŠ¹ë¥  ë†’ì€ ìˆœ
        if (B.w !== A.w) return B.w - A.w;             // ìŠ¹ ìˆ˜ ë§ì€ ìˆœ
        if (B.totalGames !== A.totalGames) return B.totalGames - A.totalGames; // í‘œë³¸ í° ìˆœ
      } else {
        if (Ar !== Br) return Ar - Br;                 // ë‚´ ìŠ¹ë¥  ë‚®ì€ ìˆœ
        if (B.totalGames !== A.totalGames) return B.totalGames - A.totalGames; // í‘œë³¸ í° ìˆœ
        if (B.l !== A.l) return B.l - A.l;             // ë‚´ê°€ ë” ë§ì´ ì§„ ìƒëŒ€ ìš°ì„ 
      }
      return a[0].localeCompare(b[0]);
    });

    return { name: entries[0][0], stat: entries[0][1] };
  }

  
  // âœ… v3.692: í†µê³„ ê³„ì‚°(ë°ì´í„°/HTML ì¤€ë¹„) - matchLog ê¸°ë°˜
  function computeStatsFromMatchLog(name) {
    const logs = normalizeMatchLog(matchLog)
      .filter(l => isInTeam(l.home, name) || isInTeam(l.away, name))
      .sort((a,b)=>(b.ts||0)-(a.ts||0));

    const recent = logs.slice(0,10);
    const recentResults = recent
      .map(l => didPlayerWin(l, name))
      .filter(v => v === true || v === false);

    const displayResults = recentResults.slice().reverse();

    const dotsHTML =
      (displayResults.length ? displayResults : Array.from({length:10},()=>false))
        .slice(0,10)
        .map(win => `<div class="form-dot ${win?'win-dot':'loss-dot'}"></div>`)
        .join('');

    let streak = 0;
    let lastResult = displayResults.length ? displayResults[displayResults.length - 1] : null;

    if (lastResult !== null) {
      for (let i = displayResults.length - 1; i >= 0; i--) {
        if (displayResults[i] === lastResult) streak++;
        else break;
      }
    }

    // í•˜ë‹¨ ì „ì í‘œ(ë‹¨/ë³µ/ì¢…í•©) - matchLog ì‹¤ì‹œê°„ ì¬ì§‘ê³„
    let sWins = 0, sLosses = 0, sScore = 0;
    let dWins = 0, dLosses = 0, dScore = 0;

    logs.forEach(l => {
      const win = didPlayerWin(l, name);
      if (win === null) return;

      const t = (l.type === "double") ? "double" : "single";
      const d = calcDeltas(t, win);

      if (t === "double") {
        dScore += (d.d || 0);
        if (win) dWins++; else dLosses++;
      } else {
        sScore += (d.s || 0);
        if (win) sWins++; else sLosses++;
      }
    });

    const totalWins = sWins + dWins;
    const totalLosses = sLosses + dLosses;
    const totalPt = (Number(sScore) + Number(dScore)).toFixed(1);

    const tableHTML = `
      <tr><td>ë‹¨ì‹ ì „ì </td><td>${rateText(sWins, sLosses)}%</td><td>${sWins}ìŠ¹ ${sLosses}íŒ¨</td><td>${Number(sScore).toFixed(1)}</td></tr>
      <tr><td>ë³µì‹ ì „ì </td><td>${rateText(dWins, dLosses)}%</td><td>${dWins}ìŠ¹ ${dLosses}íŒ¨</td><td>${Number(dScore).toFixed(1)}</td></tr>
    `;
    const footHTML = `
      <tr style="background:#f9f9f9; font-weight: bold; border-top: 2px solid var(--wimbledon-sage);">
        <td>ì¢…í•© ì „ì </td><td>${rateText(totalWins, totalLosses)}%</td><td>${totalWins}ìŠ¹ ${totalLosses}íŒ¨</td>
        <td style="color:var(--wimbledon-sage);">${totalPt} pt</td>
      </tr>
    `;

    // ìƒëŒ€/íŒŒíŠ¸ë„ˆ/ì²œì  ë§µ
    const singleOppMap = {};
    const partnerMap = {};
    const doubleEnemyMap = {};

    logs.forEach(l => {
      const win = didPlayerWin(l, name);
      if (win === null) return;

      if (l.type === "single") {
        const opps = getOpponentNames(l, name);
        opps.forEach(op => {
          if(HIDDEN_PLAYERS.includes(op)) return;
          if(!singleOppMap[op]) singleOppMap[op] = { w:0, l:0, totalGames:0 };
          if(win) singleOppMap[op].w++; else singleOppMap[op].l++;
          singleOppMap[op].totalGames++;
        });
      }

      if (l.type === "double") {
        const partners = getPartnerNames(l, name);
        partners.forEach(pt => {
          if(HIDDEN_PLAYERS.includes(pt)) return;
          if(!partnerMap[pt]) partnerMap[pt] = { w:0, l:0, totalGames:0 };
          if(win) partnerMap[pt].w++; else partnerMap[pt].l++;
          partnerMap[pt].totalGames++;
        });

        const opps = getOpponentNames(l, name);
        opps.forEach(op => {
          if(HIDDEN_PLAYERS.includes(op)) return;
          if(!doubleEnemyMap[op]) doubleEnemyMap[op] = { w:0, l:0, totalGames:0 };
          if(win) doubleEnemyMap[op].w++; else doubleEnemyMap[op].l++;
          doubleEnemyMap[op].totalGames++;
        });
      }
    });

    const sBestRaw = pickBestByRule(singleOppMap, true);
    const sBest = (sBestRaw && sBestRaw.stat.w >= 1) ? sBestRaw : null;
    const sWorst = pickBestByRule(singleOppMap, false);
    // âœ… v3.8205_4: ìµœê³  íŒŒíŠ¸ë„ˆ â€” ìŠ¹ 1ê°œ ì´ìƒì¸ íŒŒíŠ¸ë„ˆ ì¤‘ ìŠ¹ë¥  ìµœê³ 
    const dBestPartnerRaw = pickBestByRule(partnerMap, true);
    const dBestPartner = (dBestPartnerRaw && dBestPartnerRaw.stat.w >= 1) ? dBestPartnerRaw : null;

    // âœ… v3.8205_4: ë¶„ë°œ íŒŒíŠ¸ë„ˆ â€” ìŠ¹ 0ê°œì´ê±°ë‚˜ ìŠ¹ë¥  ìµœì €, ìµœê³  íŒŒíŠ¸ë„ˆì™€ ë‹¤ë¥¸ ì‚¬ëŒ
    const dWorstPartnerRaw = pickBestByRule(partnerMap, false);
    const dWorstPartner = (() => {
      if (!dWorstPartnerRaw) return null;
      const s = dWorstPartnerRaw.stat;
      const hasloss = s.l >= 1;
      const diffFromBest = !dBestPartner || dWorstPartnerRaw.name !== dBestPartner.name;
      return (hasloss && diffFromBest) ? dWorstPartnerRaw : null;
    })();

    // âœ… v3.8202: ë¼ì´ë²Œ(ì²œì ) - ìƒëŒ€ì—ê²Œ íŒ¨ê°€ 1ê°œ ì´ìƒì¼ ë•Œë§Œ í‘œì‹œ
    const dEnemies = Object.entries(doubleEnemyMap)
      .filter(([,s]) => s.l >= 1)  // ë‚´ê°€ ì§„ ì  ìˆëŠ” ìƒëŒ€ë§Œ
      .sort((a,b)=>{
        const Ar=(a[1].w+a[1].l)>0?a[1].w/(a[1].w+a[1].l):0, Br=(b[1].w+b[1].l)>0?b[1].w/(b[1].w+b[1].l):0;
        return Ar-Br || b[1].totalGames-a[1].totalGames;
      });
    const dE1 = dEnemies[0], dE2 = dEnemies[1];

    // âœ… v3.8202: ë‹¨ì‹ ë¼ì´ë²Œ(ì²œì ) - íŒ¨ê°€ 1ê°œ ì´ìƒì¼ ë•Œë§Œ
    const sWorstFiltered = (() => {
      if (!sWorst) return null;
      return sWorst.stat.l >= 1 ? sWorst : null;
    })();

    return {
      logs, dotsHTML, displayResults, streak, lastResult,
      sWins, sLosses, sScore, dWins, dLosses, dScore, totalWins, totalLosses, totalPt,
      tableHTML, footHTML,
      sBest, sWorst: sWorstFiltered, dBestPartner, dWorstPartner, dE1, dE2
    };
  }

  // âœ… v3.692: í†µê³„ ë Œë”(í™”ë©´ ë°˜ì˜)
  function renderStatsHTML(name, data) {
    // ìµœê·¼ í¼(ì )
    $('form-dots').innerHTML = data.dotsHTML;

    // ì¡°ì–¸ ë°•ìŠ¤
    const adviceBox = $('advice-box');
    const adviceText = $('res-advice');

    if (data.lastResult === true && data.streak >= 2) {
      adviceBox.style.background = "var(--wimbledon-sage)";
      adviceText.innerHTML = `ğŸ”¥ ìµœê·¼ ${data.streak}ì—°ìŠ¹ ìŠ¤íƒ€íŠ¸! ì§€ê¸ˆ í¼ì´ ì¢‹ìŠµë‹ˆë‹¤. <br>ë¦¬í„´ í•œ ë²ˆë§Œ ë” ë¶™ì´ë©´ ê±°ì˜ ëì…ë‹ˆë‹¤.`;
    } else if (data.lastResult === false && data.streak >= 2) {
      adviceBox.style.background = "var(--up-red)";
      adviceText.innerHTML = `ğŸ˜° ìµœê·¼ ${data.streak}ì—°íŒ¨â€¦ í•˜ì§€ë§Œ ì´ëŸ´ ë•Œ í•œ ë²ˆë§Œ ëŠìœ¼ë©´ ë°”ë¡œ ë°˜ë“±í•©ë‹ˆë‹¤. <br>ì²« 2ê²Œì„ì€ â€˜ì‹¤ìˆ˜ ìµœì†Œâ€™ ëª¨ë“œë¡œ ê°€ëŠ” ê²Œ ì¢‹ìŠµë‹ˆë‹¤.`;
    } else {
      adviceBox.style.background = "var(--aussie-blue)";
      adviceText.innerHTML = `ğŸ¾ ìµœê·¼ í¼ì´ ì¡°ê¸ˆ ì¶œë ì…ë‹ˆë‹¤. <br>ì„œë¸Œ/ë¦¬í„´ ì¤‘ í•˜ë‚˜ë§Œ ì•ˆì •ì‹œí‚¤ë©´ ì—°ìŠ¹ íë¦„ì´ ì¡í™ë‹ˆë‹¤.`;
    }

    // í•˜ë‹¨ ì „ì í‘œ
    $('res-table').innerHTML = data.tableHTML;
    $('res-foot').innerHTML = data.footHTML;

    // ìƒë‹¨ ë¶„ì„(ìµœê³ /ìµœì•…/íŒŒíŠ¸ë„ˆ/ì²œì )
    const isValid = (obj) => obj && (obj.w + obj.l) > 0;

    $('res-s-best').innerText = (data.sBest && isValid(data.sBest.stat)) ? displayName(data.sBest.name) : "-";
    $('res-s-best-sub').innerText = (data.sBest && isValid(data.sBest.stat)) ? `${data.sBest.stat.w}ìŠ¹ ${data.sBest.stat.l}íŒ¨` : "0ìŠ¹ 0íŒ¨";

    $('res-s-worst').innerText = (data.sWorst && isValid(data.sWorst.stat)) ? displayName(data.sWorst.name) : "-";
    $('res-s-worst-sub').innerText = (data.sWorst && isValid(data.sWorst.stat)) ? `${data.sWorst.stat.w}ìŠ¹ ${data.sWorst.stat.l}íŒ¨` : "0ìŠ¹ 0íŒ¨";

    $('res-d-partner').innerText = (data.dBestPartner && isValid(data.dBestPartner.stat)) ? displayName(data.dBestPartner.name) : "-";
    $('res-d-partner-sub').innerText = (data.dBestPartner && isValid(data.dBestPartner.stat)) ? `${data.dBestPartner.stat.w}ìŠ¹ ${data.dBestPartner.stat.l}íŒ¨` : "0ìŠ¹ 0íŒ¨";

    $('res-d-partner-worst').innerText = (data.dWorstPartner && isValid(data.dWorstPartner.stat)) ? displayName(data.dWorstPartner.name) : "-";
    $('res-d-partner-worst-sub').innerText = (data.dWorstPartner && isValid(data.dWorstPartner.stat)) ? `${data.dWorstPartner.stat.w}ìŠ¹ ${data.dWorstPartner.stat.l}íŒ¨` : "0ìŠ¹ 0íŒ¨";

    $('res-d-enemy1').innerText = (data.dE1 && isValid(data.dE1[1])) ? displayName(data.dE1[0]) : "-";
    $('res-d-enemy1-sub').innerText = (data.dE1 && isValid(data.dE1[1])) ? `${data.dE1[1].w}ìŠ¹ ${data.dE1[1].l}íŒ¨` : "0ìŠ¹ 0íŒ¨";

    $('res-d-enemy2').innerText = (data.dE2 && isValid(data.dE2[1])) ? displayName(data.dE2[0]) : "-";
    $('res-d-enemy2-sub').innerText = (data.dE2 && isValid(data.dE2[1])) ? `${data.dE2[1].w}ìŠ¹ ${data.dE2[1].l}íŒ¨` : "0ìŠ¹ 0íŒ¨";
  }


  function viewStats(name) {
    const p = players.find(x => x.name === name);
    if(!p) return;

    $('welcome-msg').style.display = 'none';
    const report = $('stats-report');
    report.style.display = 'block';
    $('target-name-text').innerText = `${displayName(name)} ë¶„ì„ ë¦¬í¬íŠ¸`;

    const data = computeStatsFromMatchLog(name);
    renderStatsHTML(name, data);

    report.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  
  
  // âœ… Splash(ì¸íŠ¸ë¡œ) ì•ˆì „ ì¢…ë£Œ: ë„¤íŠ¸ì›Œí¬/CDN ì§€ì—°ìœ¼ë¡œ window.loadê°€ ëŠ¦ì–´ì ¸ë„ ì•±ì´ ë©ˆì¶˜ ê²ƒì²˜ëŸ¼ ë³´ì´ì§€ ì•Šê²Œ
  function hideSplashSafe() {
    const sp = $('splash');
    if (!sp) return;
    // ì´ë¯¸ ìˆ¨ê¹€ ì²˜ë¦¬ëœ ê²½ìš° ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (sp.dataset.hidden === '1') return;
    sp.dataset.hidden = '1';
    sp.classList.add('hide');
    setTimeout(() => { sp.style.display = 'none'; }, 700);
  }

  // âœ… v3.817: DOMContentLoadedë¡œ ë³€ê²½ + ë³‘ë ¬ fetchë¡œ ìŠ¤í”Œë˜ì‹œ ë”œë ˆì´ ìµœì†Œí™”
  document.addEventListener("DOMContentLoaded", async () => {
    // âœ… v3.79: í´ëŸ½ ì‹œìŠ¤í…œ ì´ˆê¸°í™” (sync ì „ì— ì™„ë£Œë˜ì–´ì•¼ ì˜¬ë°”ë¥¸ clubId ì„¤ì •ë¨)
    try { await initClubSystem(); } catch(e) { console.error("initClubSystem() error:", e); }

    // âœ… v3.817: sync ì™„ë£Œ í›„ ì¦‰ì‹œ ìŠ¤í”Œë˜ì‹œ ìˆ¨ê¹€ (ì½”íŠ¸/ê³µì§€ëŠ” ë³‘ë ¬ë¡œ)
    try { await sync(); } catch(e) { console.error("sync() error:", e); }

    // ìŠ¤í”Œë˜ì‹œëŠ” sync ì™„ë£Œ ì¦‰ì‹œ ìˆ¨ê¹€
    hideSplashSafe();

    // ë‚ ì”¨/ì½”íŠ¸/ê³µì§€ëŠ” ìŠ¤í”Œë˜ì‹œì™€ ë¬´ê´€í•˜ê²Œ ë³‘ë ¬ ì²˜ë¦¬
    try { loadWeatherForNextMeeting(0); } catch(e) { console.error("loadWeather() error:", e); }
    Promise.all([
      fetchCourtNotices().catch(e => console.warn("fetchCourtNotices error:", e)),
      fetchAnnouncements().catch(e => console.warn("fetchAnnouncements error:", e))
    ]).then(() => {
      try { loadCourtInfo(); loadNotices(); } catch(e) { console.warn("home render error:", e); }
    });

    // âœ… v3.79: ì—°ìŠµ/ì‹¤ì „ ëª¨ë“œ ë²„íŠ¼ ìƒíƒœ ë³µì›
    try {
      const btn = $('btnTourMode');
      if (btn && isPracticeMode === 'real') {
        btn.innerText = "ğŸŸ¥ ì‹¤ì „ ëª¨ë“œ (ëª¨ë“  ê¸°ë¡ ë°˜ì˜ O)";
        btn.style.background = "#FF3B30";
      }
    } catch(e) {}

    setTimeout(() => { 
      try { applyAutofitAllTables(); } catch(e) { console.error("applyAutofitAllTables() error:", e); }
    }, 0);
  });
window.addEventListener("resize", () => {
    updateSeason();
    updateWeekly();
    setTimeout(applyAutofitAllTables, 0);
  });

  // ========================================
  // ROUND MODE FUNCTIONS
  // ========================================

  function openRound() {
    // ë¼ìš´ë“œ í™”ë©´ ì§„ì…
    showView('round');

    // ë­í‚¹/ìˆœìœ„ ê³„ì‚°ì´ ê¹¨ì ¸ë„ ë¼ìš´ë“œ ì„ ìˆ˜ëª…ë‹¨ì€ ë¬´ì¡°ê±´ ëœ¨ê²Œ (ë°©ì–´)
    try {
      snapshotLastRanks();
      const rankMap = computeRanksByScoreOnly('score', 'wins', 'losses');
      players.forEach(p => { p.rank = rankMap[p.name] || p.rank || '-'; });
    } catch (e) {
      console.warn('[round] rank compute failed:', e);
    }

    initRoundPlayerPool();
  }

  function setRoundOpt(opt) {
    roundOpt = opt;
    ['rank', 'random', 'manual'].forEach(o => {
      const btn = $(`round-opt-${o}`);
      if(o === opt) btn.classList.add('active');
      else btn.classList.remove('active');
    });
    
    // ì§€ì •ì„ íƒ + ë³µì‹ì´ë©´ íŒ€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    if(opt === 'manual' && roundMode === 'double') {
      updateRoundManualTeamPreview();
    } else {
      $('round-manual-team-box').style.display = 'none';
    }
    
    checkRoundGenButton();
  }

  function setRoundMode(mode) {
    roundMode = mode;
    ['single', 'double'].forEach(m => {
      const btn = $(`round-mode-${m}`);
      if(m === mode) btn.classList.add('active');
      else btn.classList.remove('active');
    });
    
    // ë‹¨ì‹ì¼ ë•ŒëŠ” ë°°ì¹˜ ë°©ì‹ ë¹„í™œì„±í™” (ì–´ì°¨í”¼ í’€ë¦¬ê·¸)
    const optBtns = ['round-opt-rank', 'round-opt-random', 'round-opt-manual'];
    if(mode === 'single') {
      optBtns.forEach(id => {
        const btn = $(id);
        if(btn) {
          btn.disabled = true;
          btn.style.opacity = '0.4';
          btn.style.cursor = 'not-allowed';
        }
      });
    } else {
      optBtns.forEach(id => {
        const btn = $(id);
        if(btn) {
          btn.disabled = false;
          btn.style.opacity = '';
          btn.style.cursor = 'pointer';
        }
      });
    }
    
    // ì§€ì •ì„ íƒ + ë³µì‹ì´ë©´ íŒ€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    if(roundOpt === 'manual' && mode === 'double') {
      updateRoundManualTeamPreview();
    } else {
      $('round-manual-team-box').style.display = 'none';
    }
    
    checkRoundGenButton();
  }

  function initRoundPlayerPool() {
    const pList = $('round-pList');
    if(!pList) return;

    // â­ ìˆ˜ì •: UI ì´ˆê¸°í™” - ì„¤ì • í™”ë©´ë§Œ í‘œì‹œ, ë­í‚¹/ëŒ€ì§„í‘œëŠ” ì™„ì „íˆ ìˆ¨ê¹€
    const setupArea = $('round-setup-area');
    const matchArea = $('round-match-area');
    
    if(setupArea) setupArea.style.display = 'block';
    if(matchArea) matchArea.style.display = 'none';  // ì™„ì „íˆ ìˆ¨ê¹€
    
    // ë¯¸ë‹ˆ í† ë„ˆë¨¼íŠ¸ ë°ì´í„° ì´ˆê¸°í™”
    miniTournamentMatches = [];
    miniTournamentRound = 0;

    // 1) ìˆœìœ„ ê³„ì‚°(ì•ˆì „) + ë©¤ë²„ ì •ë ¬(ì ìˆ˜ ë†’ì€ ìˆœ)
    let rankMap = {};
    try {
      rankMap = computeRanksByScoreOnly('score', 'wins', 'losses');
    } catch(e) {
      console.warn('[round] computeRanksByScoreOnly failed:', e);
      rankMap = {};
    }

    const members = players.filter(p => !p.isGuest)
      .sort((a,b) => ((b?.score)||0) - ((a?.score)||0));

    // rank í•„ë“œë„ ë¯¸ë¦¬ ì„¸íŒ… (ë‹¤ë¥¸ ê³³ì—ì„œ ì“¸ ìˆ˜ë„ ìˆìœ¼ë‹ˆê¹Œ)
    members.forEach((p, idx) => { p.rank = rankMap[p.name] || p.rank || (idx+1); });

    // âœ… v3.816: HIDDEN_PLAYERS ì œì™¸
    const guests = players.filter(p => p.isGuest && !HIDDEN_PLAYERS.includes(p.name));

    let html = '<div style="display:flex; flex-wrap:wrap; gap:8px;">';

    // 2) íšŒì› ë²„íŠ¼
    members.forEach((p, idx) => {
      const rankStr = `${p.rank || (idx+1)}ìœ„`;
      html += createPlayerOption({
        inputType: 'checkbox',
        nameAttr: 'round-player',
        id: `round-p-${p.name}`,
        value: p.name,
        checked: false,
        onClick: 'updateRoundCount(); checkRoundGenButton();',
        labelText: displayName(p.name),
        isGuest: false,
        showRank: true,
        rankText: rankStr
      });
    });

    // 3) ê²ŒìŠ¤íŠ¸ ë²„íŠ¼ (âœ… v3.818: 1ëŒ€2ëŒ€ê²°ìš© ë²„íŠ¼ ì œì™¸)
    if(guests.length > 0) {
      html += '</div>';
      html += '<div style="width:100%; margin:10px 0 15px; border-top:1px dashed #ddd; position:relative;">';
      html += '<span style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:white; padding:0 10px; font-size:11px; color:#999; font-weight:bold;">GUEST LIST</span>';
      html += '</div>';
      html += '<div style="display:flex; flex-wrap:wrap; gap:8px;">';
      guests.forEach(p => {
        html += createPlayerOption({
          inputType: 'checkbox',
          nameAttr: 'round-player',
          id: `round-p-${p.name}`,
          value: p.name,
          checked: false,
          onClick: 'updateRoundCount(); checkRoundGenButton();',
          labelText: displayName(p.name),
          isGuest: true,
          showRank: true,
          rankText: 'G'
        });
      });
    }

    // âœ… v3.8207: ë‹¹ì¼ ê²ŒìŠ¤íŠ¸ ì„¹ì…˜
    if (oneTimePlayers.length > 0) {
      html += '</div>';
      html += '<div style="width:100%; margin:10px 0 15px; border-top:1px dashed #ddd; position:relative;">';
      html += '<span style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:white; padding:0 10px; font-size:11px; color:var(--aussie-blue); font-weight:bold;">ë‹¹ì¼ ê²ŒìŠ¤íŠ¸</span>';
      html += '</div>';
      html += '<div style="display:flex; flex-wrap:wrap; gap:8px;">';
      oneTimePlayers.forEach((name, i) => {
        html += createPlayerOption({
          inputType: 'checkbox',
          nameAttr: 'round-player',
          id: `round-ot-${i}`,
          value: name,
          checked: false,
          onClick: 'updateRoundCount(); checkRoundGenButton();',
          labelText: '[ë‹¹ì¼] ' + displayName(name),
          isGuest: true,
          showRank: false,
          rankText: ''
        });
      });
    }

    html += '</div>';
    pList.innerHTML = html;
    
    // â­ ë Œë”ë§ í›„ ì¹´ìš´íŠ¸ ìë™ ì—…ë°ì´íŠ¸
    updateRoundCount();
  }

  function renderRoundPlayerList() {
    // ê¸°ì¡´ í˜¸ì¶œë¶€ í˜¸í™˜ìš©
    initRoundPlayerPool();
  }

    
  function updateRoundCount() {
    const checked = document.querySelectorAll('input[name="round-player"]:checked');
    $('round-cnt').innerText = checked.length;
    
    if(roundOpt === 'manual' && roundMode === 'double') {
      updateRoundManualTeamPreview();
    }
  }

  function updateRoundManualTeamPreview() {
    const box = $('round-manual-team-box');
    const list = $('round-manual-team-list');
    const checked = Array.from(document.querySelectorAll('input[name="round-player"]:checked')).map(c => c.value);
    
    if(checked.length < 4 || checked.length % 2 !== 0) {
      box.style.display = 'none';
      return;
    }
    
    box.style.display = 'block';
    let html = '';
    for(let i = 0; i < checked.length; i += 2) {
      const teamNo = (i/2) + 1;
      html += `<div class="team-chip"><span class="chip-no">${teamNo}</span>${displayName(checked[i])} & ${displayName(checked[i+1])}</div>`;
    }
    list.innerHTML = html;
  }

  function checkRoundGenButton() {
    const checked = document.querySelectorAll('input[name="round-player"]:checked');
    const btn = $('round-gen-btn');
    
    let minCount = roundMode === 'single' ? 3 : 4;
    if(roundMode === 'double' && checked.length % 2 !== 0) {
      btn.style.opacity = '0.6';
      btn.style.background = 'var(--roland-clay)';
      return;
    }
    
    if(checked.length >= minCount) {
      btn.style.opacity = '1';
      btn.style.background = 'var(--aussie-blue)';
    } else {
      btn.style.opacity = '0.6';
      btn.style.background = 'var(--roland-clay)';
    }
  }

  function generateRoundSchedule() {
    const checked = Array.from(document.querySelectorAll('input[name="round-player"]:checked')).map(c => c.value);
    
    // âœ… ë¼ìš´ë“œ ìƒì„± ë²„íŠ¼ í´ë¦­ ì‹œ ê¸°ì¡´ ë§¤ì¹˜ ê°•ì œ ì´ˆê¸°í™”
    roundMatches = [];
    roundResults = [];
    
    if(roundMode === 'single' && checked.length < 3) {
      gsAlert('ë‹¨ì‹ì€ ìµœì†Œ 3ëª… ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤.');
      return;
    }
    
    if(roundMode === 'double') {
      if(checked.length < 4) {
        gsAlert('ë³µì‹ì€ ìµœì†Œ 4ëª…(2íŒ€) ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }
      if(checked.length % 2 !== 0) {
        gsAlert('ë³µì‹ì€ ì§ìˆ˜ ì¸ì›ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }
    }
    
    // ì°¸ê°€ì êµ¬ì„±
    if(roundMode === 'single') {
      roundParticipants = [...checked];
    } else {
      // ë³µì‹: íŒ€ êµ¬ì„±
      let teams = [];
      if(roundOpt === 'rank') {
        // ë­í‚¹ìˆœìœ¼ë¡œ ì •ë ¬ í›„ ìˆœì„œëŒ€ë¡œ íŒ€ êµ¬ì„±
        const sorted = checked.sort((a, b) => {
          const pA = players.find(p => p.name === a);
          const pB = players.find(p => p.name === b);
          return (pA.rank || 999) - (pB.rank || 999);
        });
        for(let i = 0; i < sorted.length; i += 2) {
          teams.push([sorted[i], sorted[i+1]]);
        }
      } else if(roundOpt === 'random') {
        const shuffled = shuffleArray([...checked]);
        for(let i = 0; i < shuffled.length; i += 2) {
          teams.push([shuffled[i], shuffled[i+1]]);
        }
      } else {
        // manual: ì„ íƒ ìˆœì„œëŒ€ë¡œ
        for(let i = 0; i < checked.length; i += 2) {
          teams.push([checked[i], checked[i+1]]);
        }
      }
      roundParticipants = teams;
    }
    
    // ë§¤ì¹˜ ìƒì„± (Round Robin - Circle Method)
    roundMatches = generateRoundRobinMatches(roundParticipants);
    roundResults = [];
    
    // UI ì „í™˜
    $('round-setup-area').style.display = 'none';
    $('round-match-area').style.display = 'block';
    
    renderRoundMatches();
    updateRoundRanking();
  }

  function generateRoundRobinMatches(participants) {
    let items = [...participants];

    // í™€ìˆ˜ë©´ BYE ì¶”ê°€(ë§¤ì¹˜ ìƒì„± ì‹œ BYEëŠ” ìë™ ìŠ¤í‚µ)
    if(items.length % 2 === 1) {
      items.push('BYE');
    }

    const matches = [];
    const seen = new Set();
    const keyOf = (p) => Array.isArray(p) ? p.join('&') : String(p);

    for(let i = 0; i < items.length; i++) {
      for(let j = i + 1; j < items.length; j++) {
        const a = items[i];
        const b = items[j];

        if(a === 'BYE' || b === 'BYE') continue;

        const aKey = keyOf(a);
        const bKey = keyOf(b);

        // ê³ ìœ  í‚¤(ì„ ìˆ˜ì´ë¦„1-ì„ ìˆ˜ì´ë¦„2)ë¡œ ì¤‘ë³µ ì•ˆì „ì¥ì¹˜
        const id = `${aKey}-${bKey}`;
        const idRev = `${bKey}-${aKey}`;
        if(seen.has(id) || seen.has(idRev)) continue;
        seen.add(id);

        matches.push({
          id,
          round: 1,
          home: a,
          away: b,
          winner: null
        });
      }
    }

    return matches;
  }

  function renderRoundMatches() {
    const list = $('round-match-list');
    let html = '';
    
    roundMatches.forEach(m => {
      const isFinished = m.winner !== null;
      const homeDisplay = roundMode === 'single' ? displayName(m.home) : `${displayName(m.home[0])} & ${displayName(m.home[1])}`;
      const awayDisplay = roundMode === 'single' ? displayName(m.away) : `${displayName(m.away[0])} & ${displayName(m.away[1])}`;
      
      html += `
        <div class="team-box" style="margin-bottom:10px; padding:12px; ${isFinished ? 'opacity:0.5;' : ''}">
          <div style="font-size:11px; color:var(--text-gray); margin-bottom:8px;">${m.id}</div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button onclick="setRoundWinner('${m.id}', 'home')" 
              class="opt-btn" 
              style="flex:1; padding:10px; ${m.winner === 'home' ? 'background:var(--wimbledon-sage); opacity:1;' : 'opacity:0.7;'}">
              ${homeDisplay}
            </button>
            <div style="font-size:14px; color:var(--text-gray);">vs</div>
            <button onclick="setRoundWinner('${m.id}', 'away')" 
              class="opt-btn" 
              style="flex:1; padding:10px; ${m.winner === 'away' ? 'background:var(--wimbledon-sage); opacity:1;' : 'opacity:0.7;'}">
              ${awayDisplay}
            </button>
          </div>
        </div>
      `;
    });
    
    list.innerHTML = html || '<div style="text-align:center; color:#ccc; padding:20px;">ë§¤ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
  }

  function setRoundWinner(matchId, side) {
    const match = roundMatches.find(m => m.id === matchId);
    if(!match) return;
    
    match.winner = side;
    renderRoundMatches();
    updateRoundRanking();
    checkRoundSaveButton();
  }

  function updateRoundRanking() {
    // ìˆœìœ„ ê³„ì‚° (Kimjak Algorithm)
    const standings = {};
    
    // ì°¸ê°€ì ì´ˆê¸°í™”
    roundParticipants.forEach(p => {
      const key = roundMode === 'single' ? p : p.join('&');
      standings[key] = {
        name: p,
        wins: 0,
        losses: 0,
        matches: 0,
        points: 0,
        h2h: {} // head to head
      };
    });
    
    // ê²½ê¸° ê²°ê³¼ ë°˜ì˜
    roundMatches.forEach(m => {
      if(m.winner === null) return;
      
      const homeKey = roundMode === 'single' ? m.home : m.home.join('&');
      const awayKey = roundMode === 'single' ? m.away : m.away.join('&');
      
      standings[homeKey].matches++;
      standings[awayKey].matches++;
      
      if(m.winner === 'home') {
        standings[homeKey].wins++;
        standings[awayKey].losses++;
        standings[homeKey].h2h[awayKey] = (standings[homeKey].h2h[awayKey] || 0) + 1;
      } else {
        standings[awayKey].wins++;
        standings[homeKey].losses++;
        standings[awayKey].h2h[homeKey] = (standings[awayKey].h2h[homeKey] || 0) + 1;
      }
    });
    
    // â­ ì¶”ê°€: ë¯¸ë‹ˆ í† ë„ˆë¨¼íŠ¸ ê²½ê¸° ê²°ê³¼ ë°˜ì˜ (ìŠ¹ë¦¬ë‹¹ +1ì ë§Œ, ë¶€ì „ìŠ¹ í¬í•¨)
    if(miniTournamentMatches && miniTournamentMatches.length > 0) {
      miniTournamentMatches.forEach(m => {
        if(m.winner === null) return;  // ì•„ì§ ê²°ê³¼ ì—†ëŠ” ê²½ê¸°ë§Œ ì œì™¸
        
        const homeKey = roundMode === 'single' ? m.home : m.home.join('&');
        const awayKey = m.away ? (roundMode === 'single' ? m.away : m.away.join('&')) : null;
        
        // ë¯¸ë‹ˆ í† ë„ˆë¨¼íŠ¸ëŠ” ìŠ¹/íŒ¨ ì¹´ìš´íŠ¸ ì˜¬ë¦¬ì§€ ì•Šê³  ì ìˆ˜ë§Œ ë³„ë„ ì¶”ê°€
        if(m.winner === 'home' && standings[homeKey]) {
          standings[homeKey].miniWins = (standings[homeKey].miniWins || 0) + 1;
        }
        if(m.winner === 'away' && awayKey && standings[awayKey]) {
          standings[awayKey].miniWins = (standings[awayKey].miniWins || 0) + 1;
        }
      });
    }
    
    // ìŠ¹ë¥  ë° ì ìˆ˜ ê³„ì‚°
    Object.values(standings).forEach(s => {
      s.winRate = s.matches > 0 ? s.wins / s.matches : 0;
      // ì´ì  ê³„ì‚° (ë³´ë„ˆìŠ¤ ì œì™¸, ìˆœìˆ˜ ê²½ê¸° íšë“ ì ìˆ˜)
      const winPoint = roundMode === 'single' ? 3 : 2;
      const losePoint = roundMode === 'single' ? -0.5 : -0.7;
      // ë¼ìš´ë“œ ë¡œë¹ˆ ì ìˆ˜ + ë¯¸ë‹ˆ í† ë„ˆë¨¼íŠ¸ ì ìˆ˜(ìŠ¹ë¦¬ë‹¹ +1ì )
      s.points = 1 + (s.wins * winPoint) + (s.losses * losePoint) + ((s.miniWins || 0) * 1);
    });
    
    // ì •ë ¬ (Kimjak Algorithm)
    // 1. ë‹¤ìŠ¹ 2. ìŠ¹ë¥  3. ìŠ¹ììŠ¹(2ì¸ ë™ë¥ ë§Œ) 4. ìµœì†ŒíŒ¨ 5. ê²½ê¸°ìˆ˜ 6. ì‹œì¦Œë­í‚¹
    const sorted = Object.values(standings).sort((a, b) => {
      // 1. ë‹¤ìŠ¹
      if(b.wins !== a.wins) return b.wins - a.wins;
      
      // 2. ìŠ¹ë¥ 
      if(Math.abs(b.winRate - a.winRate) > 0.001) return b.winRate - a.winRate;
      
      // 3. ìŠ¹ììŠ¹ (2ì¸ ë™ë¥ ë§Œ)
      const tiedGroup = Object.values(standings).filter(s => 
        Math.abs(s.wins - a.wins) < 0.001 && Math.abs(s.winRate - a.winRate) < 0.001
      );
      if(tiedGroup.length === 2) {
        const aKey = roundMode === 'single' ? a.name : a.name.join('&');
        const bKey = roundMode === 'single' ? b.name : b.name.join('&');
        if(a.h2h[bKey] > 0) return -1;
        if(b.h2h[aKey] > 0) return 1;
      }
      
      // 4. ìµœì†ŒíŒ¨
      if(a.losses !== b.losses) return a.losses - b.losses;
      
      // 5. ê²½ê¸°ìˆ˜
      if(b.matches !== a.matches) return b.matches - a.matches;
      
      // 6. ì‹œì¦Œë­í‚¹ (ë‹¨ì‹ ì„ íƒì‹œ ë‹¨ì‹ë­í‚¹, ë³µì‹ ì„ íƒì‹œ ë³µì‹ë­í‚¹)
      if(roundMode === 'single') {
        const pA = players.find(p => p.name === a.name);
        const pB = players.find(p => p.name === b.name);
        const rankA = pA ? (pA.sRank || 999) : 999;
        const rankB = pB ? (pB.sRank || 999) : 999;
        return rankA - rankB;
      } else {
        // ë³µì‹ì€ ë‘ ì„ ìˆ˜ì˜ í‰ê·  ë³µì‹ë­í‚¹
        const getAvgDoubleRank = (team) => {
          const p1 = players.find(p => p.name === team[0]);
          const p2 = players.find(p => p.name === team[1]);
          const r1 = p1 ? (p1.dRank || 999) : 999;
          const r2 = p2 ? (p2.dRank || 999) : 999;
          return (r1 + r2) / 2;
        };
        return getAvgDoubleRank(a.name) - getAvgDoubleRank(b.name);
      }
    });
    
    // ìˆœìœ„ í…Œì´ë¸” ë Œë”ë§
    const table = $('round-rank-table');
    let html = `
      <table class="tennis-table">
        <thead>
          <tr>
            <th>ìˆœìœ„</th>
            <th>${roundMode === 'single' ? 'ì„ ìˆ˜' : 'íŒ€'}</th>
            <th>ìŠ¹íŒ¨</th>
            <th>ìŠ¹ë¥ </th>
            <th>ì´ì </th>
          </tr>
        </thead>
        <tbody>
    `;
    
    sorted.forEach((s, idx) => {
      const nameDisplay = roundMode === 'single' ? displayName(s.name) : `${displayName(s.name[0])} & ${displayName(s.name[1])}`;
      html += `
        <tr>
          <td>${idx + 1}</td>
          <td>${nameDisplay}</td>
          <td>${s.wins}-${s.losses}</td>
          <td>${(s.winRate * 100).toFixed(0)}%</td>
          <td>${s.points.toFixed(1)}</td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    table.innerHTML = html;
  }

  function checkRoundSaveButton() {
    const finishedMatches = roundMatches.filter(m => m.winner !== null).length;
    const totalMatches = roundMatches.length;
    const saveBtn = $('round-save-btn');
    const tourBtn = $('round-tournament-btn');
    
    // ì¡°ê¸° ì¢…ë£Œ í—ˆìš©: 1ê²½ê¸° ì´ìƒ ì™„ë£Œ ì‹œ ì €ì¥ ê°€ëŠ¥
    if(finishedMatches > 0) {
      saveBtn.style.opacity = '1';
      saveBtn.style.background = 'var(--aussie-blue)';
      
      // í† ë„ˆë¨¼íŠ¸ ì „í™˜ë„ 1ê²½ê¸° ì´ìƒ ì™„ë£Œ ì‹œ ê°€ëŠ¥
      tourBtn.style.opacity = '1';
      tourBtn.style.background = 'var(--aussie-blue)';
    } else {
      saveBtn.style.opacity = '0.6';
      saveBtn.style.background = 'var(--roland-clay)';
      
      tourBtn.style.opacity = '0.6';
      tourBtn.style.background = 'var(--roland-clay)';
    }
  }

  function saveRoundResults() {
    const finishedMatches = roundMatches.filter(m => m.winner !== null);
    
    if(finishedMatches.length === 0) {
      gsAlert('ì™„ë£Œëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    if(isPracticeMode === 'practice') {
      gsAlert('âš ï¸ í˜„ì¬ ì—°ìŠµ ëª¨ë“œì…ë‹ˆë‹¤. ê¸°ë¡ì´ ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return;
    }
    
    gsConfirm(`${finishedMatches.length}ê²½ê¸°ì˜ ê²°ê³¼ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, ok => {
      if(!ok) return;
    
    // ìˆœìœ„ ê³„ì‚°
    const standings = {};
    roundParticipants.forEach(p => {
      const key = roundMode === 'single' ? p : p.join('&');
      standings[key] = { name: p, wins: 0, losses: 0, matches: 0, points: 0 };
    });
    
    finishedMatches.forEach(m => {
      const homeKey = roundMode === 'single' ? m.home : m.home.join('&');
      const awayKey = roundMode === 'single' ? m.away : m.away.join('&');
      
      standings[homeKey].matches++;
      standings[awayKey].matches++;
      
      if(m.winner === 'home') {
        standings[homeKey].wins++;
        standings[awayKey].losses++;
      } else {
        standings[awayKey].wins++;
        standings[homeKey].losses++;
      }
    });
    
    // ìŠ¹ë¥  ê³„ì‚°
    Object.values(standings).forEach(s => {
      s.winRate = s.matches > 0 ? s.wins / s.matches : 0;
    });
    
    // ì •ë ¬
    const sorted = Object.values(standings).sort((a, b) => {
      if(b.wins !== a.wins) return b.wins - a.wins;
      if(Math.abs(b.winRate - a.winRate) > 0.001) return b.winRate - a.winRate;
      if(a.losses !== b.losses) return a.losses - b.losses;
      return b.matches - a.matches;
    });
    
    // ì ìˆ˜ ë¶€ì—¬
    // 1ìœ„: +5, 2ìœ„: +4, 3ìœ„: +3, 4ìœ„: +2.5, 5-8ìœ„: +1.5, 9ìœ„ ì´í•˜: +0.1
    sorted.forEach((s, idx) => {
      let bonus = 0.1;
      if(idx === 0) bonus = 5;
      else if(idx === 1) bonus = 4;
      else if(idx === 2) bonus = 3;
      else if(idx === 3) bonus = 2.5;
      else if(idx < 8) bonus = 1.5;
      
      // ì°¸ì—¬ +1, ìŠ¹ë¦¬ë‹¹ +3 (ë‹¨ì‹) or +2 (ë³µì‹), íŒ¨ë°°ë‹¹ -0.5 (ë‹¨ì‹) or -0.7 (ë³µì‹)
      const winPoint = roundMode === 'single' ? 3 : 2;
      const losePoint = roundMode === 'single' ? -0.5 : -0.7;
      
      s.points = 1 + (s.wins * winPoint) + (s.losses * losePoint) + bonus;
    });
    
    // MatchLog ë° ì ìˆ˜ ë°˜ì˜
    finishedMatches.forEach(m => {
      const winner = m.winner === 'home' ? m.home : m.away;
      const loser = m.winner === 'home' ? m.away : m.home;
      
      const log = {
        date: new Date().toISOString().split('T')[0],
        type: roundMode,
        winner: roundMode === 'single' ? [winner] : winner,
        loser: roundMode === 'single' ? [loser] : loser
      };
      
      matchLog.push(log);
      
      // ì ìˆ˜ ë°˜ì˜
      if(roundMode === 'single') {
        const wp = players.find(p => p.name === winner);
        const lp = players.find(p => p.name === loser);
        
        if(wp) {
          wp.sWins = (wp.sWins || 0) + 1;
          wp.sScore = (wp.sScore || 0) + 4; // ìŠ¹ë¦¬ +3 + ì°¸ì—¬ +1
        }
        if(lp) {
          lp.sLosses = (lp.sLosses || 0) + 1;
          lp.sScore = (lp.sScore || 0) + 0.5; // íŒ¨ë°° -0.5 + ì°¸ì—¬ +1
        }
      } else {
        winner.forEach(name => {
          const p = players.find(pl => pl.name === name);
          if(p) {
            p.dWins = (p.dWins || 0) + 1;
            p.dScore = (p.dScore || 0) + 3; // ìŠ¹ë¦¬ +2 + ì°¸ì—¬ +1
          }
        });
        loser.forEach(name => {
          const p = players.find(pl => pl.name === name);
          if(p) {
            p.dLosses = (p.dLosses || 0) + 1;
            p.dScore = (p.dScore || 0) + 0.3; // íŒ¨ë°° -0.7 + ì°¸ì—¬ +1
          }
        });
      }
    });
    
    // ìˆœìœ„ ë³´ë„ˆìŠ¤ ì ìš©
    sorted.forEach((s, idx) => {
      let bonus = 0.1;
      if(idx === 0) bonus = 5;
      else if(idx === 1) bonus = 4;
      else if(idx === 2) bonus = 3;
      else if(idx === 3) bonus = 2.5;
      else if(idx < 8) bonus = 1.5;
      
      if(roundMode === 'single') {
        const p = players.find(pl => pl.name === s.name);
        if(p) p.sScore = (p.sScore || 0) + bonus;
      } else {
        s.name.forEach(name => {
          const p = players.find(pl => pl.name === name);
          if(p) p.dScore = (p.dScore || 0) + bonus;
        });
      }
    });
    
    // ì¡°ê¸° ì¢…ë£Œ ì„ ìˆ˜ì—ê²Œ ìµœì†Œ ë³´ë„ˆìŠ¤
    roundParticipants.forEach(participant => {
      const key = roundMode === 'single' ? participant : participant.join('&');
      const stat = standings[key];
      
      if(stat && stat.matches === 0) {
        if(roundMode === 'single') {
          const p = players.find(pl => pl.name === participant);
          if(p) p.sScore = (p.sScore || 0) + 0.1;
        } else {
          participant.forEach(name => {
            const p = players.find(pl => pl.name === name);
            if(p) p.dScore = (p.dScore || 0) + 0.1;
          });
        }
      }
    });
    
    // ì¬ê³„ì‚°
    computeAll();
    
    // ì €ì¥
    sync();
    
    gsAlert('ë¼ìš´ë“œ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    showView('game');
    }); // gsConfirm end
  }

  function resetRound() {
    gsConfirm('ë¼ìš´ë“œë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', ok => {
      if(!ok) return;
    
    roundParticipants = [];
    roundMatches = [];
    roundResults = [];
    miniTournamentMatches = [];
    miniTournamentRound = 0;
    
    $('round-setup-area').style.display = 'block';
    $('round-match-area').style.display = 'none';
    
    // âœ… ë­í‚¹íŒ/ëŒ€ì§„í‘œ ì˜ì—­ë„ ê¹¨ë—í•˜ê²Œ ë¹„ìš°ê³  ë‹¤ì‹œ ê·¸ë¦´ ì¤€ë¹„
    const rankTable = $('round-rank-table');
    const matchList = $('round-match-list');
    if(rankTable) rankTable.innerHTML = '';
    if(matchList) matchList.innerHTML = '';
    
    // â­ ì¹´ìš´íŠ¸ ë¦¬ì…‹ ì¶”ê°€
    const cntSpan = $('round-cnt');
    if(cntSpan) cntSpan.textContent = '0';

    renderRoundPlayerList();
    }); // gsConfirm end
  }

  function convertRoundToTournament() {
    const finishedMatches = roundMatches.filter(m => m.winner !== null);
    
    if(finishedMatches.length === 0) {
      gsAlert('ì™„ë£Œëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    // í˜„ì¬ê¹Œì§€ì˜ ê²½ê¸° ì €ì¥
    if(isPracticeMode !== 'practice') {
      saveRoundDataToLog(finishedMatches);
    }
    
    // ìˆœìœ„ ê³„ì‚°
    const standings = {};
    roundParticipants.forEach(p => {
      const key = roundMode === 'single' ? p : p.join('&');
      standings[key] = { name: p, wins: 0, losses: 0, matches: 0, winRate: 0 };
    });
    
    finishedMatches.forEach(m => {
      const homeKey = roundMode === 'single' ? m.home : m.home.join('&');
      const awayKey = roundMode === 'single' ? m.away : m.away.join('&');
      
      standings[homeKey].matches++;
      standings[awayKey].matches++;
      
      if(m.winner === 'home') {
        standings[homeKey].wins++;
        standings[awayKey].losses++;
      } else {
        standings[awayKey].wins++;
        standings[homeKey].losses++;
      }
    });
    
    Object.values(standings).forEach(s => {
      s.winRate = s.matches > 0 ? s.wins / s.matches : 0;
    });
    
    const sorted = Object.values(standings).sort((a, b) => {
      if(b.wins !== a.wins) return b.wins - a.wins;
      if(Math.abs(b.winRate - a.winRate) > 0.001) return b.winRate - a.winRate;
      if(a.losses !== b.losses) return a.losses - b.losses;
      return b.matches - a.matches;
    });
    
    const rankedParticipants = sorted.map(s => s.name);
    
    // â­ ëª¨ë‹¬ ì—´ê¸°
    openTournamentModal(rankedParticipants);
  }

  // ========================================
  // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
  // ========================================
  
  function openTournamentModal(rankedParticipants) {
    const modal = $('tournament-modal');
    const list = $('modal-participant-list');
    
    if(!modal || !list) {
      console.error('Modal elements not found');
      return;
    }
    
    // ì°¸ê°€ì ëª©ë¡ ë Œë”ë§
    let html = '';
    rankedParticipants.forEach((participant, idx) => {
      const rank = idx + 1;
      const displayText = roundMode === 'single' 
        ? displayName(participant) 
        : `${displayName(participant[0])} & ${displayName(participant[1])}`;
      
      // ê¸°ë³¸ ì„ íƒ: ìƒìœ„ 4ëª…/íŒ€
      const checked = idx < 4 ? 'checked' : '';
      const selectedClass = idx < 4 ? 'selected' : '';
      
      html += `
        <div class="modal-participant-item ${selectedClass}" onclick="toggleModalParticipant(${idx})">
          <input type="checkbox" class="modal-checkbox" id="modal-p-${idx}" ${checked} onclick="event.stopPropagation(); toggleModalParticipant(${idx})">
          <span class="modal-rank">${rank}ìœ„</span>
          <span>${displayText}</span>
        </div>
      `;
    });
    
    list.innerHTML = html;
    
    // ì„ íƒ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    updateModalCount();
    
    // ëª¨ë‹¬ í‘œì‹œ
    modal.classList.add('active');
  }
  
  function toggleModalParticipant(idx) {
    const checkbox = $(`modal-p-${idx}`);
    if(!checkbox) return;
    
    const item = checkbox.closest('.modal-participant-item');
    if(!item) return;
    
    checkbox.checked = !checkbox.checked;
    
    if(checkbox.checked) {
      item.classList.add('selected');
    } else {
      item.classList.remove('selected');
    }
    
    updateModalCount();
  }
  
  function updateModalCount() {
    const checkboxes = document.querySelectorAll('#modal-participant-list .modal-checkbox');
    const count = Array.from(checkboxes).filter(cb => cb.checked).length;
    const countSpan = $('modal-selected-count');
    if(countSpan) countSpan.textContent = count;
  }
  
  function closeTournamentModal() {
    const modal = $('tournament-modal');
    if(modal) modal.classList.remove('active');
  }
  
  function startTournamentFromModal() {
    // ì„ íƒëœ ì°¸ê°€ì ìˆ˜ì§‘
    const checkboxes = document.querySelectorAll('#modal-participant-list .modal-checkbox:checked');
    
    if(checkboxes.length < 2) {
      gsAlert('ìµœì†Œ 2ëª…/íŒ€ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
      return;
    }
    
    const selectedIndices = Array.from(checkboxes).map(cb => {
      return parseInt(cb.id.replace('modal-p-', ''));
    }).sort((a, b) => a - b);
    
    // ìˆœìœ„ ê³„ì‚° (ë‹¤ì‹œ)
    const finishedMatches = roundMatches.filter(m => m.winner !== null);
    const standings = {};
    roundParticipants.forEach(p => {
      const key = roundMode === 'single' ? p : p.join('&');
      standings[key] = { name: p, wins: 0, losses: 0, matches: 0, winRate: 0 };
    });
    
    finishedMatches.forEach(m => {
      const homeKey = roundMode === 'single' ? m.home : m.home.join('&');
      const awayKey = roundMode === 'single' ? m.away : m.away.join('&');
      
      standings[homeKey].matches++;
      standings[awayKey].matches++;
      
      if(m.winner === 'home') {
        standings[homeKey].wins++;
        standings[awayKey].losses++;
      } else {
        standings[awayKey].wins++;
        standings[homeKey].losses++;
      }
    });
    
    Object.values(standings).forEach(s => {
      s.winRate = s.matches > 0 ? s.wins / s.matches : 0;
    });
    
    const sorted = Object.values(standings).sort((a, b) => {
      if(b.wins !== a.wins) return b.wins - a.wins;
      if(Math.abs(b.winRate - a.winRate) > 0.001) return b.winRate - a.winRate;
      if(a.losses !== b.losses) return a.losses - b.losses;
      return b.matches - a.matches;
    });
    
    const rankedParticipants = sorted.map(s => s.name);
    
    // ì„ íƒëœ ì¸ë±ìŠ¤ë¡œ ì°¸ê°€ì í•„í„°ë§
    const selectedParticipants = selectedIndices.map(i => rankedParticipants[i]);
    
    // ëª¨ë‹¬ ë‹«ê¸°
    closeTournamentModal();
    
    // DOM ìš”ì†Œ í™•ì¸
    const setupArea = $('round-setup-area');
    const matchArea = $('round-match-area');
    const matchList = $('round-match-list');
    const rankTable = $('round-rank-table');
    
    if(!matchArea || !matchList) {
      gsAlert('í† ë„ˆë¨¼íŠ¸ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    // setup-area ìˆ¨ê¸°ê¸°
    if(setupArea) setupArea.style.display = 'none';
    
    // match-area ë³´ì´ê¸°
    matchArea.style.display = 'block';
    
    // ë­í‚¹íŒ ê³„ì† í‘œì‹œ
    if(rankTable) {
      const rankTitle = rankTable.previousElementSibling;
      if(rankTitle?.classList?.contains('tour-section-title')) {
        rankTitle.style.display = 'block';
      }
      rankTable.style.display = 'block';
    }
    try{ if(typeof updateRoundRanking==='function') updateRoundRanking(); }catch(e){ console.warn('[round] updateRoundRanking failed:', e); }
    
    // match-list ì´ˆê¸°í™”
    matchList.innerHTML = '';
    
    // í† ë„ˆë¨¼íŠ¸ ì‹œì‘
    setTimeout(() => startRoundMiniTournament(selectedParticipants), 100);
  }

  // ë¼ìš´ë“œ ë°ì´í„° ì €ì¥ í—¬í¼ í•¨ìˆ˜
  function saveRoundDataToLog(finishedMatches) {
    finishedMatches.forEach(m => {
      const winner = m.winner === 'home' ? m.home : m.away;
      const loser = m.winner === 'home' ? m.away : m.home;
      
      const log = {
        date: new Date().toISOString().split('T')[0],
        type: roundMode,
        winner: roundMode === 'single' ? [winner] : winner,
        loser: roundMode === 'single' ? [loser] : loser
      };
      
      matchLog.push(log);
      
      // ì ìˆ˜ ë°˜ì˜
      if(roundMode === 'single') {
        const wp = players.find(p => p.name === winner);
        const lp = players.find(p => p.name === loser);
        
        if(wp) {
          wp.sWins = (wp.sWins || 0) + 1;
          wp.sScore = (wp.sScore || 0) + 4;
        }
        if(lp) {
          lp.sLosses = (lp.sLosses || 0) + 1;
          lp.sScore = (lp.sScore || 0) + 0.5;
        }
      } else {
        winner.forEach(name => {
          const p = players.find(pl => pl.name === name);
          if(p) {
            p.dWins = (p.dWins || 0) + 1;
            p.dScore = (p.dScore || 0) + 3;
          }
        });
        loser.forEach(name => {
          const p = players.find(pl => pl.name === name);
          if(p) {
            p.dLosses = (p.dLosses || 0) + 1;
            p.dScore = (p.dScore || 0) + 0.3;
          }
        });
      }
    });
    
    computeAll();
    sync();
  }

  // ë¯¸ë‹ˆ í† ë„ˆë¨¼íŠ¸ ìƒíƒœ
  var miniTournamentMatches = [];
  var miniTournamentRound = 0;
  
  function startRoundMiniTournament(rankedParticipants) {
    if(!rankedParticipants || rankedParticipants.length === 0) {
      gsAlert('í† ë„ˆë¨¼íŠ¸ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì°¸ê°€ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    const n = rankedParticipants.length;
    
    // 2ì˜ ê±°ë“­ì œê³± ê³„ì‚°
    let bracketSize = 2;
    while(bracketSize < n) bracketSize *= 2;
    
    // ë¶€ì „ìŠ¹ ìˆ˜ ê³„ì‚°
    const byeCount = bracketSize - n;
    
    // ì²« ë¼ìš´ë“œ ë§¤ì¹˜ ìƒì„± (ë¶€ì „ìŠ¹ ì‹œìŠ¤í…œ ì ìš©)
    miniTournamentMatches = [];
    let matchCount = 0;
    
    for(let i = 0; i < bracketSize / 2; i++) {
      const highIdx = i;
      const lowIdx = bracketSize - 1 - i;
      
      const high = highIdx < n ? rankedParticipants[highIdx] : null;
      const low = lowIdx < n ? rankedParticipants[lowIdx] : null;
      
      // ë‘˜ ë‹¤ ìˆìœ¼ë©´ ë§¤ì¹˜ ìƒì„±
      if(high !== null && low !== null) {
        matchCount++;
        miniTournamentMatches.push({
          id: `T-R1-M${matchCount}`,
          round: 1,
          home: high,
          away: low,
          winner: null
        });
      }
      // í•œ ëª…ë§Œ ìˆìœ¼ë©´ ë¶€ì „ìŠ¹ (ìë™ ìŠ¹ë¦¬)
      else if(high !== null && low === null) {
        matchCount++;
        miniTournamentMatches.push({
          id: `T-R1-M${matchCount}`,
          round: 1,
          home: high,
          away: null,  // ë¶€ì „ìŠ¹ í‘œì‹œ
          winner: 'home',  // ìë™ ìŠ¹ë¦¬
          isBye: true  // ë¶€ì „ìŠ¹ í”Œë˜ê·¸
        });
        
        // â­ ë¶€ì „ìŠ¹ ì‹œ ì¦‰ì‹œ +1ì  ë¶€ì—¬ (ìƒìœ„ ë­ì»¤ íŠ¹ì „)
        if(isPracticeMode !== 'practice') {
          if(roundMode === 'single') {
            const p = players.find(pl => pl.name === high);
            if(p) p.sScore = (p.sScore || 0) + 1;
          } else {
            high.forEach(name => {
              const p = players.find(pl => pl.name === name);
              if(p) p.dScore = (p.dScore || 0) + 1;
            });
          }
          // ì¦‰ì‹œ ì €ì¥ ë° ì¬ê³„ì‚°
          computeAll();
          sync();
        }
      }
    }
    
    miniTournamentRound = 1;
    renderMiniTournament();
    
    // ë­í‚¹ ì—…ë°ì´íŠ¸ (ë¶€ì „ìŠ¹ ì ìˆ˜ ë°˜ì˜)
    try{ if(typeof updateRoundRanking==='function') updateRoundRanking(); }catch(e){ console.warn('[round] updateRoundRanking failed:', e); }
    
    // ë¶€ì „ìŠ¹ ì•ˆë‚´ ë©”ì‹œì§€
    if(byeCount > 0) {
      setTimeout(() => {
        gsAlert(`ğŸ’¡ ${byeCount}ëª…/íŒ€ì´ ë¶€ì „ìŠ¹ìœ¼ë¡œ ë‹¤ìŒ ë¼ìš´ë“œì— ìë™ ì§„ì¶œí•©ë‹ˆë‹¤.\nìƒìœ„ ë­ì»¤ì—ê²Œ ë¶€ì „ìŠ¹ì´ ë°°ì •ë©ë‹ˆë‹¤.`);
      }, 500);
    }
  }

  function renderMiniTournament() {
    const list = $('round-match-list');
    if(!list) return;
    
    const currentRound = miniTournamentMatches.filter(m => m.round === miniTournamentRound);
    
    if(currentRound.length === 0) {
      list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-gray);">í‘œì‹œí•  ë§¤ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    
    let html = `<div style="text-align:center; margin-bottom:20px; padding:15px; background:var(--wimbledon-sage); color:white; border-radius:12px; font-size:16px; font-weight:bold;">ğŸ† ë¼ìš´ë“œ ë¯¸ë‹ˆ í† ë„ˆë¨¼íŠ¸ - Round ${miniTournamentRound}</div>`;
    
    currentRound.forEach(m => {
      const isFinished = m.winner !== null;
      const isBye = m.isBye || false;
      
      // ë¶€ì „ìŠ¹ ì²˜ë¦¬
      if(isBye) {
        const homeDisplay = roundMode === 'single' ? displayName(m.home) : `${displayName(m.home[0])} & ${displayName(m.home[1])}`;
        html += `
          <div class="team-box" style="margin-bottom:10px; padding:12px; opacity:0.7; background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);">
            <div style="font-size:11px; color:var(--text-gray); margin-bottom:8px;">${m.id} - ë¶€ì „ìŠ¹</div>
            <div style="text-align:center; padding:10px;">
              <span style="color:var(--wimbledon-sage); font-weight:700; font-size:15px;">
                âœ“ ${homeDisplay}
              </span>
              <div style="font-size:12px; color:var(--text-gray); margin-top:5px;">ë‹¤ìŒ ë¼ìš´ë“œ ìë™ ì§„ì¶œ</div>
            </div>
          </div>
        `;
        return;
      }
      
      // ì¼ë°˜ ë§¤ì¹˜
      const homeDisplay = roundMode === 'single' ? displayName(m.home) : `${displayName(m.home[0])} & ${displayName(m.home[1])}`;
      const awayDisplay = roundMode === 'single' ? displayName(m.away) : `${displayName(m.away[0])} & ${displayName(m.away[1])}`;
      
      html += `
        <div class="team-box" style="margin-bottom:10px; padding:12px; ${isFinished ? 'opacity:0.5;' : ''}">
          <div style="font-size:11px; color:var(--text-gray); margin-bottom:8px;">${m.id}</div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button onclick="setMiniTournamentWinner('${m.id}', 'home')" 
              class="opt-btn" 
              style="flex:1; padding:10px; ${m.winner === 'home' ? 'background:var(--wimbledon-sage); opacity:1;' : 'opacity:0.7;'}">
              ${homeDisplay}
            </button>
            <div style="font-size:14px; color:var(--text-gray);">vs</div>
            <button onclick="setMiniTournamentWinner('${m.id}', 'away')" 
              class="opt-btn" 
              style="flex:1; padding:10px; ${m.winner === 'away' ? 'background:var(--wimbledon-sage); opacity:1;' : 'opacity:0.7;'}">
              ${awayDisplay}
            </button>
          </div>
        </div>
      `;
    });
    
    list.innerHTML = html;
  }

  function setMiniTournamentWinner(matchId, side) {
    const match = miniTournamentMatches.find(m => m.id === matchId);
    if(!match || match.winner !== null) return;
    
    match.winner = side;
    const winner = side === 'home' ? match.home : match.away;
    
    // ì´ë²¤íŠ¸ì„± ì ìˆ˜ - ìŠ¹ë¦¬ë‹¹ +1ì ë§Œ (ê¹€ì‘ ê°€ì‚°ì  ë£°)
    if(isPracticeMode !== 'practice') {
      if(roundMode === 'single') {
        const p = players.find(pl => pl.name === winner);
        if(p) p.sScore = (p.sScore || 0) + 1;
      } else {
        winner.forEach(name => {
          const p = players.find(pl => pl.name === name);
          if(p) p.dScore = (p.dScore || 0) + 1;
        });
      }
    }
    
    
    // âœ… ì ìˆ˜ ë°˜ì˜ ì¦‰ì‹œ ìƒë‹¨ ë­í‚¹íŒ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
    try{ if(typeof updateRoundRanking==='function') updateRoundRanking(); }catch(e){ console.warn('[round] updateRoundRanking failed:', e); }
    // í˜„ì¬ ë¼ìš´ë“œì˜ ëª¨ë“  ë§¤ì¹˜ê°€ ëë‚¬ëŠ”ì§€ í™•ì¸
    const currentRound = miniTournamentMatches.filter(m => m.round === miniTournamentRound);
    const allFinished = currentRound.every(m => m.winner !== null);
    
    if(allFinished) {
      // ìŠ¹ìë“¤ë¡œ ë‹¤ìŒ ë¼ìš´ë“œ ìƒì„±
      const winners = currentRound.map(m => m.winner === 'home' ? m.home : m.away);
      
      if(winners.length === 1) {
        // ìš°ìŠ¹ì ê²°ì •
        const champion = winners[0];
        const champDisplay = roundMode === 'single' ? displayName(champion) : `${displayName(champion[0])} & ${displayName(champion[1])}`;
        
        if(isPracticeMode !== 'practice') {
          computeAll();
          sync();
        }
        
        gsAlert(`ğŸ† ìš°ìŠ¹: ${champDisplay}!\n\në¯¸ë‹ˆ í† ë„ˆë¨¼íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        return;
      }
      
      // ë‹¤ìŒ ë¼ìš´ë“œ ìƒì„±
      miniTournamentRound++;
      const nextMatches = [];
      for(let i = 0; i < winners.length; i += 2) {
        nextMatches.push({
          id: `T-R${miniTournamentRound}-M${(i/2) + 1}`,
          round: miniTournamentRound,
          home: winners[i],
          away: winners[i + 1],
          winner: null
        });
      }
      miniTournamentMatches.push(...nextMatches);
    }
    
    renderMiniTournament();
  }


</script>
<nav class="bottom-nav">
  <div class="nav-item active" onclick="switchView('home', this)"><span class="material-symbols-outlined nav-icon">home</span>í™ˆ</div>
  <div class="nav-item" onclick="switchView('game', this)"><span class="material-symbols-outlined nav-icon">sports_tennis</span>ê²Œì„</div>
  <div class="nav-item" onclick="switchView('tennis', this)"><span class="material-symbols-outlined nav-icon">emoji_events</span>ë­í‚¹</div>
  <div class="nav-item" onclick="switchView('stats', this)"><span class="material-symbols-outlined nav-icon">monitoring</span>í†µê³„</div>
  <div class="nav-item" onclick="switchView('admin', this)"><span class="material-symbols-outlined nav-icon">settings</span>ìš´ì˜</div>
</nav>

<!-- ========================================
     ë¯¸ë‹ˆ í† ë„ˆë¨¼íŠ¸ ì°¸ê°€ì ì„ íƒ ëª¨ë‹¬
     ======================================== -->
<div id="tournament-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <span class="material-symbols-outlined">emoji_events</span>
      ë¯¸ë‹ˆ í† ë„ˆë¨¼íŠ¸ ì°¸ê°€ì ì„ íƒ
    </div>
    <div class="modal-body">
      <div class="modal-info">
        <strong>ğŸ’¡ ì„ íƒ ê°€ì´ë“œ</strong><br>
        â€¢ ì›í•˜ëŠ” ì¸ì›ì„ ììœ ë¡­ê²Œ ì„ íƒí•˜ì„¸ìš”<br>
        â€¢ 2, 4, 8ëª…: ì •ê·œ í† ë„ˆë¨¼íŠ¸<br>
        â€¢ ê·¸ ì™¸ ì¸ì›: ìƒìœ„ ë­ì»¤ ë¶€ì „ìŠ¹ ìë™ ë°°ì •
      </div>
      <div id="modal-participant-list" class="modal-participant-list"></div>
      <div style="margin-top: 15px; text-align: center; color: var(--aussie-blue); font-weight: 400;">
        ì„ íƒëœ ì¸ì›: <strong><span id="modal-selected-count">0</span>ëª…/íŒ€</strong>
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" onclick="closeTournamentModal()">
        <span class="material-symbols-outlined btn-ico">close</span>ì·¨ì†Œ
      </button>
      <button class="modal-btn modal-btn-primary" onclick="startTournamentFromModal()">
        <span class="material-symbols-outlined btn-ico">play_arrow</span>ì‹œì‘í•˜ê¸°
      </button>
    </div>
  </div>
</div>

</body>
</html>